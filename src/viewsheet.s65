; Feature/variant flags/hacks/etc.
;
; If there's any obvous name for what these toggles might do, it gets
; a name. Otherwise, it's just named after the first version I
; encountered that happened to need this.

                .weak

; if true, build B1.0 variant 2
b10_var2=false

; if true, replace sideways RAM protection thingy with 3 x NOPs
patch_out_sideways_ram_protection=false

; if true, build B1.01
B101=false

; if true, handle 8-bit input (presumably related to the changes done
; for MOS 3.50/MOS 5.11/PC 128 S). Requires 65c02.
;
; (I guessed at some of the changes)
handle_8_bit_input=B101

; if true, include basic sideways RAM protection: a little routine
; that tries to modify some a bit of the code (and not in a good way)
; unless running in the second processor
include_sideways_ram_protection=!B101

; if true, use CMOS instructions here and there, not obviously related
; to any other specific feature.
cmos_instructions=B101
                
                .endweak

;-------------------------------------------------------------------------

L0000=$0
L0002=$2
L0003=$3
L0004=$4
L0005=$5
L0006=$6
L0008=$8
L000A=$a
L000B=$b
L000C=$c
L000D=$d
L000E=$e
L000F=$f
L0011=$11
L0012=$12
OSWHM=$13
L0015=$15
L0016=$16
L0017=$17
L0018=$18
L0019=$19
L001A=$1a
L001B=$1b
L001C=$1c
L001D=$1d
L001E=$1e
L001F=$1f
HIMEM=$21
L0023=$23
L0024=$24
L0025=$25
L0026=$26
L0027=$27
L0028=$28
S_value=$29
; stack pointer value
L002A=$2a
L002B=$2b
L002C=$2c
L002D=$2d
L002E=$2e
L002F=$2f
L0030=$30
fwa_sign=$31
fwa_overflow=$32
fwa_exponent=$33
fwa_mantissa_1=$34
fwa_mantissa_2=$35
fwa_mantissa_3=$36
fwa_mantissa_4=$37
fwa_rounding=$38
fwb_sign=$39
fwb_overflow=$3a
fwb_exponent=$3b
fwb_mantissa_1=$3c
fwb_mantissa_2=$3d
fwb_mantissa_3=$3e
fwb_mantissa_4=$3f
fwb_rounding=$40
; L0041, L0043 and L0044 are also used as temporary FP workspace
L0041=$41
L0043=$43
L0044=$44
L0046=$46
L0047=$47
L0048=$48
L0049=$49
L004A=$4a
L004B=$4b
L004C=$4c
L004D=$4d
L004E=$4e
L004F=$4f
L0050=$50
L0051=$51
num_columns=$52
num_rows=$53
; (num displays rows minus 3)
L0054=$54
L0055=$55
L0056=$56
L0057=$57
L0058=$58
L0059=$59
L005A=$5a
L005B=$5b
is_second_processor=$5c
; 0 if host, non-0 if parasite
L005D=$5d
L005E=$5e
L005F=$5f
L0060=$60
L0061=$61
L0062=$62
L0063=$63
L0064=$64
L0065=$65
L0066=$66; 0
                                ; 1
                                ; 2
                                ; 3
L006A=$6a
L006B=$6b
L006C=$6c
L006D=$6d
L006E=$6e
L0070=$70
L0071=$71
L0072=$72
L0073=$73
entry_A=$ef
; OSBYTE/OSWORD A value
entry_X=$f0
; OSBYTE/OSWORD X value
entry_Y=$f1
; OSBYTE/OSWORD Y value
escape_flag=$ff
BRKV=$202
L0400=$400
L0500=$500
L0501=$501
L0502=$502
L0503=$503
L0504=$504
L0505=$505
L0506=$506
L050A=$50a
L050B=$50b
L050C=$50c
L050D=$50d
L050E=$50e
L050F=$50f
L0510=$510
L0511=$511
L0600=$600
L0601=$601
L0602=$602
L0603=$603
L0628=$628
L0629=$629
L0683=$683
fp_slot_0=$684
fp_slot_1=$689
fp_slot_2=$68e
fp_slot_3=$693
L0698=$698
L0699=$699
L069A=$69a
L069C=$69c
L069D=$69d
L06A5=$6a5
L06B2=$6b2
L06BF=$6bf
screen_mode=$6c0
L06C1=$6c1
L06C2=$6c2
L06C3=$6c3
L06C4=$6c4
L06C5=$6c5
L06C6=$6c6
L06C7=$6c7
L06C8=$6c8
L06C9=$6c9
L06CA=$6ca
L06CB=$6cb
L06CC=$6cc
L06CD=$6cd
L073A=$73a
L079E=$79e
L07AB=$7ab
L07AC=$7ac
L07EC=$7ec
L07ED=$7ed
L07EE=$7ee
L07EF=$7ef

*=$8000
;-------------------------------------------------------------------------

language_entry:
                jmp L80C7

;-------------------------------------------------------------------------

service_entry:
                jmp L802B

;-------------------------------------------------------------------------

                .byte %11000010 ; service entry+language entry
                .char copyright - language_entry
                .if B101
                .byte 3
                .else
                .byte 2         ; version number
                .endif
asc_8009:       .text "ViewSheet"
                .byte 0
                .if B101
                .text "B1.01"
                .else
                .text "B1.0"
                .endif
copyright:      .byte 0
                .if B101
                .text "(C)1984Acornsoft"
                .else
                .text "(C) 1984 Acornsoft"
                .endif
                .byte 0

;-------------------------------------------------------------------------

                .if b10_var2
                .byte $50
                .endif
L802B:
                pha
                txa
                pha
                tya
                pha
                tsx
                lda $103,x      ; get original A
                cmp #9
                beq svc_help
                cmp #7
                beq svc_osbyte
                cmp #2
                beq svc_private_workspace
                cmp #4
                bne svc_done
; handle A=4 unrecognised command
                ldx #$FF
                dey

L8047:
                inx
                iny
                lda aSheet,x    ; "SHEET\xFF"
                bmi L8064
                lda ($F2),y
                and #$DF
                cmp aSheet,x    ; "SHEET\xFF"
                beq L8047
                cmp #$E
                bne svc_done

L805B:
                pla
                pla
                tax
                pla
                lda #$8E        ; OSBYTE enter language ROM (AUG p166)
                jmp OSBYTE

;-------------------------------------------------------------------------

L8064:
                lda ($F2),y
                cmp #$21
                bcc L805B    ; taken if char<=0x20
                bcs svc_done

svc_help:
                lda ($F2),y
                cmp #13
                bne svc_done
                jsr OSNEWL
                ldx #1
                jsr LAD28
                jsr OSNEWL

svc_done:
                jmp ply_plx_pla_rts

;-------------------------------------------------------------------------

svc_private_workspace:
                tsx
                lda $102,x
                tax
                lda #0
                sta $DF0,x
                beq svc_done

svc_osbyte:
                lda entry_A     ; OSBYTE/OSWORD A value
                cmp #$A3
                bne svc_done    ; taken if A!=$A3
; handle OSBYTE $A3
; see https://beebwiki.mdfs.net/OSBYTE_%26A3
                lda entry_X     ; OSBYTE/OSWORD X value
                cmp #$FF
                bne svc_done    ; taken if X!=$FF
; handle OSBYTE A=$A3 X=$FF
                tsx
                lda $102,x
                ldy entry_Y     ; OSBYTE/OSWORD Y value
                cpy #2
                bne svc_done    ; taken if Y!=2
; handle OSBYTE A=$A3 X=$FF Y=$02
; see https://beebwiki.mdfs.net/OSBYTE_%26A3#X.3D.26FF_.28255.29_Acornsoft_View_family_workspace_flag
                tay
                lda $DF0,y
                sta $101,x
                lda #0
                sta $103,x
                beq svc_done

L80B0:
                inc L005E

;-------------------------------------------------------------------------

; jump to next CR/space/0
; entry: (L0066) = string address
;        ?L005E = string offset
; exit: BEQ if CR/space/0

skip_chars:

                ldy L005E
                lda (L0066),y
                beq rts80C0
                cmp #13
                beq rts80C0
                cmp #' '
                beq L80B0

rts80C0:
                rts

;-------------------------------------------------------------------------

aSheet:         .text "SHEET"
                .byte $FF

;-------------------------------------------------------------------------

L80C7:
                cmp #1
                bne rts80C0
                cli
                sta L0056
                lda #<brk_handler
                sta BRKV
                lda #>brk_handler
                sta BRKV+1
                jsr LAE34
                jsr LAE73
                lda #$83        ; OSBYTE read OSHWN
                jsr OSBYTE
                cpx OSWHM
                bne L80F0
                cpy OSWHM+1
                bne L80F0
                jsr LADD5
                beq L80F3

L80F0:
                jsr L8580

L80F3:
                lda #2
                sta L005B
                ldx #0
                txa

L80FA:
                stx L0060
                ldy L07EC,x
                beq L8104
                jsr OSFIND

L8104:
                lda #0
                ldx L0060
                sta L07EC,x
                inx
                inx
                inx
                inx
                cpx #20
                bne L80FA
                ror L005B
                jsr clear_screen
                lda #4          ; OSBYTE define cursor editing keys
                ldx #0          ; cursor keys have editing effect
                jsr OSBYTE
                lda #$E1        ; OSBYTE control interpretation of characters $80-$8f (function keys 0-9, cursor keys)
                ldx #1
                ldy #0
                jsr OSBYTE
                ldx #0
                jsr L973B
                ldx #0
                jsr LAD28
                jsr OSNEWL
                jsr LADB8    ; if no sheet in memory, print "No sheet" and return with C=1??
                bcs L8153
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

                .byte $D
                .text "Bytes free "
                .byte 0

;-------------------------------------------------------------------------

                jsr LA2ED
                jsr LAED2
                jsr OSNEWL

L8153:
                jsr LADFB
                jsr print_following_string; print 0-terminated string following call

;-------------------------------------------------------------------------

                .text "Screen mode "
                .byte 0

;-------------------------------------------------------------------------

                lda screen_mode
                ora #'0'
                jsr OSWRCH
                jsr OSNEWL
                lda L06A5
                beq command_loop
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

                .text "Printer "
                .byte 0

;-------------------------------------------------------------------------

                ldx #0

L8184:
                lda L06A5,x
                jsr OSASCI
                cmp #13
                beq command_loop
                inx
                bne L8184

command_loop:
                jsr OSNEWL

command_loop_2:
                ldx #$FF
                txs
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

                .text "=>"
                .byte 0

;-------------------------------------------------------------------------

                lda #<OSASCI
                sta L000F
                lda #>OSASCI
                sta L000F+1
                jsr L9421    ; set up OSWORD 0 buffer address - $500
                ldx #$FF
                stx L0066+2   ; OSWORD 0 max input length
                .if handle_8_bit_input
                stx L006A
                .endif
                ldx #$20        ; OSWORD 0 min char
                stx L0066+3
                .if !handle_8_bit_input
                ldx #$7E        ; OSWORD 0 max char
                stx L006A
                .endif
                ldx #$66
                lda #0          ; OSWORD get input
                sta L005D
                sta L005E
                tay             ; Y=0
                jsr OSWORD
                bcc L81CD
                jsr acknowledge_escape
                jsr LADB8    ; if no sheet in memory, print "No sheet" and return with C=1??
                bcs command_loop_2
                jmp L86A8

;-------------------------------------------------------------------------

L81CD:
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq command_loop_2
                sty L005E
                cmp #'*'
                beq do_star_command
                jsr LACD9
                sty L0060
                bcs L81E3
                cpy #14
                bcc L81EF

L81E3:
                jsr print_following_string; print 0-terminated string following call

;-------------------------------------------------------------------------

                .text "Command?"
                .byte $FF

;-------------------------------------------------------------------------

L81EF:
                ror a
                bcc L81F7
                jsr LADCF
                bcs command_loop_2

L81F7:
                lda L0060
                ldy #2
                jsr L8685    ; Look up address in table and jump to that routine.
                                ; Entry: Y=table value (0/2/4/6)
                                ;        A=index in table
                jmp L80F3

;-------------------------------------------------------------------------

do_star_command:
                ldx #<L0500
                ldy #>L0500
                jsr OSCLI
                jmp command_loop_2

;-------------------------------------------------------------------------

L820B:
                jsr LAF4F
                bcs L8258
                jsr L821B
                bcc L823E
                jsr LAE26
                jmp LAE73

;-------------------------------------------------------------------------

L821B:
                sta L0064
                lda is_second_processor; 0 if host, non-0 if parasite
                bne L823A
                lda #$85        ; OSBYTE read bottom of display RAM address for specific mode
                ldx L0064     ; mode of interest
                jsr OSBYTE
                cpy L001F+1
                bcc L8234    ; taken if new HIMEM<value
                bne L823B    ; taken if new HIMEM>value
; >(new HIMEM)==>value
                cpx L001F
                beq L8234    ; taken if new HIMEM==value
                bcs L823B    ; taken if new HIMEM>value
; new HIMEM<=value

L8234:
                jsr LADD5
                clc
                beq L823B

L823A:
                sec

L823B:
                lda L0064
                rts

;-------------------------------------------------------------------------

L823E:
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aNotEnoughMemory:.text "Not enough memory"
                .byte $FF

;-------------------------------------------------------------------------

L8253:
                jsr L8263
                bne rts8287

L8258:
                jsr print_following_string; print 0-terminated string following call

;-------------------------------------------------------------------------

                .text "Syntax?"
                .byte $FF

;-------------------------------------------------------------------------

L8263:

                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq rts8287
                ldx #0

L826A:
                lda L0500,y
                cmp #13
                beq L8280
                iny
                cmp #' '
                beq L8280
                sta L0698,x
                inx
                cpx #13
                bne L826A
                beq L8258

L8280:
                lda #13
                sta L0698,x
                sty L005E

rts8287:
                rts

;-------------------------------------------------------------------------

L8288:
                ldx #$4D
                bne L828E    ; always taken

L828C:
                ldx #$4E

L828E:
                stx L0060
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L82AA
                sty L005E
                jsr LACD9
                bcs L8258
                lda #0
                cpy #14
                bcc L8258
                bne L82A6
                lda #$FF

L82A6:
                ldx L0060
                sta L0000,x

L82AA:
                cpx #$4D
                bne L82BE
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aHeadings:      .text "Headings "
                .byte 0

;-------------------------------------------------------------------------

                jmp L82CD

;-------------------------------------------------------------------------

L82BE:
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aProtection:    .text "Protection "
                .byte 0

;-------------------------------------------------------------------------

L82CD:
                ldx L0060
                lda 0,x
                beq L82DA
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aOff:           .text "off"
                .byte $FF

;-------------------------------------------------------------------------

L82DA:
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aOn:            .text "on"
                .byte $FF

;-------------------------------------------------------------------------

L82E0:
                lda #0
                sta L06A5
                rts

;-------------------------------------------------------------------------

L82E6:
                jsr L8263
                beq L82E0
                jsr L835D
                bcc L82F8
                dey
                bmi L82F8
                bne L8351
                tax
                bne L8351

L82F8:
                ldx #0
                ldy #4
                jsr L8467
                ldx #0

L8301:
                lda L0698,x
                sta L06A5,x
                inx
                cmp #13
                bne L8301
                rts

;-------------------------------------------------------------------------

L830D:
                jsr L8253
                jsr L835D
                bcc L831D
                cpy #1
                bne L8351
                cmp #','
                bne L8351

L831D:
                lda screen_mode
                sta L0063
                ldx #$C0
                ldy #6
                jsr L8467
                lda screen_mode
                cmp L0063
                beq L8343
                jsr L821B
                bcs L8340
                lda L0063
                sta screen_mode
                jsr LAE73

L833D:
                jmp L823E

;-------------------------------------------------------------------------

L8340:
                jsr LAE26

;-------------------------------------------------------------------------

L8343:
                ldx L06C1
                lda L06C2,x
                sta L000B
                lda L06C3,x
                sta L000C
                rts

;-------------------------------------------------------------------------

L8351:
                jsr print_following_string; print 0-terminated string following call

;-------------------------------------------------------------------------

aBadFile:       .text "Bad file"
                .byte $FF

;-------------------------------------------------------------------------

L835D:

                jsr is_ROM_FS   ; Exit: Z=1 if ROM FS
                bcc rts8379
                lda #5
                jsr L8477
                tay
                beq L837A
                lda L050C
                ora L050D
                bne L8351
                lda L050A
                ldy L050B
                sec

rts8379:
                rts

;-------------------------------------------------------------------------

L837A:
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aFileNotFound:  .text "File not found"
                .byte $FF

;-------------------------------------------------------------------------

L838C:
                jsr L8253
                jsr L8541
                jsr L835D
                bcc L83B6
                cpy #1
                bcc L8351
                bne L83A3
                cmp #','
                bcc L8351
                beq L8351

L83A3:
                clc
                adc L006A
                tax
                tya
                adc L006B
                bcs L833D
                cmp HIMEM+1
                bcc L83B6
                bne L833D
                cpx HIMEM
                bcs L833D

L83B6:
                ldx L006A
                ldy L006B
                jsr L8467
                ldx #$17
                ldy #0

L83C1:
                lda (L006E),y
                iny
                clc
                adc L0015
                sta 0,x
                lda (L006E),y
                iny
                adc L0016
                sta 1,x
                inx
                inx
                cpx #$21
                bne L83C1
                lda screen_mode
                sta L0064
                ldx #0
                jsr L8513
                jsr L8343
                lda L0064
                cmp screen_mode
                beq L83F0
                sta screen_mode
                jsr LAE73

L83F0:
                ldy #0
                lda #$FF
                sta (L001F),y
                bne L8403

L83F8:
                jsr L8263
                php
                lda #0
                sta L0051
                plp
                beq rts8412

L8403:
                ldx #0

L8405:
                lda L0698,x
                sta L06B2,x
                inx
                cmp #13
                bne L8405
                sta L0051

rts8412:
                rts

;-------------------------------------------------------------------------

L8413:
                jsr L8263
                bne L8429
                lda L0051
                beq L849B
                ldx #0

L841E:
                lda L06B2,x
                sta L0698,x
                inx
                cmp #13
                bne L841E

L8429:
                jsr L8541
                ldx #$17
                ldy #0

L8430:
                lda 0,x
                sec
                sbc L0015
                sta (L006E),y
                iny
                lda 1,x
                sbc L0016
                sta (L006E),y
                iny
                inx
                inx
                cpx #$21
                bne L8430
                jsr L8513
                lda L006A
                sta L050A
                lda L006B
                sta L050B
                ldx L001F
                ldy L001F+1

L8456:
                stx L050E
                sty L050F
                jsr L855F
                lda #0
                jsr L8477
                jmp command_loop_2

;-------------------------------------------------------------------------

L8467:
                stx L0502
                sty L0503
                jsr L855F
                lda #0
                sta L0506
                lda #$FF

;-------------------------------------------------------------------------

L8477:
                ldx #<L0698
                stx L0500
                ldx #>L0698
                stx L0501
                ldx #<L0500
                ldy #>L0500
                jmp OSFILE

;-------------------------------------------------------------------------

L8488:
                jsr L8253
                lda #<screen_mode
                sta L050A
                lda #>screen_mode
                sta L050B
                ldx #<L07EC
                ldy #>L07EC
                bne L8456    ; always taken

L849B:
                jmp L8258

;-------------------------------------------------------------------------

L849E:

                jsr LAF4F
                bcs L849B
                beq L849B
                sty L005E
                rts

;-------------------------------------------------------------------------

L84A8:
                jsr L849E
                sta L0066+2
                jsr L849E
                sta L006A
                jsr L849E
                sta L006B
                lda L006A
                ldy L006B
                jsr LAF1D
                cpy #$2A
                bcs L849B
                lda L0066+2
                jsr LA961
                lda #$80        ; OSFIND open for output only
                ldx #<L079E
                ldy #>L079E
                jsr OSFIND
                sta L0060
                ldx #5
                lda #0
                sta L0063

L84D8:
                sta L0698,x
                dex
                bpl L84D8
                lda L006A
                ldy L006B
                jsr LA88F
                lda #$40
                sta L005B
                ldy L0060
                asl a
                jsr LA938
                lda #$AA
                sta L0698
                lda L006A
                sta L0699
                lda L006B
                sta L069A

L84FE:
                jsr LA2F9
                lda #$80
                jsr LA938

close_file:
                sec
                ror L005B
                lda #0          ; OSFIND close file
                ldy L0060
                jsr OSFIND
                jmp command_loop_2

;-------------------------------------------------------------------------

L8513:
                lda #<L06BF
                sta L006E
                lda #>L06BF
                sta L006E+1
                ldy #0

L851D:
                txa
                bne L8524
                lda (L0070),y
                sta (L006E),y

L8524:
                lda (L006E),y
                sta (L0070),y
                inc L0070
                bne L852E
                inc L0071

L852E:
                inc L006E
                bne L8534
                inc L006E+1

L8534:
                lda L006E+1
                cmp #>L07EC
                bne L851D
                lda L006E
                cmp #<L07EC
                bne L851D
                rts

;-------------------------------------------------------------------------

L8541:
                lda L0015
                sec
                sbc #11
                sta L006E
                tax
                lda L0016
                sbc #0
                sta L006E+1
                tay
                txa
; !! substract $012D?
                sbc #$2D
                sta L006A
                sta L0070
                tya
                sbc #1
                sta L006B
                sta L0071
                rts

;-------------------------------------------------------------------------

L855F:
                lda #$82        ; OSBYTE read machine higher order address
                jsr OSBYTE
                stx L0504
                sty L0505
                stx L050C
                sty L050D
                stx L0510
                sty L0511
                rts

;-------------------------------------------------------------------------

; Exit: Z=1 if ROM FS

is_ROM_FS:
                lda #0          ; OSARGS get current filing system
                tay             ; OSARGS get current filing system
                jsr OSARGS
                cmp #3          ; 3 = ROM filing system
                rts

;-------------------------------------------------------------------------

L8580:
                lda #0
                ldx #$DD
                cpx L0683
                bne L858D
                cpx L000A
                beq L8590

L858D:
                sta L06A5

L8590:
                ldy #$13

L8592:
                sta L07EC,y
                dey
                bpl L8592
                tay

L8599:
                sta L06C2,y
                iny
                cpy #$DC
                bne L8599
                ldy #$13
                jsr LAE75
                clc
                jsr LAB8B
                ldx #9

L85AC:
                lda L06C2,x
                sta L073A,x
                dex
                bpl L85AC
                lda #$83        ; OSBYTE read OSHWM
                jsr OSBYTE
                stx OSWHM
                sty OSWHM+1
; + $01EE
                txa
                sec
                adc #$EE
                sta L0015
                tya
                adc #1
                sta L0016
                ldy #0
                sty L06BF
                sty L0051
                lda #$DD
                sta L0683
                sta L000A
                sta (L0015),y
                inc L0015
                bne L85DF
                inc L0016

L85DF:
                ldx L0015
                ldy L0016
                inx
                stx L0017
                bne L85E9
                iny

L85E9:
                sty L0018
                inx
                stx L0019
                bne L85F1
                iny

L85F1:
                sty L001A
                stx L001B
                sty L001C
                stx L001D
                sty L001E
                stx L001F
                sty L001F+1
                lda #$FF
                ldy #0
                sta (L0015),y
                sta (L0017),y
                sta (L001F),y
                sty L004A
                sty L004C
                sty L004D
                sty L004E
                ldx #$3F
                tya

L8614:
                sta L07AC,x
                dex
                bpl L8614
                rts

;-------------------------------------------------------------------------

L861B:
                jsr L9ADB
                jsr LA1F5

L8621:
                jsr LA1BC
                bcs L8654
                lda escape_flag
                bmi L8651
                lda L0070
                ldy L0071
                jsr LAB06
                bcs L8621
                lda L0070
                ldy L0071
                jsr L9BA5
                lda #$FF
                sec
                sbc L0060
                sta L005F
                jsr L96DC
                lda L0070
                ldy L0071
                jsr L9B13
                jsr L96E0
                jmp L8621

;-------------------------------------------------------------------------

L8651:
                jsr acknowledge_escape

L8654:
                jmp L865D

;-------------------------------------------------------------------------

L8657:
                jsr L9ADB

L865A:
                jsr L9919

L865D:
                jsr L9AD2

L8660:
                jmp command_loop_2

;-------------------------------------------------------------------------

brk_handler:
                bit L005B
                bmi L8669
                bvc L867F

L8669:
                jsr L9AD2
                ldy #1

L866E:
                lda ($FD),y
                beq L8678
                jsr OSASCI
                iny
                bne L866E

L8678:
                jsr OSNEWL
                bit L005B
                bmi L8660

L867F:
                lda L005B
                and #$F
                ldy #8

;-------------------------------------------------------------------------

; Look up address in table and jump to that routine.
; Entry: Y=table value (0/2/4/6)
;        A=index in table

L8685:
                asl a           ; *2 - tables are words
                clc
                adc table_addrs,y; table address LSB+index to form actual address LSB
                sta L006E      ; store actual address LSB
                .if include_sideways_ram_protection
                lda is_second_processor; 0 if host, non-0 if parasite
                bne L8693           ; taken if parasite
                .if b10_var2
                bit L006E       ; ???
                .elif patch_out_sideways_ram_protection
                nop
                nop
                nop
                .else
                inc L8693+1         ; wtf. sideways RAM protection mechanism, presumably??
                .endif
                .endif

L8693:
                lda #0
                adc table_addrs+1,y; table address MSB+carry to form actual address MSB
                sta L006E+1      ; store actual address MSB
                ldy #0
; fetch routine address from actual address
                lda (L006E),y
                sta L006C
                iny
                lda (L006E),y
                sta L006D
; jump to routine address
                jmp (L006C)

;-------------------------------------------------------------------------

L86A8:
                jsr clear_screen
                lda #13
                jsr OSWRCH
                lda #$E1        ; OSBYTE control character $80-$8f interpretation
                                ; (f0-f9, cursor keys)
                sta L0054
                sta L0055
                ldy #0
                .if handle_8_bit_input
                ldx #2
                .else
                ldx #$8C        ; F key = $8C+value
                .endif
                jsr OSBYTE
                lda #$E2        ; OSBYTE control character $90-$9f interpretation
                                ; (SHIFT+(f0-f9, cursor keys))
                ldy #0
                .if handle_8_bit_input
                ldx #2
                .else
                ldx #$9C        ; SHIFT+F key = $9C+value
                .endif
                jsr OSBYTE
                lda #$E3        ; OSBYTE control character $A0-$AF interpretation
                                ; (CTRL+(f0-f9, cursor keys))
                ldy #0
                .if handle_8_bit_input
                ldx #2
                .else
                ldx #$AC        ; CTRL+F key = $AC+value
                .endif
                jsr OSBYTE
                lda #4          ; OSBYTE enable/disable cursor editing
                ldx #2          ; disable cursor editing, set edit keys as soft keys
                jsr OSBYTE
                lda #0
                tay             ; Y=0

L86D9:
                sta (OSWHM),y
                iny
                bne L86D9
                inc OSWHM+1
                ldx #$EE

L86E2:
                sta (OSWHM),y
                iny
                dex
                bne L86E2
                dec OSWHM+1
                tay
                sty L0050
                sty L0048
                sty L0047
                lda #4
                jsr gotoxy      ; move text cursor
                                ; Entry: A=X coord
                                ;        Y=Y coord
                jsr print_following_string; print 0-terminated string following call

;-------------------------------------------------------------------------

                .text "SLOT="
                .byte $D
                .text "CONTENTS="
                .byte 0

;-------------------------------------------------------------------------

L8709:
                jsr L9751
                jsr L94DF
                lda L0050
                bmi L874F
                jsr LAB02
                bcs L874C
                bmi L874C
                ldy #5
                lda (L0006),y
                bpl L874C
                lda L0006
                sta L0000
                lda L0006+1
                sta L0000+1
                iny
                sty L002A
                jsr LA4AA
                bcs L874C
                jsr L97BB
                sta L0060

L8735:
                lda error_strings,x; "Brackets"
                beq L8742
                jsr OSWRCH
                inc L0060
                inx
                bne L8735

L8742:
                lda L0050
                jsr L9C28
                sty L0050
                jmp L874F

;-------------------------------------------------------------------------

L874C:
                jsr LAD3C

L874F:
                jsr LAD84
                .if handle_8_bit_input
                php
                .endif
                jsr LAD3C
                .if handle_8_bit_input
                plp
                bvs L8770
                .else
                tax
                bmi L8770
                cmp #$20
                bcc L8760
                cmp #$7F
                bcc L8782
L8760:
                .endif
                ldy #$FF

L8762:
                iny
                ldx L877F,y
                .if handle_8_bit_input
                bmi L8782
                .else
                bmi L874F
                .endif
                cmp L877F,y
                bne L8762
                tya
                .if handle_8_bit_input
                adc #$7d
                .else
                adc #$89
                .endif

L8770:
                sec
                .if handle_8_bit_input
                sbc #$7e
                .else
                sbc #$8A
                .endif
                cmp #$25
                bcs L874F
                ldy #4
                jsr L8685    ; Look up address in table and jump to that routine.
                                ; Entry: Y=table value (0/2/4/6)
                                ;        A=index in table
                jmp L878E

;-------------------------------------------------------------------------

L877F:
                .byte 27
                .byte 9
                .byte $FF

;-------------------------------------------------------------------------

L8782:
                .if handle_8_bit_input
                cmp #' '
                bcc L874F
                jsr LA34B_B101
                bcs L874F
                .endif
                sta L0500
                ldy #0
                sty L0501
                iny
                jsr L880A

L878E:
                lda L004A
                pha
                and #$80
                sta L004A
                pla
                bmi L879F
                and #$7F
                beq L879F
                jsr L87A2

L879F:
                jmp L8709

;-------------------------------------------------------------------------

L87A2:
                jsr LA171
                jmp L9076

;-------------------------------------------------------------------------

L87A8:
                jsr LAABE
                bcs L87BC
                jsr LAB02
                bcs rts87BB
                bmi L87B6
                inc L004A

L87B6:
                jsr LA116
                inc L0054

rts87BB:
                rts

;-------------------------------------------------------------------------

L87BC:
                lda #$89
                jsr LAD4E    ; !! A=something...

;-------------------------------------------------------------------------

aProtected:     .text "Protected"
                .byte 0

;-------------------------------------------------------------------------

                rts

;-------------------------------------------------------------------------

L87CC:
                ldx #0
                lda L000B
                ldy L000C
                jsr L9B8C
                txa
                tay
                lda #0
                sta L0500,y
                beq L880A

L87DE:
                lda #8
                jsr LAD4E    ; !! A=something...

;-------------------------------------------------------------------------

                .text "Too long"
                .byte 0

;-------------------------------------------------------------------------

                jmp L8808

;-------------------------------------------------------------------------

L87EF:
                lda #$86
                jsr LAD4E    ; !! A=something...

;-------------------------------------------------------------------------

                .text "Memory"
                .byte 0

;-------------------------------------------------------------------------

rts87FB:
                rts

;-------------------------------------------------------------------------

L87FC:
                lda #0
                sta L0500
                lda L000B
                ldy L000C
                jsr L9B18

L8808:
                ldy #0

;-------------------------------------------------------------------------

L880A:

                tya
                pha
                jsr LAABE
                pla
                tay
                bcs L87BC
                jsr LA310
                bcs rts87FB
                lda #$40
                sta L004B
                jsr LAB02
                bcs L8827
                bmi L8827
                lda #0
                sta L004B

L8827:
                jsr L9E31

L882A:
                bcs L87DE
                tya
                pha
                jsr LA4AA
                pla
                tay
                bcs L8847
                inx
                bne L8847
                jsr L9421
                rol L004B
                sec
                ror L004B
                ldy #$FF

L8842:
                iny
                lda (L0000),y
                bne L8842

L8847:
                ror L0041
                tya
                beq L8859
                sta L0064
                lda #0
                bit L004B
                bmi L8856
                lda #6

L8856:
                sec
                adc L0064

L8859:
                sta L0061
                lda L000B
                ldy L000C
                jsr L9EBD
                bcs L87EF
                lda L0061
                beq L88B0
                ldy #0
                sty L0063
                bit L004B
                bmi L888E
                lda L0011

L8872:
                sta L0006
                lda L0012
                sta L0006+1
                jsr store_fwa   ; store FWA to (L0006)
                ldy #5
                lda (L0011),y
                bit L004B
                bvc L8885
                lda #$7F

L8885:
                rol a
                rol L0041
                ror a
                eor #$80
                sta (L0011),y
                iny

L888E:
                sty L0064

L8890:
                jsr L88A2
                beq L88B0
                cmp #1
                bne L8890
                jsr L88A2
                jsr L88A2
                jmp L8890

;-------------------------------------------------------------------------

L88A2:
                ldy L0063
                lda (L0000),y
                inc L0063
                ldy L0064
                sta (L0011),y
                inc L0064
                tax
                rts

;-------------------------------------------------------------------------

L88B0:
                jsr LAB0A
                bcs L88B8
                jsr LAB7C

L88B8:
                lda L004B
                eor #$C0
                beq L88C0
                inc L004A

L88C0:
                lda L004C
                beq L88D1
                jsr L9076
                lda L004C
                bpl L88CE
                jmp L918A

;-------------------------------------------------------------------------

L88CE:
                jmp L9157

;-------------------------------------------------------------------------

L88D1:
                lda L0054
                bne rts88D7
                inc L0054

rts88D7:
                rts

;-------------------------------------------------------------------------

L88D8:
                dec L004C
                bpl rts88E5
                ldx L004C
                inx
                beq rts88E5
                lda #1
                sta L004C

rts88E5:
                rts

;-------------------------------------------------------------------------

L88E6:
                lda #$C
                jsr LAD53

;-------------------------------------------------------------------------

                .text "Row heading?"
                .byte 0

;-------------------------------------------------------------------------

                ldx #1
                bne L8913

L88FC:
                lda #$F
                jsr LAD53

;-------------------------------------------------------------------------

                .text "Column heading?"
                .byte 0

;-------------------------------------------------------------------------

                ldx #0

L8913:
                stx L0049
                lda L000B,x
                ldx #0
                stx L0500
                stx L005E
                jsr L9CA0
                tay
                lda #0
                bcc L8932
                beq L892A

L8928:
                lda (L0072),y

L892A:
                sta L0500,y
                dey
                bpl L8928

L8930:
                lda L0073

L8932:
                pha
                lda L0072
                pha
                lda L0049
                pha
                jsr LA30E
                pla
                sta L0049
                pla
                sta L0072
                pla
                sta L0073
                bcs L8994
                jsr L9E09
                bcs L8997
                lda fp_slot_0
                beq L8965
                jsr L9DFF
                bcs L8997
                cpx #3
                bcc L8997
                jsr L9CE5
                bcs L8965
                ldx L0049
                cmp L000B,x
                bne L8997

L8965:
                lda L0073
                beq L896C
                jsr LA215

L896C:
                lda fp_slot_0
                beq L8994
                jsr LA301
                tay
                jsr LA0F3
                bcs L89AB
                jsr LA286
                ldy #0
                ldx L0049
                lda L000B,x
                sta (L006A),y
                ldx #0

L8987:
                lda fp_slot_0,x
                beq L898D
                inx

L898D:
                iny
                sta (L006A),y
                cpy #$F
                bne L8987

L8994:
                jmp L9076

;-------------------------------------------------------------------------

L8997:
                lda #$E
                jsr LAD4E    ; !! A=something...

;-------------------------------------------------------------------------

aBadHeading:    .text "Bad Heading"
                .byte 0

;-------------------------------------------------------------------------

                jmp L8930

;-------------------------------------------------------------------------

L89AB:
                jmp L87EF

;-------------------------------------------------------------------------

L89AE:
                ldx #0
                beq L89B4

L89B2:
                ldx #1

L89B4:
                lda L000B,x
                jsr LAAE2
                eor L07AC,y
                sta L07AC,y
                jmp L89DA

;-------------------------------------------------------------------------

L89C2:
                lda L06C1
                clc
                adc #$C
                cmp #$78
                bcc L89CE
                lda #0

L89CE:
                tax
                stx L06C1
                lda L06CA,x
                bmi L89C2
                jsr L8343

L89DA:
                jmp L9076

;-------------------------------------------------------------------------

L89DD:
                lda L004A
                and #$80
                eor #$80
                sta L004A

rts89E5:
                rts

;-------------------------------------------------------------------------

L89E6:
                lda #7
                jsr LAD53

;-------------------------------------------------------------------------

                .text "Window?"
                .byte 0

;-------------------------------------------------------------------------

                lda #0
                sta L0500
                beq L89FD

L89FA:
                jsr beep

L89FD:
                jsr LA30E
                bcs rts89E5
                lda #0
                sta L005E
                jsr L942F
                bcs L89FA
                jsr L923A
                lda #$22
                jsr LAD53

;-------------------------------------------------------------------------

                .text "Wi TopL  BotR  Pos Cw  Bw Fmt  Opt"
                .byte 0

;-------------------------------------------------------------------------

                ldy #0
                beq L8A3F

L8A3A:
                jsr beep
                ldy L005E

L8A3F:
                jsr LA310
                bcs rts89E5
                jsr L931D
                bcs L8A3A
                lda L0023
                cmp #$A
                ror L005F
                jsr LAC72
                stx L0064
                ldx #$B
                bit L005F
                bpl L8A5C
                ldx #9

L8A5C:
                txa
                clc
                adc L0064
                tay

L8A61:
                lda fwa_sign,x
                sta L06C2,y
                dey
                dex
                bpl L8A61
                rol L005F
                bcs L8ABD
                jsr LAB8B

L8A71:
                ldx L06C1
                lda L06CA,x
                bpl L8A81
                ldx #0
                stx L06C1
                jsr LAEA1

L8A81:
                jsr L8343
                jsr LA2F9
                lda #9

L8A89:
                pha
                jsr LAC72
                lda L06CA,x
                bmi L8AB7
                lda L0066
                sta L06CC,x
                lda L0066+1
                sta L06CD,x
                jsr L9138
                tay
                iny
                lda L06C5,x
                sec
                sbc L06C3,x
                adc #0
                jsr LAF1D
                clc
                adc L0066
                sta L0066
                tya
                adc L0066+1
                sta L0066+1

L8AB7:
                pla
                sec
                sbc #1
                bcs L8A89

L8ABD:
                pla
                pla
                jmp L86A8

;-------------------------------------------------------------------------

                .if !B101
L8AC2:
                jsr LAB02
                bcs rts8AD3
                bpl rts8AD3
                ldy #0
                lda (L0006),y
                eor #$80
                sta (L0006),y
                inc L0054

rts8AD3:
                rts
                .endif
                
;-------------------------------------------------------------------------

L8AD4:
                jsr LAB02
                bcs rts8B27
                bmi rts8B27
                lda #7
                jsr LAD53

;-------------------------------------------------------------------------

                .text "Format?"
                .byte 0

;-------------------------------------------------------------------------

                lda #0
                sta L0024
                ldy #5
                lda (L0006),y
                ldx L06C1
                jsr L945A
                lda #0
                ldy L0024
                sta L0500,y
                tay
                beq L8B05

L8B00:
                jsr beep
                ldy L005E

L8B05:
                jsr LA310
                bcs rts8B27
                lda #0
                sta L005E
                jsr L9421
                jsr LAB02
                jsr L948B
                bcs L8B00
                bvs L8B00
                bne L8B1F
                lda #$7F

L8B1F:
                ldy #5
                sta (L0006),y
                inc L004A
                inc L0054

rts8B27:
                rts

;-------------------------------------------------------------------------

L8B28:
                jmp beep

;-------------------------------------------------------------------------

L8B2B:
                jmp L87EF

;-------------------------------------------------------------------------

L8B2E:
                ldy L06BF
                iny
                beq L8B28
                lda L000C
                cmp L06BF
                bcs L8B55
                jsr LA305
                tay
                jsr LA0F3
                bcs L8B2B
                inc L06BF
                lda #1
                sta L0062
                lda L06BF
                sta L0063
                lda L000C
                jsr LA023

L8B55:
                ldx #1
                jsr LAA5B
                ldy L000C
                lda #$FF
                jmp L8BDF

;-------------------------------------------------------------------------

L8B61:
                lda L06BF
                sta L0063
                beq L8BD6
                ldx #0

L8B6A:
                ldy L0063
                dey
                tya
                jsr LAB5F
                ldy #0
                lda (L006E),y
                beq L8B82
                tay
                dey
                cpy #$FE
                bcs L8B28
                cpy L000B
                bcc L8B82
                inx

L8B82:
                dec L0063
                bne L8B6A
                txa
                asl a
                sta L0066
                lda L000B
                sta L006C
                lda #0
                sta L006D
                sta L0066+1
                tay
                jsr LA0F3
                bcs L8B2B
                jsr L990C

L8B9D:
                jsr LAB5D
                ldy #0
                lda (L006E),y
                beq L8BCA
                tax
                dex
                cpx L000B
                bcc L8BCA
                adc #0
                sta (L006E),y
                lda L000B
                jsr LAB41
                sta L006A
                sty L006B
                jsr LA2FD
                jsr LA282
                ldy #0
                tya
                sta (L006A),y
                iny
                sta (L006A),y
                jsr LA050

L8BCA:
                jsr L98DF
                inc L006D
                lda L006D
                cmp L06BF
                bcc L8B9D

L8BD6:
                ldx #0
                jsr LAA5B
                lda L000B
                ldy #$FF

L8BDF:
                ldx #1

;-------------------------------------------------------------------------

L8BE1:
                sta L0066
                sty L0066+1
                stx L0060
                jsr LA1F5

L8BEA:
                jsr LA1BC
                bcs L8C11
                lda L0070
                ldy L0071
                jsr LAB06
                bcs L8BEA
                bmi L8BEA
                ldy #5

L8BFC:
                iny
                lda (L0006),y
                beq L8BEA
                cmp #1
                bne L8BFC
                ldx #0
                jsr L8C3D
                inx
                jsr L8C3D
                jmp L8BFC

;-------------------------------------------------------------------------

L8C11:
                lda #0
                sta L0049
                ldx #L0015
                jsr L8C1E    ; Entry: X=ZP address
                inc L0049
                ldx #$17

;-------------------------------------------------------------------------

; Entry: X=ZP address

L8C1E:
                lda 0,x
                sta L0072
                lda 1,x
                sta L0073
                ldy #0

L8C28:
                lda (L0072),y
                cmp #$FF
                beq L8C3A
                ldx L0049
                jsr L8C46
                sta (L0072),y
                jsr L9CD8
                bcs L8C28

L8C3A:
                jmp L9076

;-------------------------------------------------------------------------

L8C3D:
                iny
                lda (L0006),y
                jsr L8C46
                sta (L0006),y
                rts

;-------------------------------------------------------------------------

L8C46:
                cmp L0066,x
                bcc rts8C59
                clc
                adc L0060
                cmp #$FF
                bcc rts8C59
                lda #0
                bit L0060
                bmi rts8C59
                lda #$FE

rts8C59:
                rts

;-------------------------------------------------------------------------

L8C5A:
                lda L004E
                beq L8CC2
                ldx #0
                stx L006D
                jsr LA20C
                lda L06BF
                beq L8CB4
                jsr L990C

L8C6D:
                jsr LAB5D
                ldy #0
                lda (L006E),y
                beq L8CA8
                tax
                dex
                cpx L000B
                bcc L8CA8
                lda L000B
                sta L006C
                jsr LA116
                jsr LAB5D
                ldy #0
                lda (L006E),y
                sec
                sbc #1
                sta (L006E),y
                lda L000B
                jsr LAB41
                sta L006A
                sty L006B
                jsr LA2FD
                jsr LA208
                jsr L8DA6
                lda #$FF
                sta L006C
                jsr LA050

L8CA8:
                jsr L98DF
                inc L006D
                lda L006D
                cmp L06BF
                bcc L8C6D

L8CB4:
                ldx #0
                jsr LAA7F
                ldx L000B
                inx
                txa
                ldy #$FF
                jmp L8D3F

;-------------------------------------------------------------------------

L8CC2:
                jmp L87BC

;-------------------------------------------------------------------------

L8CC5:
                lda L004E
                beq L8CC2
                ldx #1
                jsr LA20C
                lda L000C
                cmp L06BF
                bcs L8D35
                sta L006D
                jsr LAB5F
                jsr L990C
                ldy #0
                sty L006C
                lda (L006E),y
                pha
                beq L8CF4
                sta L0060

L8CE8:
                jsr LA116
                jsr L98DF
                inc L006C
                dec L0060
                bne L8CE8

L8CF4:
                lda #0
                sta L0066+1
                pla
                asl a
                rol L0066+1
                sta L0066
                jsr LAB5D
                lda #0
                tay
                sta (L006E),y
                jsr LAB41
                sta L006A
                sty L006B
                jsr LA208
                jsr L8DA6
                jsr LA050
                jsr LA305
                jsr LAB5D
                lda L006E
                sta L006A
                lda L006E+1
                sta L006B
                jsr LA204
                dec L06BF
                lda L06BF
                sta L0063
                jsr L8DA6
                jsr LA0C5

L8D35:
                ldx #1
                jsr LAA7F
                ldy L000C
                iny
                lda #$FF

L8D3F:
                inc L004A
                ldx #$FF
                jsr L8BE1
                jmp flush_input_buffer

;-------------------------------------------------------------------------

L8D49:
                lda #5
                jsr LAD53

;-------------------------------------------------------------------------

                .text "Slot?"
                .byte 0

;-------------------------------------------------------------------------

                lda #0
                sta L0500
                beq L8D5E

L8D5B:
                jsr beep

L8D5E:
                jsr LA30E
                bcs rts8DB3
                lda #0
                sta L005E
                jsr L9D87
                bcs L8D5B
                lda L0066+2
                ldy L0066+3

;-------------------------------------------------------------------------

L8D70:
                sta L000B
                sty L000C
                ldx L06C1
                cmp L06C2,x
                bcc L8D90
                cmp L06C4,x
                beq L8D83
                bcs L8D90

L8D83:
                tya
                cmp L06C3,x
                bcc L8D90
                cmp L06C5,x
                beq rts8DB3
                bcc rts8DB3

L8D90:
                lda L000B
                jsr L907D
                ror L006A
                pha
                inx
                lda L000C
                jsr L907D
                ror L006B
                tay
                pla
                dex
                jmp L91A4

;-------------------------------------------------------------------------

L8DA6:
                lda #0
                sec
                sbc L0066
                sta L0066
                lda #0
                sbc L0066+1
                sta L0066+1

rts8DB3:
                rts

;-------------------------------------------------------------------------

L8DB4:
                lda #0
                sta L0500
                lda #$A
                jsr LAD53

;-------------------------------------------------------------------------

                .text "From - To?"
                .byte 0

;-------------------------------------------------------------------------

L8DC9:
                lda #0
                sta L005E
                beq L8DD2

L8DCF:
                jsr beep

L8DD2:
                ldy L005E
                jsr LA310
                bcs rts8DB3
                lda #$FF
                ldy #7

L8DDD:
                sta fwa_sign,y
                dey
                bpl L8DDD
                jsr L9421
                iny
                sty L005E
                sty L005F
                sty L0024
                lda #4
                sta L0023

L8DF1:
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L8E25
                jsr L9D87
                bcs L8DCF
                sty L005E
                ldx L005F
                ldy L0066+2
                sty fwa_sign,x
                inx
                ldy L0066+3
                sty fwa_sign,x
                inx
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L8E25
                cmp #$2D
                bne L8E1F
                lda L0024
                bne L8DCF
                inc L0024
                inc L005E
                ldx #3
                stx L0023
                inx

L8E1F:
                stx L005F
                dec L0023
                bne L8DF1

L8E25:
                ldx fwa_mantissa_2
                inx
                beq L8E3E
                ldx #0
                jsr L8E59
                bcc L8E3E
                sta L0064
                ldx #4
                jsr L8E59
                bcc L8E3E
                and L0064
                beq L8E92

L8E3E:
                lda #5
                jsr LAD4E    ; !! A=something...

;-------------------------------------------------------------------------

                .text "Range"
                .byte 0

;-------------------------------------------------------------------------

                jmp L8DC9

;-------------------------------------------------------------------------

L8E4C:
                lda #4
                jsr LAD4E    ; !! A=something...

;-------------------------------------------------------------------------

                .text "Edge"
                .byte 0

;-------------------------------------------------------------------------

                jmp L8DC9

;-------------------------------------------------------------------------

L8E59:
                ldy fwa_mantissa_1,x
                tya
                iny
                beq L8E76
                ldy #0
                cmp fwa_overflow,x
                bcc rts8E91
                beq L8E69
                ldy #2

L8E69:
                lda fwa_exponent,x
                cmp fwa_sign,x
                bcc rts8E91
                beq L8E76
                clc
                tya
                bne rts8E91
                iny

L8E76:
                tya
                dey
                sty fwb_exponent,x
                pha
                lda fwa_exponent,x
                ldy fwa_mantissa_1,x
                cpy #$FF
                bne L8E87
                lda fwa_sign,x
                ldy fwa_overflow,x

L8E87:
                sta fwa_exponent,x
                sty fwa_mantissa_1,x
                sta fwb_sign,x
                sty fwb_overflow,x
                pla
                sec

rts8E91:
                rts

;-------------------------------------------------------------------------

L8E92:
                ldx fwb_exponent
                bmi L8EB2
                lda fwa_exponent,x
                sec
                sbc fwa_sign,x
                sta L0064
                lda fwa_mantissa_4,x
                clc
                adc L0064
                bcs L8E4C
                cmp #$FF
                bcs L8E4C
                sta fwa_mantissa_4,x
                lda fwa_mantissa_4
                sta fwb_mantissa_2
                lda fwa_rounding
                sta fwb_mantissa_3

L8EB2:
                jsr L990C

L8EB5:
                lda fwb_sign
                ldy fwb_overflow
                jsr LAB06
                php
                rol L004B
                plp
                php
                clc
                bpl L8EC5
                sec

L8EC5:
                ror L004B
                plp
                jsr LA158
                sty L0023
                lda L0023
                beq L8EFD
                ldy #0
                ldx L004B
                bmi L8EDC
                sec
                sbc #5
                ldy #5

L8EDC:
                tax
                inx
                stx L0064
                ldx #0
                stx L0060

L8EE4:
                lda (L0006),y
                sta L0500,x
                inx
                iny
                cpx #1
                beq L8EF5
                cmp #1
                bne L8EF5
                inc L0060

L8EF5:
                dec L0064
                bne L8EE4
                lda L0060
                bne L8F00

L8EFD:
                jmp L8FA9

;-------------------------------------------------------------------------

L8F00:
                lda fwb_sign
                ldy fwb_overflow
                jsr L9C0D
                jsr L97B1
                lda fwb_sign
                ldy fwb_overflow
                jsr L9BE4
                ldx #0

L8F13:
                inx
                lda L0500,x
                beq L8EFD
                cmp #1
                bne L8F13
                stx L0024
                stx L0025
                jsr L97B7
                jsr L97A1
                ldx num_columns
                dex
                stx L005F
                jsr L9B44
                ldx L0024

L8F31:
                lda L0501,x
                ldy L0502,x
                jsr L9BAC
                jsr L9782
                ldx L0024
                inx
                inx

L8F41:
                inx
                stx L0024
                lda L0500,x
                beq L8F53
                cmp #1
                beq L8F31
                jsr L9BDF
                jmp L8F41

;-------------------------------------------------------------------------

L8F53:
                lda num_columns
                sec
                sbc L0060
                tax
                jsr L9C31
                lda #$16
                jsr LAD53

;-------------------------------------------------------------------------

                .text "R)elative, N)o change?"
                .byte 0

;-------------------------------------------------------------------------

                ldx #1

L8F7A:
                jsr L973B
                jsr LAD84
                .if handle_8_bit_input
                bvs L8F95
                .endif
                pha
                jsr L9751
                pla
                and #$DF
                cmp #27
                beq L8FA6
                ldx L0025
                cmp #'R'
                beq L8F9B
                cmp #'N'
                beq L8F9E
L8F95:
                jsr beep
                jmp L8F7A

;-------------------------------------------------------------------------

L8F9B:
                inc L0500,x

L8F9E:
                inx
                inx
                jmp L8F13

;-------------------------------------------------------------------------

L8FA3:
                jsr L87EF

L8FA6:
                jmp L9071

;-------------------------------------------------------------------------

L8FA9:
                lda L0023
                sta L0061

L8FAD:
                jsr L98DF
                lda fwb_mantissa_2
                ldy fwb_mantissa_3
                jsr LAAC2
                bcs L9038
                jsr L9EC1
                bcs L8FA3
                jsr LAB0A
                bcs L9038
                jsr LAB7C
                lda L0023
                sta L0062
                ldy #0
                lda L004B
                bmi L8FDB
                ldx #5
                tya

L8FD3:
                sta (L0011),y
                iny
                dec L0062
                dex
                bne L8FD3

L8FDB:
                ldx #0
                dey

L8FDE:
                iny
                lda L0500,x
                sta (L0011),y
                dec L0062
                beq L9038
                inx
                cpx #1
                beq L8FDE
                cmp #1
                beq L8FFA
                cmp #2
                bne L8FDE
                lda #1
                sta (L0011),y
                clc

L8FFA:
                sty L0063
                ldy L0500,x
                inx
                lda L0500,x
                inx
                bcs L9027
                sty L006E
                sta L006E+1
                lda fwb_mantissa_2
                sec
                sbc fwb_sign
                clc
                adc L006E
                tay
                cpy #$FF
                bcc L9019
                ldy #$FE

L9019:
                lda fwb_mantissa_3
                sec
                sbc fwb_overflow
                clc
                adc L006E+1
                cmp #$FF
                bcc L9027
                lda #$FE

L9027:
                pha
                tya
                ldy L0063
                iny
                sta (L0011),y
                iny
                pla
                sta (L0011),y
                dec L0062
                dec L0062
                bne L8FDE

L9038:
                lda fwb_mantissa_2
                ldy fwb_mantissa_3
                jsr L9C0D
                ldx fwb_mantissa_4
                bpl L9047

L9043:
                ldx fwb_exponent
                bmi L9071

L9047:
                lda fwb_mantissa_2,x
                sec
                sbc #1
                bcc L9058
                sta fwb_mantissa_2,x
                cpx fwb_mantissa_4
                bne L905E
                cmp fwa_mantissa_2,x
                bcs L906E

L9058:
                lda fwa_mantissa_4,x
                sta fwb_mantissa_2,x
                bcc L9043

L905E:
                lda fwb_sign,x
                sec
                sbc #1
                bcc L9071
                sta fwb_sign,x
                cmp fwa_sign,x
                bcc L9071
                jmp L8EB5

;-------------------------------------------------------------------------

L906E:
                jmp L8FAD

;-------------------------------------------------------------------------

L9071:
                inc L004A
                jsr LA4A2

;-------------------------------------------------------------------------

L9076:
                lda #$FF
                sta L0054
                sta L0055
                rts

;-------------------------------------------------------------------------

L907D:
                sta L0062
                lda L06C4,x
                sta L0061
                jsr L9138
                sta L0063
                lsr a
                sta L0064
                lda L0062
                sec
                sbc L0064
                bcs L9095
                lda #0

L9095:
                clc
                adc L0063
                bcs L909E
                cmp #$FF
                bcc L90A4

L909E:
                lda #$FE
                sbc L0063
                bcs L9095

L90A4:
                cmp L0061
                bcs L90B0
                sta L0064
                lda L0061
                sec
                sbc L0064
                rts

;-------------------------------------------------------------------------

L90B0:
                sbc L0061
                clc
                rts

;-------------------------------------------------------------------------

L90B4:
                lda #0
                beq L90BA

L90B8:
                lda #1

L90BA:
                jsr L9129
                ldx L0063
                lda L000B,x
                sec
                sbc L0064
                bcs L90E2
                lda #0
                beq L90E2

L90CA:
                lda #0
                beq L90D0

L90CE:
                lda #1

L90D0:
                jsr L9129
                ldx L0063
                lda L000B,x
                clc
                adc L0064
                bcs L90E0
                cmp #$FF
                bcc L90E2

L90E0:
                lda #$FE

L90E2:
                sta L000B,x
                ldx L06C1
                lda L000B
                cmp L06C2,x
                bcc L9103
                cmp L06C4,x
                beq L90F5
                bcs L9103

L90F5:
                lda L000C
                cmp L06C3,x
                bcc L9103
                cmp L06C5,x
                beq rts9137
                bcc rts9137

L9103:
                ldx L0063
                ror a
                eor #$80
                sta L006A,x
                bpl L9113
                lda L000D,x
                sec
                sbc L000B,x
                bcs L9118

L9113:
                lda L000B,x
                sec
                sbc L000D,x

L9118:
                tay
                txa
                beq L9120
                lda #0
                beq L9123

L9120:
                tya
                ldy #0

L9123:
                ldx L06C1
                jmp L91A4

;-------------------------------------------------------------------------

L9129:
                sta L0063
                clc
                adc L06C1
                tax
                jsr L9138
                sta L0064
                inc L0064

rts9137:
                rts

;-------------------------------------------------------------------------

L9138:
                lda L06C4,x
                sec
                sbc L06C2,x

rts913F:
                rts

;-------------------------------------------------------------------------

L9140:
                ldx L000C
                beq rts913F
                dex
                stx L000C
                txa
                ldx L06C1
                cmp L06C3,x
                bcs rts913F
                sec
                ror L006B
                lda #0
                beq L916F

L9157:
                ldx L000C
                inx
                cpx #$FF
                beq rts913F
                stx L000C
                txa
                ldx L06C1
                cmp L06C5,x
                beq rts913F
                bcc rts913F
                lda #0
                sta L006B

L916F:
                ldy #1
                bne L91A4

L9173:
                ldx L000B
                beq rts913F
                dex
                stx L000B
                txa
                ldx L06C1
                cmp L06C2,x
                bcs rts913F
                sec
                ror L006A
                ldy #0
                beq L91A2

L918A:
                ldx L000B
                inx
                cpx #$FF
                beq rts913F
                stx L000B
                txa
                ldx L06C1
                cmp L06C4,x
                beq rts913F
                bcc rts913F
                ldy #0
                sty L006A

L91A2:
                lda #1

L91A4:
                sta L0066+2
                sty L0066+3
                stx L0061
                lda #0
                sta L0060
                lda L06CA,x
                and #3
                sta L0062
                ldy #9

L91B7:
                tya
                jsr LAC72
                stx L0023
                lda L06CA,x
                bmi L91F1
                cpx L0061
                beq L91CF
                lda L06CA,x
                and #2
                and L0062
                beq L91D9

L91CF:
                lda L006A
                rol a
                lda L0066+2
                beq L91D9
                jsr L91FF

L91D9:
                cpx L0061
                beq L91E6
                lda L06CA,x
                and #1
                and L0062
                beq L91F1

L91E6:
                lda L006B
                rol a
                lda L0066+3
                beq L91F1
                inx
                jsr L91FF

L91F1:
                dey
                bpl L91B7
                lda L0060
                beq rts91FE
                sty L0054
                iny
                iny
                sty L0055

rts91FE:
                rts

;-------------------------------------------------------------------------

L91FF:
                php
                pha
                jsr L9138
                sta L0063
                pla
                plp
                bcs L921A
                adc L06C4,x
                bcs L9213
                cmp #$FF
                bcc L9215

L9213:
                lda #$FE

L9215:
                sec
                sbc L0063
                bcs L9225

L921A:
                sta L0064
                lda L06C2,x
                sbc L0064
                bcs L9225
                lda #0

L9225:
                sta L06C2,x
                clc
                adc L0063
                sta L06C4,x
                ldx L0023
                rol L06CB,x
                sec
                ror L06CB,x
                inc L0060
                rts

;-------------------------------------------------------------------------

L923A:
                ldy #0
                sty L0024
                pha
                jsr LAC72
                stx L0023
                pla
                pha
                cmp #$A
                bcc L9253
                sbc #$A
                pha
                lda #$50
                jsr L92FE
                pla

L9253:
                jsr L930A
                lda #3
                jsr L92EF
                ldx L0023
                stx L0025
                jsr L92DF
                lda #9
                jsr L92EF
                inc L0025
                inc L0025
                jsr L92DF
                pla
                beq L9291
                cmp #$A
                beq L9291
                lda #$F
                jsr L92EF
                ldx L0023
                lda L06C6,x
                pha
                php
                lda #$52
                plp
                bpl L9288
                lda #$42

L9288:
                jsr L92FE
                pla
                and #$1F
                jsr L930A

L9291:
                lda #$13
                jsr L92EF
                ldx L0023
                lda L06C8,x
                jsr L930A
                lda #$17
                jsr L92EF
                ldx L0023
                lda L06C9,x
                jsr L930A
                lda #$1A
                jsr L92EF
                ldx L0023
                lda L06CB,x
                jsr L945A
                lda #$1F
                jsr L92EF
                ldx L0023
                lda L06CA,x
                sta L0063
                ldx #0

L92C6:
                lda L93F6,x
                bmi L92DB
                tay
                lda L93F6+1,x
                and L0063
                beq L92D7
                tya
                jsr L92FE

L92D7:
                inx
                inx
                bne L92C6

L92DB:
                lda #0
                beq L92FE

;-------------------------------------------------------------------------

L92DF:
                ldx L0025
                lda L06C2,x
                ldy L06C3,x
                ldx L0024
                jsr L9B8C
                stx L0024
                rts

;-------------------------------------------------------------------------

L92EF:
                sec
                sbc L0024
                beq rts92FB
                tax

L92F5:
                jsr L92FC
                dex
                bne L92F5

rts92FB:
                rts

;-------------------------------------------------------------------------

L92FC:
                lda #$20

;-------------------------------------------------------------------------

L92FE:
                sty L0064
                ldy L0024
                sta L0500,y
                inc L0024
                ldy L0064
                rts

;-------------------------------------------------------------------------

L930A:
                sty L0064
                sta L006E
                lda #0
                sta L006E+1
                lda #<L92FE
                ldy #>L92FE
                jsr LAEDA    ; Entry: A=LSB; X=MSB
                ldy L0064

L931B:
                sec
                rts

;-------------------------------------------------------------------------

L931D:
                ldy #0
                sty fwa_mantissa_2
                sty fwa_mantissa_3
                sty L005E
                jsr L942F
                bcs L931B
                sta L0023
                ldx #0
                stx L0024
                jsr L9407
                bcs L931B
                inc L0024
                inc L0024
                jsr L9407
                bcs L931B
                lda fwa_exponent
                cmp fwa_sign
                bcc L931B
                lda fwa_mantissa_1
                cmp fwa_overflow
                bcc L931B
                lda L0023
                beq L9375
                cmp #10
                beq L9375
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L931B
                and #$DF
                ldx #0
                cmp #'R'
                beq L9365
                cmp #'B'
                bne L931B
                ldx #$80

L9365:
                stx L0063
                iny
                jsr LAF3D
                bcs L931B
                cmp L0023
                bcs L931B
                ora L0063
                sta fwa_mantissa_2

L9375:
                jsr LAF3D
                bcs L931B
                cmp #3
                bcc L931B
                sta fwa_mantissa_4
                lda L0025
                sta L0026
                jsr LAF3D
                bcs L931B
                cmp #$10
                bcs L931B
                sta fwa_rounding
                sty L005E
                jsr L948B
                bcs L93DD
                sta fwb_overflow
                lda #0
                sta L0063

L939C:
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L93BD
                jsr toupper
                ldx #$FE

L93A6:
                inx
                inx
                ldy L93F6,x
                bmi L93DD
                cmp L93F6,x
                bne L93A6
                lda L0063
                ora L93F6+1,x
                sta L0063
                inc L005E
                bne L939C

L93BD:
                lda L0063
                ldy L0023
                cpy #$A
                bcs L93C9
                and #$CF
                bcc L93CB

L93C9:
                and #$FC

L93CB:
                php
                ldy L0025
                sty L005E
                sta fwb_sign
                and #8
                bne L93DF
                lda fwa_rounding
                cmp #2
                bcs L93DF
                plp

L93DD:
                sec
                rts

;-------------------------------------------------------------------------

L93DF:
                plp
                ldy L0026
                sty L005E
                lda #$FF
                bcs L93EA
                lda num_columns

L93EA:
                sta L0063
                lda fwa_mantissa_4
                sec
                adc fwa_rounding
                bcs L93DD
                cmp L0063
                rts

;-------------------------------------------------------------------------

L93F6:      .byte 'V'
                .byte 1
                .byte 'H'
                .byte 2
                .byte 'T'
                .byte 4
                .byte 'S'
                .byte 8
                .byte '1'
                .byte $10
                .byte '2'
                .byte $20
                .byte 'C'
                .byte $40
                .byte 'O'
; bit 7 set terminates table
                .byte $80
                .byte $80

;-------------------------------------------------------------------------

L9407:
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                sec
                beq rts9420
                sty L005E
                jsr L9D87
                bcs rts9420
                sty L005E
                ldx L0024
                lda L0066+2
                sta fwa_sign,x
                lda L0066+3
                sta fwa_overflow,x

rts9420:
                rts

;-------------------------------------------------------------------------

L9421:
                lda #<L0500
                sta L0000
                sta L0066
                lda #>L0500
                sta L0000+1
                sta L0066+1

L942D:
                sec
                rts

;-------------------------------------------------------------------------

L942F:
                jsr L9421
                ldx #0
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L942D
                and #$DF
                cmp #'P'
                bne L9448
                inc L005E
                ldx #$A
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L942D

L9448:
                stx L005F
                jsr LAF46
                bcs L942D
                adc L005F
                bcs L942D
                cmp #$14
                bcs L942D
                inc L005E
                rts

;-------------------------------------------------------------------------

L945A:
                jsr LADAA
                sta L0060
                pha
                lda #'F'        ; floating point
                rol L0060
                rol L0060
                bcc L946A
                lda #'D'        ; fixed decimal places

L946A:
                jsr L92FE
                pla
                bcc L9475    ; right justify
                and #$F
                jsr L930A

L9475:
                lda #'R'        ; right justify
                rol L0060
                bcc L947D
                lda #'L'        ; left justify

L947D:
                jsr L92FE
                lda #'M'        ; - for negative
                rol L0060
                bcc L9488
                lda #'B'        ; () for negative

L9488:
                jmp L92FE

;-------------------------------------------------------------------------

L948B:
                lda #0
                sta L0063
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L94D8

L9494:
                and #$DF
                ldx #$FE
                stx L0064

L949A:
                inx
                inx
                cmp LB091,x
                beq L94AA
                ldy LB091+2,x
                bne L949A
                bit L0064
                bvs L94D9

L94AA:
                lda LB091+1,x
                and #$F0
                sec
                bit L0063
                bne L94DA
                ora L0063
                sta L0063
                inc L005E
                lda LB091+1,x
                ror a
                bcc L94D1
                ldy L005E
                jsr LAF46
                bcs L94DA
                cmp #$A
                bcs L94DA
                ora L0063
                sta L0063
                sty L005E

L94D1:
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                bne L9494
                ldx #1

L94D8:
                clv

L94D9:
                clc

L94DA:
                php
                lda L0063
                plp
                rts

;-------------------------------------------------------------------------

L94DF:
                lda L000B
                ldy L000C
                jsr L9C0D
                jsr L97B1
                lda L000B
                ldy L000C
                jsr L9BE4
                jsr L9707
                clc
                jsr LAB8B
                lda L0054
                bne L9517
                ldx L06C1
                lda L000B
                cmp L000D
                bne L950A
                lda L000C
                cmp L000E
                beq L9511

L950A:
                lda L000D
                ldy L000E
                jsr L960F

L9511:
                jsr L9576
                jmp L9564

;-------------------------------------------------------------------------

L9517:
                lda #0

L9519:
                sta L0060
                jsr LAC72
                lda L06CA,x
                bmi L9555
                lda L0054
                bmi L9549
                lda L000B
                cmp L06C2,x
                bcc L9555
                cmp L06C4,x
                beq L9535
                bcs L9555

L9535:
                lda L000C
                cmp L06C3,x
                bcc L9555
                cmp L06C5,x
                beq L9543
                bcs L9555

L9543:
                jsr L9576
                jmp L9555

;-------------------------------------------------------------------------

L9549:
                lda L0055
                bmi L9552
                lda L06CB,x
                bpl L9555

L9552:
                jsr L957D

L9555:
                rol L06CB,x
                clc
                ror L06CB,x
                inc L0060
                lda L0060
                cmp #$A
                bcc L9519

L9564:
                lda #0
                sta L0054
                sta L0055
                lda L000B
                sta L000D
                lda L000C
                sta L000E
                rts

;-------------------------------------------------------------------------

                ldx L06C1

;-------------------------------------------------------------------------

L9576:
                lda L000B
                ldy L000C
                jmp L960F

;-------------------------------------------------------------------------

L957D:
                stx L0061
                ldy L06C7,x
                lda L0628,y
                pha
                lda L0629,y
                tay
                pla
                sty L005F
                jsr L97C1
                lda L06CA,x
                and #$C
                bne L95BB
                inc L005F
                txa
                ldy #$FF
                sec

L959D:
                sbc #$C
                iny
                bcs L959D
                tya
                ora #'0'
                jsr L96E2
                ldy L06C7,x
                lda L06C9,x
                clc
                adc L0628,y
                pha
                lda L0629,y
                tay
                pla
                jsr L97C1

L95BB:
                lda L06CA,x
                and #4
                bne L95C5
                jsr L97D8

L95C5:
                lda L06C2,x
                sta L0066
                lda L06C3,x
                sta L0066+1

L95CF:
                ldy L06C7,x
                lda L0628,y
                ldy L005F
                inc L005F
                jsr L97C1
                lda L06CA,x
                and #8
                bne L95EA
                lda L0066+1
                ldx #1
                jsr L97F4

L95EA:
                lda L0066
                ldy L0066+1
                ldx L0061
                jsr L960F
                inc L0066
                lda L0066
                cmp L06C4,x
                beq L95EA
                bcc L95EA
                lda L06C2,x
                sta L0066
                inc L0066+1
                lda L0066+1
                cmp L06C5,x
                bcc L95CF
                beq L95CF
                rts

;-------------------------------------------------------------------------

L960F:
                jsr L9837
                php
                ldy #0
                lda L006D
                sec
                sbc L06C3,x
                beq L9627
                tay
                jsr L9138
                clc
                adc #1
                jsr LAF1D

L9627:
                sta L0064
                lda L006C
                sec
                sbc L06C2,x
                clc
                adc L0064
                bcc L9635
                iny

L9635:
                clc
                adc L06CC,x
                bcc L963C
                iny

L963C:
                clc
                adc OSWHM
                sta L006A
                tya
                adc L06CD,x
                adc OSWHM+1
                sta L006B
                ldy #0
                sty L0063
                cpx L06C1
                bne L9660
                lda L006C
                cmp L000B
                bne L9660
                lda L006D
                cmp L000C
                bne L9660
                dec L0063

L9660:
                plp
                bcc L966B
                lda (L006A),y
                bne L966B
                lda L0063
                beq L96AE

L966B:
                php
                lda L006C
                ldy L006D
                jsr LAC92
                clc
                adc #1
                jsr L97C1
                lda L0063
                beq L9683
                jsr L9772
                jmp L9686

;-------------------------------------------------------------------------

L9683:
                jsr L96DC

L9686:
                ldx #0
                plp
                bcs L96AD
                ldy L002C
                beq L969A
                lda L0030

L9691:
                jsr L96E2
                dec L002B
                inx
                dey
                bne L9691

L969A:
                lda L002B
                beq L96AD

L969E:
                lda (L0006),y
                beq L96AD
                .if !handle_8_bit_input
                and #$7F
                .endif
                jsr L96E2
                iny
                inx
                dec L002B
                bne L969E

L96AD:
                txa

L96AE:
                sta L0064
                tax
                ldy #0
                lda (L006A),y
                ldy L0063
                beq L96BF
                ldx L0062
                lda L06C8,x
                tax

L96BF:
                sec
                sbc L0064
                stx L0064
                bcc L96CC
                beq L96CC
                tax
                jsr L9C31

L96CC:
                ldy #0
                lda L0064
                sta (L006A),y
                lda L0063
                beq L96D9
                jsr L9782

L96D9:
                ldx L0062
                rts

;-------------------------------------------------------------------------

L96DC:
                lda #' '
                bne L96E2

;-------------------------------------------------------------------------

L96E0:

                lda #13

L96E2:
                bit L0056
                bpl L9701
                cmp #' '
                beq L9704
                pha
                cmp #13
                bne L96F3
                lda #0
                sta L005D

L96F3:
                lda L005D
                beq L9700
                lda #' '

L96F9:
                jsr L9701
                dec L005D
                bne L96F9

L9700:
                pla

;-------------------------------------------------------------------------

L9701:
                jmp (L000F)

;-------------------------------------------------------------------------

L9704:
                inc L005D
                rts

;-------------------------------------------------------------------------

L9707:
                lda #30
                jsr OSWRCH
                jsr LAB02
                php
                lda #' '
                plp
                bcs L971D
                php
                lda #'V'
                plp
                bpl L971D
                lda #'L'

L971D:
                jsr OSWRCH
                lda #'A'
                ldx L004A
                bpl L9728
                lda #'M'

L9728:
                jsr OSWRCH
                lda #' '
                ldx L004C
                beq jmp_oswrch
                lda #'D'
                ldx L004C
                bpl jmp_oswrch
                lda #'R'
                bne jmp_oswrch

;-------------------------------------------------------------------------

L973B:
                jsr L9764
                lda #'`'        ; GBP symbol in BBC ASCII
                inx
                dex
                bne L9756
                lda #'r'
                ldx screen_mode
                cpx #7
                beq L9756
                lda #'g'
                bne L9756

L9751:
                jsr L9764
                lda #' '

L9756:
                jsr OSWRCH
                lda #0
                ldx #6

L975D:
                jsr OSWRCH
                dex
                bne L975D
                rts

;-------------------------------------------------------------------------

L9764:
                lda #23
                jsr OSWRCH
                lda #0
                jsr OSWRCH
                lda #10
                bne jmp_oswrch

L9772:
                lda #'>'
                ldx screen_mode
                cpx #7
                beq jmp_oswrch
                jsr L97A1
                lda #'>'
                bne jmp_oswrch

L9782:
                lda screen_mode
                cmp #7
                beq rts97D7
                ldx #7
                jsr set_text_colour
                ldx #$80

;-------------------------------------------------------------------------

; X=text colour to set
; Preserves: Y

set_text_colour:
                lda #17
                jsr OSWRCH
                txa

jmp_oswrch:
                jmp OSWRCH

;-------------------------------------------------------------------------

beep:
                lda #7          ; VDU beep
                bne jmp_oswrch

;-------------------------------------------------------------------------

clear_screen:
                lda #12         ; VDU clear screen
                bne jmp_oswrch

;-------------------------------------------------------------------------

L97A1:
                lda screen_mode
                cmp #7
                beq rts97D7 ; taken if teletext mode
                ldx #0          ; text foreground colour 0
                jsr set_text_colour
                ldx #$87        ; text background colour 7
                bne set_text_colour

L97B1:
                ldy #1
                lda #9
                bne gotoxy      ; move text cursor
                                ; Entry: A=X coord
                                ;        Y=Y coord

L97B7:
                ldy #3
                bne L97BD

L97BB:
                ldy #2

L97BD:
                lda #0
                beq gotoxy      ; move text cursor
                                ; Entry: A=X coord
                                ;        Y=Y coord

L97C1:
                sec
                sbc #1
                iny
                iny
                iny

;-------------------------------------------------------------------------

; move text cursor
; Entry: A=X coord
;        Y=Y coord

gotoxy:
                pha
                lda #31         ; VDU set text cursor coordinates
                jsr OSWRCH
                pla
                jsr OSWRCH
                pha
                tya
                jsr OSWRCH
                pla

rts97D7:
                rts

;-------------------------------------------------------------------------

L97D8:
                ldx L0061
                lda L06C2,x
                sta L0062

L97DF:
                lda L0062
                ldx #0
                jsr L97F4
                ldx L0061
                inc L0062
                lda L0062
                cmp L06C4,x
                bcc L97DF
                beq L97DF
                rts

;-------------------------------------------------------------------------

L97F4:
                pha
                stx L0049
                jsr L9C45
                sta L0063
                ldx L0049
                pla
                jsr LAAD3
                lda #$2E
                bcc L9808
                lda #$5F

L9808:
                pha
                lda L0061
                clc
                adc L0049
                tay
                ldx L06C8,y
                lda L0049
                bne L9817
                inx

L9817:
                txa
                dex
                ldy #1
                cmp L0063
                beq L9826
                bcc L9826
                sbc L0063
                ldx L0063
                tay

L9826:
                pla

L9827:
                jsr L96E2
                dey
                bne L9827

L982D:
                lda (L0072),y
                iny
                jsr L96E2
                dex
                bne L982D
                rts

;-------------------------------------------------------------------------

L9837:
                stx L0062
                ldx #$FF
                stx L002B
                inx
                stx L002C
                jsr LAB06
                bcs L9882
                bmi L9896
                ldy #5
                lda (L0006),y
                bpl L985C
                ldy #$FF

L984F:
                iny
                lda L98D3,y
                sta L079E,y
                bne L984F
                sty L002B
                beq L9875

L985C:
                ldx L0062
                jsr LADAA
                sta L002D
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)
                ldx L0062
                lda L06CA,x
                and #$40
                bne L98B3
                lda L06C8,x
                jsr LB2FF

L9875:
                lda #<L079E
                sta L0006
                lda #>L079E
                sta L0006+1

L987D:
                lda #$20
                sta L0030
                clc

L9882:
                php
                ldx L0062
                lda L06C8,x
                cmp L002B
                bcs L988E
                sta L002B

L988E:
                cmp L002C
                bcs L9894
                sta L002C

L9894:
                plp

rts9895:
                rts

;-------------------------------------------------------------------------

L9896:
                jsr LA158
                dey
                sty L002B
                .if handle_8_bit_input
                bra L987D
                .else
                ldy #0
                lda (L0006),y
                bpl L987D
                ldx L0062
                lda L06C8,x
                tay
                sec
                sbc L002B
                bcc L987D
                sta L002C
                sty L002B
                bcs L987D
                .endif
                
L98B3:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                php
                bpl L98BC
                jsr negate_fwa  ; !! AD7E in BASIC 2

L98BC:
                jsr LA8BA
                bcs L98C3
                lda #$FF

L98C3:
                sta L002C
                sta L002B
                lda #'*'
                plp
                bpl L98CE
                lda #'!'

L98CE:
                sta L0030
                clc
                bcc L9882    ; always taken

;-------------------------------------------------------------------------

L98D3:      .byte $3F
                .byte $45
                .byte $72
                .byte $72
                .byte $6F
                .byte $72
                .byte 0
L98DA:          .byte $D7
                .byte $FF
                .byte $FF
                .byte $FF
                .byte $FF

;-------------------------------------------------------------------------

L98DF:
                lda #3          ; OSWORD read interval timer
                ldx #<L0698
                ldy #>L0698
                jsr OSWORD
                lda L069C
                bmi rts9895
                lda #30         ; VDU home
                jsr OSWRCH
                ldx #0
                ldy #3

L98F6:
                lda #' '
                cpx L0046
                bne L98FE
                lda #'.'

L98FE:
                jsr OSWRCH
                inx
                dey
                bne L98F6
                ldx L0046
                inx
                cpx #3
                bne L990E

L990C:
                ldx #0

L990E:
                stx L0046
                ldx #<L98DA
                ldy #>L98DA
                lda #4          ; OSWORD write interval timer
                jmp OSWORD

;-------------------------------------------------------------------------

L9919:
                sec
                jsr LAB8B
                ldx #1
                stx L0066+3
                stx L0071
                dex
                txa
                ldy #$A

L9927:
                sta L0600,x
                inx
                inx
                inx
                inx
                dey
                bne L9927

L9931:
                ldx #1
                stx L0070
                stx L0066+2

L9937:
                clc
                ror L005F
                lda #$13

L993C:
                pha
                jsr LAC72
                lda L06CA,x
                bmi L997E
                pla
                pha
                sec
                sbc #$A
                asl a
                asl a
                tay
                sty L0060
                lda L0600,y
                bmi L997E
                ldy L06C7,x
                lda L0071
                cmp L0629,y
                bcc L997E
                ror L005F
                lda L0070
                cmp L0628,y
                bcc L997E
                ldy L0060
                lda L0600,y
                and #$40
                beq L9977
                lda L0070
                cmp L0603,y
                bcs L997E

L9977:
                jsr L99A0
                pla
                jmp L998C

;-------------------------------------------------------------------------

L997E:
                pla
                sec
                sbc #1
                cmp #$A
                bcs L993C
                lda L005F
                bpl L9992
                inc L0070

L998C:
                lda L0070
                cmp #$FF
                bcc L9937

L9992:
                lda escape_flag
                bmi L999A
                inc L0071
                bne L9931

L999A:
                jsr acknowledge_escape
                jmp L96E0

;-------------------------------------------------------------------------

L99A0:
                stx L0061
                lda L0071
                sec
                sbc L0066+3
                beq L99B0
                tax

L99AA:
                jsr L96E0
                dex
                bne L99AA

L99B0:
                lda L0070
                sec
                sbc L0066+2
                tax
                jsr L9C31
                ldy L0060
                ldx L0061
                lda L0600,y
                and #$40
                bne L99E4
                ora #$40
                sta L0600,y
                lda L06C2,x
                sta L0601,y
                lda L06C3,x
                sta L0602,y
                jsr LAC8A
                ldy L0060
                sta L0603,y
                lda L06CA,x
                and #4
                beq L9A28

L99E4:
                lda L0601,y
                sta L006A
                lda L0602,y
                sta L006B
                lda L06CA,x
                and #8
                bne L99FC
                lda L006B
                ldx #1
                jsr L97F4

L99FC:
                lda L006A
                ldy L006B
                ldx L0061
                jsr L9A52
                inc L006A
                lda L006A
                cmp L06C4,x
                beq L99FC
                bcc L99FC
                ldx L0060
                inc L0602,x
                ldy L0061
                lda L0602,x
                cmp L06C5,y
                bcc L9A39
                beq L9A39
                lda #$80
                sta L0600,x
                bne L9A39

L9A28:
                lda L06CA,x
                and #8
                bne L9A36
                lda L06C9,x
                tax
                jsr L9C31

L9A36:
                jsr L97D8

L9A39:
                ldx L0061
                ldy L0060
                lda L0603,y
                ldy L06C7,x
                sec
                sbc L0628,y
                adc L0070
                sta L0070
                sta L0066+2
                lda L0071
                sta L0066+3
                rts

;-------------------------------------------------------------------------

L9A52:
                pha
                jsr L96DC
                pla
                jsr L9837
                ldx L002C
                lda L002B
                sta L002C
                bcs L9AC0
                txa
                beq L9A6F
                lda L0030

L9A67:
                jsr L96E2
                dec L002B
                dex
                bne L9A67

L9A6F:
                lda #0
                tay
                sta L0063
                bit L0056
                bpl L9A9C
                ldx L0062
                lda L06CA,x
                and #$10
                beq L9A8A
                lda #$80
                sta L0063
                lda #$80
                jsr L96E2

L9A8A:
                lda L06CA,x
                and #$20
                beq L9A9C
                lda L0063
                ora #$40
                sta L0063
                lda #$81
                jsr L96E2

L9A9C:
                lda L002B
                beq L9AAE

L9AA0:
                lda (L0006),y
                beq L9AAE
                .if !handle_8_bit_input
                and #$7F
                .endif
                jsr L96E2
                iny
                dec L002B
                bne L9AA0

L9AAE:
                bit L0063
                bvc L9AB7
                lda #$81
                jsr L96E2

L9AB7:
                bit L0063
                bpl L9AC0
                lda #$80
                jsr L96E2

L9AC0:
                ldx L0062
                lda L06C8,x
                sec
                sbc L002C
                clc
                adc L002B
                tax
                jsr L9C31
                ldx L0062

rts9AD1:
                rts

;-------------------------------------------------------------------------

L9AD2:
                bit L0056
                bpl rts9AD1
                clc
                lda #6
                bne L9ADE

;-------------------------------------------------------------------------

L9ADB:
                lda #3
                sec

L9ADE:
                ror L0056
                pha
                ldx #<jmp_osasci
                ldy #>jmp_osasci
                lda L06A5
                beq L9AEE
                ldx #<L0400
                ldy #>L0400

L9AEE:
                stx L000F
                sty L000F+1
                pla
                clc
                adc L000F
                sta L006E
                bcc L9AFB
                iny

L9AFB:
                sty L006E+1
                jmp (L006E)

;-------------------------------------------------------------------------

disable_printer:
                lda #3          ; VDU disable printer
                bne jmp_osasci  ; always taken

enable_printer:
                lda #2          ; VDU enable printer

jmp_osasci:
                jmp OSASCI

;-------------------------------------------------------------------------

                jmp enable_printer

;-------------------------------------------------------------------------

                jmp disable_printer

;-------------------------------------------------------------------------

                jmp rts9B12

rts9B12:
                rts

;-------------------------------------------------------------------------

L9B13:
                jsr L9B44
                beq L9B1B

L9B18:
                jsr L9B4C

L9B1B:
                jsr LAB06
                php
                ldy #0
                plp
                bcs rts9B43
                bmi L9B28
                ldy #6

L9B28:
                lda (L0006),y
                .if !handle_8_bit_input
                and #$7F
                .endif
                beq L9B3F
                iny
                cmp #1
                bne L9B39
                jsr L9B59
                jmp L9B28

;-------------------------------------------------------------------------

L9B39:
                jsr L9BDF
                jmp L9B28

;-------------------------------------------------------------------------

L9B3F:
                jsr L9BDF
                clc

rts9B43:
                rts

;-------------------------------------------------------------------------

L9B44:
                ldx #<L9B74
                stx L006A
                ldx #>L9B74
                bne L9B52

;-------------------------------------------------------------------------

L9B4C:
                ldx #<L9B82
                stx L006A
                ldx #>L9B82

L9B52:
                stx L006B
                ldx #0
                stx L0060
                rts

;-------------------------------------------------------------------------

L9B59:
                lda (L0006),y
                pha
                iny
                lda (L0006),y
                iny
                sty L0061
                tay
                pla
                jsr L9BAC
                ldy L0061
                rts

;-------------------------------------------------------------------------

L9B6A:
                ldy #0
                tax

L9B6D:
                jsr L9BDC
                dex
                bne L9B6D
                rts

;-------------------------------------------------------------------------

L9B74:
                ldx L005F
                beq L9B7F
                inc L0060
                dec L005F
                jsr L96E2

L9B7F:
                ldx L0064
                rts

;-------------------------------------------------------------------------

L9B82:
                ldx L0060
                sta L0500,x
                inc L0060
                ldx L0064

rts9B8B:
                rts

;-------------------------------------------------------------------------

L9B8C:
                pha
                txa
                jsr L9B4C
                sta L0060
                lda L004D
                sta L0061
                sec
                ror L004D
                pla
                jsr L9BAC
                ldx L0061
                stx L004D
                ldx L0060
                rts

;-------------------------------------------------------------------------

L9BA5:
                ldx #$FF
                stx L005F

L9BA9:
                jsr L9B44

;-------------------------------------------------------------------------

L9BAC:

                tax
                tya
                pha
                txa
                jsr L9C49
                tax
                php
                bcc L9BBA
                jsr L9BD8

L9BBA:
                txa
                jsr L9B6A
                plp
                pla
                php
                jsr L9C80
                tax
                bcs L9BCC
                plp
                php
                bcc L9BD1
                clc

L9BCC:
                pla
                php
                jsr L9BD8

L9BD1:
                txa
                jsr L9B6A
                plp
                bcc rts9B8B

;-------------------------------------------------------------------------

L9BD8:
                lda #$22
                bne L9BDF

;-------------------------------------------------------------------------

L9BDC:
                lda (L0072),y
                iny

;-------------------------------------------------------------------------

L9BDF:
                stx L0064
                jmp (L006A)

;-------------------------------------------------------------------------

L9BE4:
                jsr L9C3B
                jsr L9B13
                bcc L9BFD
                ldy #$FF

L9BEE:
                iny
                inc L0060
                lda aBlank,y    ; "*Blank*"
                beq L9BFD
                jsr L96E2
                dec L005F
                bne L9BEE

L9BFD:
                lda L0047
                jsr L9C28
                sty L0047
                rts

;-------------------------------------------------------------------------

aBlank:         .text "*Blank*"
                .byte 0

;-------------------------------------------------------------------------

L9C0D:
                pha
                tya
                pha
                lda #9
                ldy #0
                jsr gotoxy      ; move text cursor
                                ; Entry: A=X coord
                                ;        Y=Y coord
                jsr L9C3B
                pla
                tay
                pla
                jsr L9BA9
                lda L0048
                jsr L9C28
                sty L0048
                rts

;-------------------------------------------------------------------------

L9C28:
                ldy L0060
                sec
                sbc L0060
                bcc rts9C3A
                tax
                inx

;-------------------------------------------------------------------------

L9C31:
                txa
                beq rts9C3A

L9C34:
                jsr L96DC
                dex
                bne L9C34

rts9C3A:
                rts

;-------------------------------------------------------------------------

L9C3B:
                pha
                lda num_columns
                sec
                sbc #10
                sta L005F
                pla
                rts

;-------------------------------------------------------------------------

L9C45:
                ldy L0049
                bne L9C80

;-------------------------------------------------------------------------

L9C49:
                sta L0063
                bit L004D
                bmi L9C56
                jsr L9CA4
                bcs rts9C7F
                lda L0063

L9C56:
                ldy #0
                sty L0066
                sec

L9C5B:
                tay
                sbc #26
                bcc L9C64
                inc L0066
                bne L9C5B

L9C64:
                tya
                adc #'A'
                sta L0066+1
                ldx #L0066+1
                ldy #1
                lda L0066
                beq L9C77
                dex
                iny
                adc #$40
                sta L0066

L9C77:
                stx L0072
                lda #0
                sta L0073
                tya
                clc

rts9C7F:
                rts

;-------------------------------------------------------------------------

L9C80:
                sta L0063
                bit L004D
                bmi L9C8D
                jsr L9CA8
                bcs rts9C7F
                lda L0063

L9C8D:
                clc
                adc #1
                ldx #0
                jsr LAEAF
                lda #<L079E
                sta L0072
                lda #>L079E
                sta L0073
                txa

L9C9E:
                clc
                rts

;-------------------------------------------------------------------------

L9CA0:
                ldx L0049
                bne L9CA8

;-------------------------------------------------------------------------

L9CA4:
                ldx #$15
                bne L9CAA

;-------------------------------------------------------------------------

L9CA8:
                ldx #$17

L9CAA:
                sta L0064
                lda 0,x
                sta L0072
                lda 1,x
                sta L0073
                ldy #0

L9CB6:
                lda (L0072),y
                cmp #$FF
                beq L9C9E
                cmp L0064
                beq L9CC5
                jsr L9CD8
                bcs L9CB6

L9CC5:
                inc L0072
                bne L9CCB
                inc L0073

L9CCB:
                dey

L9CCC:
                iny
                lda (L0072),y
                beq L9CD5
                cpy #$F
                bcc L9CCC

L9CD5:
                tya
                sec
                rts

;-------------------------------------------------------------------------

L9CD8:
                lda L0072
                clc
                adc #$10
                sta L0072
                bcc L9CE3
                inc L0073

L9CE3:
                sec
                rts

;-------------------------------------------------------------------------

L9CE5:
                ldx L0049
                bne L9CED

;-------------------------------------------------------------------------

L9CE9:
                ldx #$15
                bne L9CEF

;-------------------------------------------------------------------------

L9CED:
                ldx #L0017

L9CEF:
                ldy #0
                sty L0064

L9CF3:
                lda 0,x
                sta L0041,y
                inx
                iny
                cpy #4
                bne L9CF3

L9CFE:
                lda L0043
                sec
                sbc L0041
                sta L006A
                lda L0044
                sbc L0041+1
                sta L006B
                lsr L006B
                ror L006A
                lda L006A
                and #$F0
                sta L006A
                bne L9D1D
                lda L006B
                bne L9D1D
                inc L0064

L9D1D:
                lda L006A
                clc
                adc L0041
                sta L006A
                lda L006B
                adc L0041+1
                sta L006B
                ldy #0
                lda (L006A),y
                cmp #escape_flag
                beq L9D7D
                dey
                ldx #L000F

L9D35:
                iny
                iny
                lda (L006A),y
                beq L9D64
                jsr toupper
                sta L0065
                dey
                lda fp_slot_0,y
                jsr toupper
                cmp L0065
                bne L9D50
                dex
                bne L9D35
                beq L9D6B

L9D50:
                lda L0064
                bne L9D71
                ldx #L0041
                bcc L9D5A
                ldx #L0043

L9D5A:
                lda L006A
                ldy L006B
                sta 0,x
                sty 1,x
                bne L9CFE

L9D64:
                dey
                lda fp_slot_0,y
                sec
                bne L9D50

L9D6B:
                ldy #0
                lda (L006A),y
                clc
                rts

;-------------------------------------------------------------------------

L9D71:
                bcs L9D7D
                lda #$10
                adc L006A
                sta L006A
                bcc L9D7D
                inc L006B

L9D7D:
                sec
                rts

;-------------------------------------------------------------------------

toupper:
                jsr islower     ; entry: A=char value
                                ; exit: C=1 if lower case
                bcc rts9D86 ; taken if upper case
                and #$DF        ; convert lower case to upper case

rts9D86:
                rts

;-------------------------------------------------------------------------

L9D87:
                jsr L9E09
                bcs L9D93
                jsr L9CE9
                ldy L0063
                bcc L9DBF

L9D93:
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                jsr get_letter_index; get letter index
                                    ; Entry: A=char (A-Z, a-z)
                                    ; Exit: A=letter index (case insensitive)
                bcc L9D7D
                sta L0061
                iny
                sty L005E
                lda (L0066),y
                jsr get_letter_index; get letter index
                                    ; Entry: A=char (A-Z, a-z)
                                    ; Exit: A=letter index (case insensitive)
                bcc L9DC1
                inc L005E
                sta L0063
                ldy L0061
                iny
                lda #$1A
                jsr LAF1D
                bcs sec_rts
                adc L0063
                bcs sec_rts
                cmp #$FF
                bcs sec_rts
                ldy L005E

L9DBF:
                sta L0061

L9DC1:
                sty L005E
                jsr L9E09
                bcs L9DCF
                jsr L9CED
                ldy L0063
                bcc L9DD9

L9DCF:
                jsr LAF4F
                bcs sec_rts
                sbc #0
                bcc sec_rts
                clc

L9DD9:
                sta L0066+3
                lda L0061
                sta L0066+2
                lda (L0066),y
                rts

;-------------------------------------------------------------------------

; get letter index
; Entry: A=char (A-Z, a-z)
; Exit: A=letter index (case insensitive)

get_letter_index:
                cmp #'['        ; 'Z'+1
                bcs L9DE9    ; taken if not upper case
                sbc #$40        ; convert to 0-25
                rts

;-------------------------------------------------------------------------

L9DE9:
                jsr islower     ; entry: A=char value
                                ; exit: C=1 if lower case
                bcc rts9DFA ; taken if lower case
                sbc #'a'        ; convert to 0-25
                rts

;-------------------------------------------------------------------------

; entry: A=char value
; exit: C=1 if lower case

islower:
                cmp #'a'
                bcc rts9DFA ; taken if not lower case
                cmp #'{'        ; 'z'+1
                bcc sec_rts     ; taken if not lower case

clc_rts:
                clc

rts9DFA:
                rts

;-------------------------------------------------------------------------

; entry: A=char value
; exit: C=1 if number char: digit or '.'

isnumchar:
                cmp #'.'
                beq sec_rts

L9DFF:
                cmp #'0'
                bcc rts9E08
                cmp #':'        ; '9'+1
                bcs clc_rts

sec_rts:
                sec

rts9E08:
                rts

;-------------------------------------------------------------------------

L9E09:
                jsr L9421
                ldx #0
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq L9E21
                cmp #'"'
                bne L9E18
                iny

L9E18:
                lda (L0066),y
                beq L9E21
                iny
                cmp #'"'
                bne L9E23

L9E21:
                lda #0

L9E23:
                sta fp_slot_0,x
                clc
                beq L9E2E
                inx
                cpx #$10
                bcc L9E18

L9E2E:
                sty L0063
                rts

;-------------------------------------------------------------------------

L9E31:
                jsr L9421
                ldy #$FF

L9E36:
                iny
                lda (L0066),y
                bne L9E36
                iny
                tya
                clc
                adc #0
                sta L0070
                lda #5
                adc #0
                sta L0071
                sty L0064
                lda #$83
                sbc L0064
                bcc L9E52
                lda #0

L9E52:
                sta L0062
                ldy #0
                sty L0060

L9E58:
                sty L005E

L9E5A:
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                sty L005E
                sty L002A
                pha
                cmp #'"'
                beq L9E80
                jsr get_letter_index; get letter index
                                    ; Entry: A=char (A-Z, a-z)
                                    ; Exit: A=letter index (case insensitive)
                bcs L9E80
                jsr LB53A
                pla
                bcs L9E99

L9E71:
                ldy L005E
                cpy L002A
                beq L9E5A
                lda (L0066),y
                jsr L9EAD
                inc L005E
                bne L9E71

L9E80:
                jsr L9D87
                pla
                bcs L9E99
                sty L005E
                lda #1
                jsr L9EAD
                lda L0066+2
                jsr L9EAD
                lda L0066+3
                jsr L9EAD
                bcc L9E5A

L9E99:
                beq L9EA3
                jsr L9EAD
                ldy L002A
                iny
                bne L9E58

L9EA3:
                ldx L0070
                stx L0000
                ldx L0071
                stx L0000+1
                sta L002A

;-------------------------------------------------------------------------

L9EAD:
                dec L0062
                beq L9EB9
                ldy L0060
                sta (L0070),y
                inc L0060

L9EB7:
                clc
                rts

;-------------------------------------------------------------------------

L9EB9:
                pla
                pla
                sec

rts9EBC:
                rts

;-------------------------------------------------------------------------

L9EBD:
                sta L006C
                sty L006D

L9EC1:
                jsr LAB0A
                jsr LA158
                sty L005F
                lda L0061
                bne L9EDF
                lda L005F
                beq L9EB7
                jmp LA116

;-------------------------------------------------------------------------

L9ED4:
                lda L0006
                sta L0011
                lda L0006+1
                sta L0012
                jmp L9FA8

;-------------------------------------------------------------------------

L9EDF:
                lda L005F
                bne L9ED4
                sta L0066+1
                ldx L006D
                cpx L06BF
                bcc L9F18
                inx
                txa
                sbc L06BF
                sta L0062
                asl a
                rol L0066+1
                adc L0062
                sta L0066
                bcc L9EFE
                inc L0066+1

L9EFE:
                ldy L006C
                iny
                tya
                ldy #0
                asl a
                bcc L9F08
                iny

L9F08:
                jsr LA0ED
                bcs rts9EBC
                lda L06BF
                sta L0063
                stx L06BF
                jsr LA023

L9F18:
                jsr LAB5D
                jsr LA2F9
                tay
                lda L006C
                sec
                sbc (L006E),y
                bcc L9F7B
                adc #0
                sta L0063
                asl a
                rol L0066+1
                sta L0066
                tya
                jsr LA0ED
                bcs rts9F7A
                ldy #0
                lda (L006E),y
                bne L9F4C
                lda L001D
                sec
                sbc L0019
                iny
                sta (L006E),y
                lda L001E
                sbc L001A
                iny
                sta (L006E),y
                ldy #0

L9F4C:
                lda (L006E),y
                pha
                ldx L006C
                inx
                txa
                sta (L006E),y
                pla
                jsr LAB41
                sta L006A
                sty L006B
                jsr LA282
                ldx L0063

L9F62:
                lda #0
                tay
                dex
                beq L9F90
                sta (L006A),y
                iny
                sta (L006A),y
                lda L006A
                clc
                adc #2
                sta L006A
                bcc L9F62
                inc L006B
                bne L9F62

rts9F7A:
                rts

;-------------------------------------------------------------------------

L9F7B:
                lda #0
                tay
                jsr LA0ED
                bcs rts9F7A
                lda L006C
                jsr LAB41
                sta L006A
                sty L006B
                ldy #0
                ldx #$FF

L9F90:
                lda L001F
                sta L0011
                sec
                sbc L001B
                sta (L006A),y
                iny
                lda L001F+1
                sta L0012
                sbc L001C
                sta (L006A),y
                txa
                bne L9FA8
                jsr LA050

L9FA8:
                lda #0
                sta L0066+1
                lda L0061
                cmp L005F
                bcc L9FB4
                lda L005F

L9FB4:
                clc
                adc L0011
                sta L006A
                lda L0012
                adc #0
                sta L006B
                lda L0061
                sec
                sbc L005F
                beq LA021
                bcs L9FDA
                sta L0063
                lda #0
                sec
                sbc L0063
                sta L0066
                jsr LA240
                jsr L8DA6
                jmp L9FE7

;-------------------------------------------------------------------------

L9FDA:
                sta L0066
                lda #0
                tay
                jsr LA0F3
                bcs rtsA022
                jsr LA2A1

L9FE7:
                lda L0011
                sec
                sbc L001B
                sta L0066+2
                lda L0012
                sbc L001C
                sta L0066+3

L9FF4:
                jsr LA1F5

L9FF7:
                jsr LA1BC
                bcs LA021
                iny
                lda (L006A),y
                dey
                and #$7F
                cmp L0066+3
                bcc L9FF7
                bne LA010
                lda (L006A),y
                cmp L0066+2
                bcc L9FF7
                beq L9FF7

LA010:
                lda (L006A),y
                clc
                adc L0066
                sta (L006A),y
                iny
                lda (L006A),y
                adc L0066+1
                sta (L006A),y
                jmp L9FF7

;-------------------------------------------------------------------------

LA021:
                clc

rtsA022:
                rts

;-------------------------------------------------------------------------

LA023:
                jsr LAB5F
                lda L006E
                sta L006A
                lda L006E+1
                sta L006B
                jsr LA27E
                jsr LA0C5

LA034:
                lda #0
                tay
                sta (L006A),y
                iny
                dec L0062
                beq rtsA022
                sta (L006A),y
                iny
                sta (L006A),y
                lda L006A
                clc
                adc #3
                sta L006A
                bcc LA034
                inc L006B
                bcs LA034

;-------------------------------------------------------------------------

LA050:
                jsr LAB5D
                lda #0
                tay
                jsr LAB41
                sec
                sbc L0019
                sta L0066+2
                tya
                sbc L001A
                sta L0066+3
                lda #0
                sta L0064

LA067:
                lda L0064
                cmp L06BF
                bcs LA098
                cmp L006D
                beq LA094
                jsr LAB5F
                ldy #2
                lda (L006E),y
                dey
                cmp L0066+3
                bcc LA094
                bne LA086
                lda (L006E),y
                cmp L0066+2
                bcc LA094

LA086:
                lda L0066
                clc
                adc (L006E),y
                sta (L006E),y
                iny
                lda L0066+1
                adc (L006E),y
                sta (L006E),y

LA094:
                inc L0064
                bne LA067

LA098:
                jsr LA1F5

LA09B:
                jsr LA1BC
                bcs rtsA115
                lda L006D
                cmp L0071
                bne LA0AC
                lda L006C
                cmp L0070
                beq LA09B

LA0AC:
                iny
                lda (L006A),y
                dey
                ora (L006A),y
                beq LA09B
                lda (L006A),y
                clc
                adc L0066
                sta (L006A),y
                iny
                lda (L006A),y
                adc L0066+1
                sta (L006A),y
                jmp LA09B

;-------------------------------------------------------------------------

LA0C5:
                lda #0
                sta L0064

LA0C9:
                lda L0064
                cmp L0063
                beq rtsA115
                jsr LAB5F
                ldy #2
                lda (L006E),y
                dey
                ora (L006E),y
                beq LA0E9
                lda L0066
                clc
                adc (L006E),y
                sta (L006E),y
                iny
                lda L0066+1
                adc (L006E),y
                sta (L006E),y

LA0E9:
                inc L0064
                bne LA0C9

;-------------------------------------------------------------------------

LA0ED:
                clc
                adc L0061
                bcc LA0F3
                iny

;-------------------------------------------------------------------------

LA0F3:
                clc
                adc L0066
                pha
                tya
                adc L0066+1
                tay
                lda HIMEM
                sec
                sbc L001F
                pha
                lda HIMEM+1
                sbc L001F+1
                sta L0064
                pla
                cpy L0064
                sta L0064
                bcc LA114
                bne LA114
                pla
                pha
                cmp L0064

LA114:
                pla

rtsA115:
                rts

;-------------------------------------------------------------------------

LA116:
                jsr LAB0A
                bcs rtsA115
                jsr LA158
                sty L0066
                lda #0
                sta L0066+1
                lda L0006
                sta L006A
                lda L0006+1
                sta L006B
                jsr LA240
                jsr LAB5D
                lda L006C
                ldy #0
                jsr LAB41
                sta L006E
                sty L006E+1
                lda #0
                tay
                sta (L006E),y
                iny
                sta (L006E),y
                lda L006A
                sec
                sbc L001B
                sta L0066+2
                lda L006B
                sbc L001C
                sta L0066+3
                jsr L8DA6
                jmp L9FF4

;-------------------------------------------------------------------------

LA158:
                php
                ldy #0
                plp
                bcs rtsA170
                bmi LA162
                ldy #6

LA162:
                lda (L0006),y
                beq LA16F
                cmp #1
                bne LA16C
                iny
                iny

LA16C:
                iny
                bne LA162

LA16F:
                iny

rtsA170:
                rts

;-------------------------------------------------------------------------

LA171:
                jsr L990C
                jsr LA1F5

LA177:
                jsr LA1BC
                bcs rtsA170
                iny
                lda (L006A),y
                bmi LA177
                dey
                ora (L006A),y
                beq LA177
                lda (L006A),y
                adc L001B
                sta L0000
                iny
                lda (L006A),y
                adc L001C
                sta L0000+1
                ldy #5
                lda (L0000),y
                and #$7F
                sta (L0000),y
                iny
                sty L002A
                jsr LA4B2
                lda L0000
                sta L0006
                lda L0000+1
                sta L0006+1
                ldy #5
                lda (L0006),y
                bcs LA1B1
                ora #$80

LA1B1:
                sta (L0006),y
                jsr store_fwa   ; store FWA to (L0006)
                jsr L98DF
                jmp LA177

;-------------------------------------------------------------------------

LA1BC:
                ldy #0
                lda L004F
                beq LA1D7
                lda L006A
                clc
                adc #2
                sta L006A
                bcc LA1CD
                inc L006B

LA1CD:
                dec L004F
                beq LA1D5
                inc L0070

LA1D3:
                clc

rtsA1D4:
                rts

;-------------------------------------------------------------------------

LA1D5:
                inc L0071

LA1D7:
                sty L0070
                lda L0071
                cmp L06BF
                bcs rtsA1D4
                jsr LAB5F
                lda (L006E),y
                beq LA1D5
                sta L004F
                tya
                jsr LAB41
                sta L006A
                sty L006B
                ldy #0
                beq LA1D3

;-------------------------------------------------------------------------

LA1F5:
                lda L0019
                sta L006A
                lda L001A
                sta L006B
                lda #0
                sta L0071
                sta L004F

rtsA203:
                rts

;-------------------------------------------------------------------------

LA204:
                ldx #L001B
                bne LA23C

;-------------------------------------------------------------------------

LA208:
                ldx #L001D
                bne LA23C

;-------------------------------------------------------------------------

LA20C:
                stx L0049
                lda L000B,x
                jsr L9CA0
                bcc rtsA203

;-------------------------------------------------------------------------

LA215:
                lda L0072
                sec
                sbc #1
                sta L006A
                lda L0073
                sbc #0
                sta L006B
                jsr LA301
                ldx #L0019
                lda L0049
                bne LA23C
                ldx #L0017

LA22D:
                lda 0,x
                sec
                sbc L0066
                sta 0,x
                lda 1,x
                sbc L0066+1
                sta 1,x
                inx
                inx

LA23C:
                cpx #$1F
                bne LA22D

;-------------------------------------------------------------------------

LA240:
                lda L006A
                sta L0066+2
                clc
                adc L0066
                sta L006E
                lda L006B
                sta L0066+3
                adc L0066+1
                sta L006E+1
                lda L001F
                sec
                sbc L0066
                sta L001F
                lda L001F+1
                sbc L0066+1
                sta L001F+1
                ldy #0

LA260:
                lda (L006E),y
                sta (L0066+2),y
                lda L0066+3
                cmp L001F+1
                bne LA270
                lda L0066+2
                cmp L001F
                beq rtsA203

LA270:
                inc L006E
                bne LA276
                inc L006E+1

LA276:
                inc L0066+2
                bne LA260
                inc L0066+3
                bne LA260

;-------------------------------------------------------------------------

LA27E:
                ldx #L001B
                bne LA29D

;-------------------------------------------------------------------------

LA282:
                ldx #L001D
                bne LA29D

LA286:
                ldx #L0019
                lda L0049
                bne LA29D
                ldx #L0017

LA28E:
                lda 0,x
                clc
                adc L0066
                sta 0,x
                lda 1,x
                adc L0066+1
                sta 1,x
                inx
                inx

LA29D:
                cpx #$1F
                bcc LA28E

;-------------------------------------------------------------------------

LA2A1:
                lda L001F
                sta L0066+2
                clc
                adc L0066
                sta L006E
                sta L001F
                lda L001F+1
                sta L0066+3
                adc L0066+1
                sta L006E+1
                sta L001F+1

LA2B6:
                lda L0066+2
                sec
                sbc L006A
                tax
                lda L0066+3
                sbc L006B
                beq LA2C4
                ldx #$FF

LA2C4:
                txa
                tay
                iny
                lda L0066+2
                stx L0066+2
                sec
                sbc L0066+2
                sta L0066+2
                bcs LA2D4
                dec L0066+3

LA2D4:
                lda L006E
                stx L006E
                sec
                sbc L006E
                sta L006E
                bcs LA2E1
                dec L006E+1

LA2E1:
                dey
                lda (L0066+2),y
                sta (L006E),y
                tya
                bne LA2E1
                inx
                beq LA2B6
                rts

;-------------------------------------------------------------------------

LA2ED:
                lda HIMEM
                sec
                sbc L001F
                tax
                lda HIMEM+1
                sbc L001F+1
                tay
                rts

;-------------------------------------------------------------------------

LA2F9:
                lda #L0000
                beq LA307

LA2FD:
                lda #L0002
                bne LA307

LA301:
                lda #L000F+1
                bne LA307

LA305:
                lda #L0003

LA307:
                sta L0066
                lda #0
                sta L0066+1
                rts

;-------------------------------------------------------------------------

LA30E:
                ldy #0

;-------------------------------------------------------------------------

LA310:
                sty L0057
                ldy #0
                sty L0058
                iny
                sty L0059
                sty L005A
                lda L000B
                sta L0011
                lda L000C
                sta L0012

LA323:
                jsr LA44B

LA326:
                jsr LAD84
                .if handle_8_bit_input
                bvs LA2FB
                tax
                bmi LA323_B101
LA2FB:
                .endif
                ldy #$FF

LA32B:
                iny
                ldx LA375,y  ; fetch value from table
                inx             ; if value was $FF, now X=$00, Z=1
                beq LA34E    ; taken if end of table reached
                cmp LA375,y  ; is it the value of interest?
                bne LA32B    ; taken if not the value of interest
                tya
                cmp #$B         ; compare to the index of the $98 entry
                php
                ldy #6
                jsr L8685    ; Look up address in table and jump to that routine.
                                ; Entry: Y=table value (0/2/4/6)
                                ;        A=index in table
                plp
                bcc LA323    ; taken if it was before the $98 entry
                inc L005A
                jsr L9751
                jsr L94DF
                jmp LA323

;-------------------------------------------------------------------------

LA34E:
                .if handle_8_bit_input
                tax
                bmi LA326
LA323_B101:
                .endif
                cmp #$20
                bcc LA326
                .if handle_8_bit_input
                jsr LA34B_B101
                .else
                cmp #$7F
                .endif
                bcs LA326
                ldy L0057
                cpy #$F0
                bcs LA36F
                jsr OSWRCH
                ldx L0500,y
                sta L0500,y
                txa
                bne LA36B
                sta L0501,y

LA36B:
                inc L0057
                bne LA323

LA36F:
                jsr beep
                jmp LA323

;-------------------------------------------------------------------------

                .if handle_8_bit_input
LA34B_B101:
                cmp #$80
                bcc rtsA356
                cmp #$87
                bcs LA355
                sec
                rts

LA355:
                clc
rtsA356:
                rts
                .endif

;-------------------------------------------------------------------------

LA375:
                .byte $1B
                ; table mapping value to routine in table 6
                .byte $D
                .byte $7F
                .if handle_8_bit_input
                .byte $83
                .byte $84
                .byte $85
                .byte $88
                .byte $89
                .byte $9B
                .byte $AC
                .byte $AD
                .byte $8C
                .byte $8D
                .byte $8E
                .byte $8F
                .byte $9C
                .byte $9D
                .byte $9E
                .byte $9F
                .else
                .byte $8F
                .byte $90
                .byte $91
                .byte $94
                .byte $95
                .byte $A7
                .byte $B8
                .byte $B9
                .byte $98
                .byte $99
                .byte $9A
                .byte $9B
                .byte $A8
                .byte $A9
                .byte $AA
                .byte $AB
                .endif
; FF terminates the table
                .byte $FF

;-------------------------------------------------------------------------

LA389:
                ldy L0057
                cpy #$F0
                bcs rtsA396
                lda L0500,y
                beq rtsA396
                inc L0057

rtsA396:
                rts

;-------------------------------------------------------------------------

LA397:
                ldy L0057
                beq rtsA396
                dec L0057
                rts

;-------------------------------------------------------------------------

LA39E:
                ldx L0057
                cpx #$EA
                bcs rtsA396
                ldy L0057
                dey

LA3A7:
                iny
                lda L0500,y
                bne LA3A7
                tya
                pha
                lda L000B
                ldy L000C
                jsr L9B8C
                stx L0057
                pla
                sta L0064
                cpx L0064
                bcc LA3E8
                lda #0
                sta L0500,x
                beq LA3E8

LA3C6:
                ldy #0
                sty L0057
                rts

;-------------------------------------------------------------------------

LA3CB:
                ldy L0057
                dey

LA3CE:
                iny
                lda L0500,y
                bne LA3CE
                sty L0057
                rts

;-------------------------------------------------------------------------

LA3D7:
                ldy L0057
                beq LA3E8
                dec L0057
                lda #$20
                ldx L0500,y
                bne LA3E5
                txa

LA3E5:
                sta L0500-1,y

LA3E8:
                inc L0059
                rts

;-------------------------------------------------------------------------

LA3EB:
                lda #0
                ldy L0057
                sta L0500,y
                inc L0059
                rts

;-------------------------------------------------------------------------

LA3F5:
                sec
                bcs LA3F9

LA3F8:
                clc

LA3F9:
                pla
                php
                jsr L9751
                jsr LA4A2
                lda L005A
                beq LA40F
                lda L0011
                ldy L0012
                jsr L8D70
                jsr L94DF

LA40F:
                plp
                pla
                pla
                rts

;-------------------------------------------------------------------------

LA413:
                ldy L0057
                lda L0500,y
                beq LA424
                dey

LA41B:
                iny
                lda L0500+1,y
                sta L0500,y
                bne LA41B

LA424:
                inc L0059
                rts

;-------------------------------------------------------------------------

LA427:
                ldy L0057
                dey

LA42A:
                iny
                lda L0500,y
                bne LA42A
                cpy #$F0
                bcs LA448
                iny

LA435:
                dey
                lda L0500,y
                sta L0500+1,y
                cpy L0057
                bne LA435
                lda #$20
                sta L0500,y
                inc L0059
                rts

;-------------------------------------------------------------------------

LA448:
                jmp beep

;-------------------------------------------------------------------------

LA44B:
                lda L0058
                clc
                adc num_columns
                sta L0064
                lda L0057
                cmp L0064
                bcs LA460
                cmp L0058
                bcs LA473
                ldx L0057
                bne LA46F

LA460:
                ldx num_columns
                dex
                stx L0064
                ldx #0
                lda L0057
                sec
                sbc L0064
                bcc LA46F
                tax

LA46F:
                stx L0058
                inc L0059

LA473:
                lda L0059
                beq LA493
                jsr L9751
                jsr L97B7
                ldy L0058
                ldx num_columns

LA481:
                lda L0500,y
                bne LA48A
                lda #$20
                bne LA48B

LA48A:
                iny

LA48B:
                jsr OSWRCH
                dex
                bne LA481
                stx L0059

LA493:
                lda L0057
                sec
                sbc L0058
                ldy #3
                jsr gotoxy      ; move text cursor
                                ; Entry: A=X coord
                                ;        Y=Y coord
                ldx #1
                jmp L973B

;-------------------------------------------------------------------------

LA4A2:
                jsr L97B7
                ldx num_columns
                jmp L9C31

;-------------------------------------------------------------------------

LA4AA:
                lda L000B
                sta L0070
                lda L000C
                sta L0071

;-------------------------------------------------------------------------

LA4B2:

                tsx
                stx S_value     ; stack pointer value
                lda #1
                sta L005B
                lda HIMEM
                sta L0002
                lda HIMEM+1
                sta L0003
                jsr LA2ED
                tya
                lsr a
                pha
                txa
                ror a
                clc
                adc L001F
                sta L0008
                sta L0004
                pla
                adc L001F+1
                sta L0008+1
                sta L0005
                jsr LAA00
                sec
                ror L0028
                jsr LA74A

LA4E0:
                jsr LA97E
                bne LA4F5
                sta L0028
                bcc LA4EF
                jsr LBF5E
                jmp LA4E0

;-------------------------------------------------------------------------

LA4EF:
                jsr LBF7C
                jmp LA4E0

;-------------------------------------------------------------------------

LA4F5:
                sec
                ror L0028

LA4F8:
                ldy #0
                lda (L0008),y
                cmp L0023
                beq LA502
                bcs LA508

LA502:
                jsr LA74A
                jmp LA4E0

;-------------------------------------------------------------------------

LA508:
                iny
                lda (L0008),y
                sta L0063
                iny
                lda (L0008),y
                sta L0062
                iny
                lda (L0008),y
                beq LA51B
                bit L0062
                bpl LA57F

LA51B:
                lda L0062
                and #$20
                bne LA524
                jsr LA725

LA524:
                ldy #0
                dec L0063
                lda L0063
                jsr L8685    ; Look up address in table and jump to that routine.
                                ; Entry: Y=table value (0/2/4/6)
                                ;        A=index in table
                bit L0062
                bvs LA534
                jsr LBF7C

LA534:
                jsr LA77C
                jmp LA4F8

;-------------------------------------------------------------------------

LA53A:
                dec L005B
                pla
                pla
                sec
                rts

;-------------------------------------------------------------------------

LA540:
                jsr LA71C
                jmp add_loaded_fwb_to_fwa; !! A500 in BASIC 2

;-------------------------------------------------------------------------

LA546:
                jsr LA71C
                jmp LB9B3

;-------------------------------------------------------------------------

LA54C:
                jsr LA71C
                jmp LB7A3    ; !! A656 in BASIC 2

;-------------------------------------------------------------------------

LA552:
                jsr LA71C
                jmp LBB29    ; ?? AA55 in BASIC 2

;-------------------------------------------------------------------------

fun_sign_QQ:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq LA572
                php
                jsr LBAE8
                plp
                bpl rtsA590
                jmp negate_fwa  ; !! AD7E in BASIC 2

;-------------------------------------------------------------------------

oper_eq_QQ:
                jsr LA71C
                jsr LB27F
                bne LA572

LA56F:
                jmp LBAE8

;-------------------------------------------------------------------------

LA572:
                jmp clear_fwa

;-------------------------------------------------------------------------

oper_ne_QQ:
                jsr LA71C
                jsr LB27F
                bne LA56F
                beq LA572

LA57F:
                lda #$FF
                bne LA585    ; ??longjmp kind of thing back to main loop with A=error code

LA583:
                lda #0

LA585:
                sec             ; ??longjmp kind of thing back to main loop with A=error code
                ror L005B
                ldx S_value     ; stack pointer value
                txs
                tax
                jsr clear_fwa
                clc

rtsA590:
                rts

;-------------------------------------------------------------------------

oper_gt_QQ:
                jsr LA71C
                jsr LB27F
                jmp LA5A2

;-------------------------------------------------------------------------

oper_ge_QQ:
                jsr LA71C
                jsr LB27F
                beq LA56F

LA5A2:
                bcc LA56F
                bcs LA572

oper_le_QQ:
                jsr LA71C
                jsr LB27F
                jmp LA5B7

;-------------------------------------------------------------------------

ope_lt_QQ:
                jsr LA71C
                jsr LB27F
                beq LA572

LA5B7:
                bcc LA572
                bcs LA56F

LA5BB:
                jsr LA77C
                ldy #1
                lda (L0008),y
                cmp #$B
                beq rtsA5E4
                bne LA583

LA5C8:
                lda L0008
                clc
                adc #$B
                tax
                lda L0008+1
                adc #0
                cmp L0005
                bcc LA5DC
                bne LA57F
                cpx L0004
                bcs LA57F

LA5DC:
                ldy #$B
                lda (L0008),y
                adc #1
                sta (L0008),y

rtsA5E4:
                rts

;-------------------------------------------------------------------------

fun_lookup_QQ:
                lda #0
                sta L0061
                jsr LA7F4
                jsr LA728
                jsr store_fwa_fp_slot_0
                lda #1
                jsr LA7F4
                lda L0060
                beq LA57F
                jsr LA7D5
                jsr prepare_fp_slot_0

LA601:
                inc L0061
                jsr LA816
                bcs LA60D
                jsr LB27F
                beq LA61B

LA60D:
                ldx L0066+3
                inc L006C,x
                lda L006C,x
                cmp L0066+2
                bcc LA601
                beq LA601
                bcs LA633

LA61B:
                lda #2
                jsr LA7F4
                lda L0060
                jsr LA7D5

LA625:
                dec L0061
                beq LA638
                inc L006C,x
                lda L006C,x
                cmp L0066+2
                bcc LA625
                beq LA625

LA633:
                lda #error_lookup - error_strings; "Brackets"
                jmp LA585                     ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

LA638:
                jsr clear_fwa
                jsr LA816
                bcs LA643
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)

LA643:
                jmp LA828

;-------------------------------------------------------------------------

fun_min_QQ:
                sec
                ror L0061
                bmi LA64E

fun_max_QQ:
                clc
                ror L0061

LA64E:
                jsr LA78E
                bcc rtsA5E4
                jsr copy_fwb_to_fwa; !! A4DC in BASIC 2

LA656:
                jsr LA78E
                bcc rtsA5E4
                jsr store_fwa_fp_slot_0
                jsr copy_fwb_to_fwa; !! A4DC in BASIC 2
                jsr LB27F
                ror a
                eor L0061
                bpl LA656
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)
                jmp LA656

;-------------------------------------------------------------------------

fun_average_QQ:
                lda #0
                sta L0061
                jsr clear_fwa

LA676:
                jsr LA78E
                bcc LA685
                jsr LB9E8    ; ?? A385 in BASIC 2
                inc L0061
                bne LA676
                jmp LBFFB

;-------------------------------------------------------------------------

LA685:
                jsr store_fwa_fp_slot_0
                lda L0061
                jsr LB731    ; !! A2ED in BASIC 2
                jmp LBB16

;-------------------------------------------------------------------------

fun_row_QQ:
                ldx L0071
                jmp LA697

;-------------------------------------------------------------------------

fun_col_QQ:
                ldx L0070

LA697:
                inx
                txa
                jmp LB731    ; !! A2ED in BASIC 2

;-------------------------------------------------------------------------

fun_choose_QQ:
                lda #0
                jsr LA7F4
                jsr LA728
                jsr LA8AE
                jmp LA6BD

;-------------------------------------------------------------------------

fun_if_QQ:
                lda #0
                jsr LA7F4
                jsr LA728
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                php
                lda #1
                plp
                bne LA6BD
                lda #2

LA6BD:
                jsr LA7F4
                jsr LA728
                jmp LA828

;-------------------------------------------------------------------------

fun_read_QQ:
                jsr LA860
                jsr LA8DF
                lda L0072
                ldy L0073
                jsr LA878
                ldy L0060
                lda #0
                jsr LA938
                jsr LA713
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)
                jmp LA828

;-------------------------------------------------------------------------

fun_write_QQ:
                lda #3
                jsr LA7F4
                jsr LA728
                jsr store_fwa_fp_slot_3
                jsr LA860
                jsr LA8DF
                jsr load_fwa_fp_slot_3
                jsr LA713
                jsr store_fwa   ; store FWA to (L0006)
                lda #$FF
                sta L069D
                lda L0072
                ldy L0073
                jsr LA878
                ldy L0060
                lda #$80
                jsr LA938
                jmp LA828

;-------------------------------------------------------------------------

LA713:
                lda #<L0698
                sta L0006
                lda #>L0698
                sta L0006+1
                rts

;-------------------------------------------------------------------------

LA71C:
                jsr store_fwa_fp_slot_0
                jsr LA725
                jmp prepare_fp_slot_0

;-------------------------------------------------------------------------

LA725:
                jsr LBFA8

LA728:
                lda L0060
                bne LA72F
                jmp load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)

;-------------------------------------------------------------------------

LA72F:
                jsr LA7D5
                jsr clear_fwa

LA735:
                txa
                pha
                jsr LA816
                bcs LA73F
                jsr add_loaded_fwb_to_fwa; !! A500 in BASIC 2

LA73F:
                pla
                tax
                lda L006C,x
                inc L006C,x
                cmp L0066+2
                bne LA735
                rts

;-------------------------------------------------------------------------

LA74A:
                lda L0008
                sec
                sbc #4
                sta L0008
                bcs LA755
                dec L0008+1

LA755:
                ldy L0008+1
                cpy L001F+1
                bcc LA779
                bne LA763
                cmp L001F
                bcc LA779
                beq LA779

LA763:
                ldy #0
                lda L0024
                sta (L0008),y
                iny
                lda L0025
                sta (L0008),y
                iny
                lda L0026
                sta (L0008),y
                iny
                lda #0
                sta (L0008),y
                rts

;-------------------------------------------------------------------------

LA779:
                jmp LBFFB

;-------------------------------------------------------------------------

LA77C:
                lda L0008
                clc
                adc #4
                sta L0008
                bcc LA787
                inc L0008+1

LA787:
                clc
                rts

;-------------------------------------------------------------------------

LA789:
                rol L0027
                clc
                ror L0027

;-------------------------------------------------------------------------

LA78E:

                ldx L0027
                ldy #3
                lda (L0008),y
                bmi LA79B
                tax
                lda #$FF
                sta (L0008),y

LA79B:
                txa
                bmi LA7BC
                eor #$7F
                beq LA787
                dex
                txa
                and #$7F
                sta L0027
                jsr LBFA8
                lda L0060
                bne LA7B4
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)
                sec
                rts

;-------------------------------------------------------------------------

LA7B4:
                jsr LA7D5
                rol L0027
                sec
                ror L0027

LA7BC:
                ldx L0066+3
                lda L0066+2
                cmp L006C,x
                bcc LA789
                jsr fwb_clear   ; Clear FWB
                                ; !! A453 in BASIC 2
                jsr LA816
                bcs LA7CF
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)

LA7CF:
                ldx L0066+3
                inc L006C,x

LA7D3:
                sec

rtsA7D4:
                rts

;-------------------------------------------------------------------------

LA7D5:
                ldy #0
                lda (L0006),y
                sta L006C
                iny
                lda (L0006),y
                sta L006D
                ldx #0
                dey
                lda (L0006),y
                ldy #2
                cmp (L0006),y
                bne LA7ED
                inx
                iny

LA7ED:
                lda (L0006),y
                sta L0066+2
                stx L0066+3
                rts

;-------------------------------------------------------------------------

LA7F4:
                sta L0064
                ldy #3
                lda (L0008),y
                cmp L0064
                beq LA800
                bcc LA812

LA800:
                sbc L0064
                jsr LA83B
                ldy #0
                lda (L0006),y
                sta L0060
                inc L0006
                bne rtsA811
                inc L0006+1

rtsA811:
                rts

;-------------------------------------------------------------------------

LA812:
                lda #$87
                bne LA825

;-------------------------------------------------------------------------

LA816:

                jsr LAB0A
                bcs LA7D3
                bmi LA7D3
                ldy #5
                lda (L0006),y
                bpl rtsA7D4
                lda #error_propagated - error_strings; "Brackets"

LA825:
                jmp LA585    ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

LA828:
                ldy #3
                lda (L0008),y
                clc
                adc #1
                jsr LA83B
                lda L0006
                sta L0002
                lda L0006+1
                sta L0003
                rts

;-------------------------------------------------------------------------

LA83B:
                sta L0064
                ldx L0002
                stx L0006
                ldx L0003
                stx L0006+1
                ldy #0
                tax
                beq rtsA85F

LA84A:
                ldx #5
                lda (L0006),y
                bne LA851
                inx

LA851:
                txa
                clc
                adc L0006
                sta L0006
                bcc LA85B
                inc L0006+1

LA85B:
                dec L0064
                bne LA84A

rtsA85F:
                rts

;-------------------------------------------------------------------------

LA860:
                ldy #2

LA862:
                sty L005F
                tya
                jsr LA7F4
                jsr LA728
                jsr LA8AE
                ldy L005F
                dey
                bmi rtsA85F
                sta L0072,y
                bpl LA862

;-------------------------------------------------------------------------

LA878:
                cmp L07EE,x
                beq LA87F
                bcs LA8B5

LA87F:
                sta L0063
                tya
                cmp L07EF,x
                beq LA889
                bcs LA8B5

LA889:
                dec L0063
                lda L07EE,x
                dey

;-------------------------------------------------------------------------

LA88F:
                jsr LAF1D
                sec
                adc L0063
                bcc LA898
                iny

LA898:
                sty L0066+1
                asl a
                rol L0066+1
                sta L0064
                ldy L0066+1
                asl a
                rol L0066+1
                adc L0064
                sta L0066
                tya
                adc L0066+1
                sta L0066+1
                rts

;-------------------------------------------------------------------------

LA8AE:
                jsr LA8BD
                beq LA8B5
                bcs rtsA8CC

LA8B5:
                lda #error_out_of_range - error_strings; "Brackets"
                jmp LA585                           ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

LA8BA:
                tsx
                stx S_value     ; stack pointer value

LA8BD:
                jsr convert_fwa_to_integer; convert FWA to int. Result is in FWA mantissa.
                                          ; !! A3FE in BASIC 2
                clc
                lda fwa_mantissa_1
                ora fwa_mantissa_2
                ora fwa_mantissa_3
                bne rtsA8CC
                lda fwa_mantissa_4
                sec

rtsA8CC:
                rts

;-------------------------------------------------------------------------

LA8CD:
                lda #0          ; OSFIND close file
                jsr OSFIND
                lda #error_bad_file - error_strings; "Brackets"
                bne LA8DC                       ; always taken

raise_fs_error:
                lda #error_fs_error - error_strings; "Brackets"
                bne LA8DC                       ; always taken

LA8DA:
                lda #error_no_file - error_strings; "Brackets"

LA8DC:
                jmp LA585    ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

LA8DF:

                pha
                jsr is_ROM_FS   ; Exit: Z=1 if ROM FS
                bcc raise_fs_error
                pla
                ldx #0

LA8E8:
                ldy L07EC,x
                beq LA8FE
                cmp L07ED,x
                beq LA935
                inx
                inx
                inx
                inx
                cpx #$14
                bne LA8E8
                lda #$55
                bne LA8DC    ; always taken

LA8FE:
                stx L0061
                sta L0060
                jsr LA961
                lda #$C0        ; OSFIND open for update
                ldx #<L079E
                ldy #>L079E
                jsr OSFIND
                tay
                beq LA8DA
                jsr LA2F9
                jsr LA938
                lda L0698
                cmp #$AA
                bne LA8CD
                ldx L0061
                lda L0060
                sta L07ED,x
                tya
                sta L07EC,x
                lda L0699
                sta L07EE,x
                lda L069A
                sta L07EF,x

LA935:
                sty L0060
                rts

;-------------------------------------------------------------------------

LA938:
                sta L0063
                lda #0
                sta L0066+2
                sta L0066+3
                lda #1          ; OSARGS write sequential pointer of file
                ldx #L0066    ; address of sequential pointer
                jsr OSARGS
                ldx #5
                bit L0063
                bpl LA957

LA94D:
                lda L0698,x
                jsr OSBPUT
                dex
                bpl LA94D
                rts

;-------------------------------------------------------------------------

LA957:
                jsr OSBGET
                sta L0698,x
                dex
                bpl LA957
                rts

;-------------------------------------------------------------------------

LA961:
                pha
                ldx #0

LA964:
                lda LA979,x
                bmi LA96F
                sta L079E,x
                inx
                bne LA964

LA96F:
                pla
                jsr LAEAF
                lda #13
                sta L079E,x
                rts

;-------------------------------------------------------------------------

LA979:      .byte 'V'
                .byte '.'
                .byte 'V'
                .byte 'S'
                .byte $FF

;-------------------------------------------------------------------------

LA97E:
                sec
                ror L0061
                ldy L002A
                lda (L0000),y
                beq LAA00
                cmp #1
                beq LA9B7
                jsr isnumchar   ; entry: A=char value
                                ; exit: C=1 if number char: digit or '.'
                bcs LA9F3    ; taken if number char, digit, or '.'
                jsr get_letter_index; get letter index
                                    ; Entry: A=char (A-Z, a-z)
                                    ; Exit: A=letter index (case insensitive)
                ror L0061
                ldx #$FF

LA997:
                ldy L002A
                dey

LA99A:
                inx
                iny
                lda LAF99,x ; fetch name byte
                beq LA9F8    ; taken if table exhausted
                bmi LAA07    ; taken if end of name
                lda (L0000),y  ; fetch input char??
                jsr toupper
                cmp LAF99,x ; matches name byte?
                beq LA99A    ; taken if name byte matched - keep going
; skip table bytes until MSB set

LA9AD:
                inx
                lda LAF99,x
                bpl LA9AD
; skip 2 more metadata bytes
                inx
                inx
                bne LA997

LA9B7:
                jsr LAA50
                sta L006D
                lda (L0000),y
                cmp #1
                bne LA9DF
                lda L006D
                stx L0066
                sta L0066+1
                jsr LAA50
                cpx L0066
                bcc LA9FB
                stx L0066+2
                cmp L0066+1
                bcc LA9FB
                beq LA9DB
                cpx L0066
                bne LA9FB

LA9DB:
                sta L0066+3
                bcs LA9EF

LA9DF:
                stx L006C
                jsr LA816
                bcc LA9EB
                jsr clear_fwa
                bcs LA9EE

LA9EB:
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)

LA9EE:
                clc

LA9EF:
                lda #0
                beq LAA35

LA9F3:
                jsr LB53D
                bcc LA9EF

LA9F8:
                jmp LA57F

;-------------------------------------------------------------------------

LA9FB:
                lda #error_range - error_strings; "Brackets"
                jmp LA585                    ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

LAA00:
                clc
                ror L0061
                ldx #$E2
                bne LAA09    ; always taken

LAA07:
                sty L002A

LAA09:
                lda LAF99+2,x
                bpl LAA1F
                and #$7F
                ldy L0028
                bpl LAA1F
                ldy L0024
                cpy #$F
                bcs LAA1F
                adc #$E1
                tax
                bcc LAA09

LAA1F:
                sta L0025
                lda LAF99+1,x
                pha
                and #$E0
                sta L0026
                pla
                and #$1F
                sta L0023
                lda LAF99,x
                and #$7F
                sta L0024

LAA35:
                php
                bit L0061
                bpl LAA4E
                pha
                ldy L002A
                lda (L0000),y
                cmp #1
                beq LA9F8
                jsr isnumchar   ; entry: A=char value
                                ; exit: C=1 if number char: digit or '.'
                bcs LA9F8
                jsr get_letter_index; get letter index
                                    ; Entry: A=char (A-Z, a-z)
                                    ; Exit: A=letter index (case insensitive)
                bcs LA9F8
                pla

LAA4E:
                plp
                rts

;-------------------------------------------------------------------------

LAA50:
                iny
                lda (L0000),y
                tax
                iny
                lda (L0000),y
                iny
                sty L002A
                rts

;-------------------------------------------------------------------------

LAA5B:
                jsr LAAA4
                ldx L0064

LAA60:
                rol L07AC,x
                inx
                dec L0063
                bne LAA60
                ldx L0064
                lda #0
                tay

LAA6D:
                ror L07AC,x
                ror a
                iny
                dec L0062
                bpl LAA6D
                clc

LAA77:
                rol L07AC,x
                rol a
                dey
                bne LAA77

rtsAA7E:
                rts

;-------------------------------------------------------------------------

LAA7F:
                jsr LAAA4
                tax
                clc

LAA84:
                ror L07AB,x
                dex
                dec L0063
                bne LAA84
                lda #0
                tay

LAA8F:
                dec L0062
                bmi LAA9A
                ror a
                ror L07AC,x
                iny
                bne LAA8F

LAA9A:
                dey
                bmi rtsAA7E
                rol a
                rol L07AC,x
                jmp LAA9A

;-------------------------------------------------------------------------

LAAA4:
                stx L0049
                lda L000B,x
                jsr LAAE2
                stx L0062
                sty L0064
                lda #$20
                ldx L0049
                beq LAAB6
                asl a

LAAB6:
                tay
                sec
                sbc L0064
                sta L0063
                tya
                rts

;-------------------------------------------------------------------------

LAABE:
                lda L000B
                ldy L000C

LAAC2:
                sta L006C
                sty L006D
                ldx #0
                lda L006C,x
                jsr LAAD3
                bcs rtsAAE1
                ldx #1
                lda L006C,x

;-------------------------------------------------------------------------

LAAD3:
                jsr LAAE2
                ldx L004E
                bne LAAE0
                sec
                and L07AC,y
                bne rtsAAE1

LAAE0:
                clc

rtsAAE1:
                rts

;-------------------------------------------------------------------------

LAAE2:
                pha
                txa
                beq LAAE8
                lda #$20

LAAE8:
                sta L0064
                pla
                pha
                lsr a
                lsr a
                lsr a
                clc
                adc L0064
                tay
                pla
                and #7
                sta L0064
                tax
                lda #1

LAAFB:
                asl a
                dec L0064
                bpl LAAFB
                ror a
                rts

;-------------------------------------------------------------------------

LAB02:
                lda L000B
                ldy L000C

;-------------------------------------------------------------------------

LAB06:
                sta L006C
                sty L006D

LAB0A:
                lda L006D
                cmp L06BF
                bcs rtsAB40
                jsr LAB5F
                ldy #0
                lda L006C
                cmp (L006E),y
                bcs rtsAB40
                jsr LAB41
                sta L006E
                sty L006E+1
                ldy #1
                lda (L006E),y
                dey
                ora (L006E),y
                sec
                beq rtsAB40
                lda (L006E),y
                clc
                adc L001B
                sta L0006
                iny
                lda (L006E),y
                php
                and #$7F
                adc L001C
                sta L0006+1
                plp
                clc

rtsAB40:
                rts

;-------------------------------------------------------------------------

LAB41:
                pha
                iny
                iny
                lda (L006E),y
                tax
                pla
                asl a
                bcc LAB4C
                inx

LAB4C:
                dey
                clc
                adc (L006E),y
                bcc LAB53
                inx

LAB53:
                clc
                adc L0019
                pha
                txa
                adc L001A
                tay
                pla
                rts

;-------------------------------------------------------------------------

LAB5D:
                lda L006D

;-------------------------------------------------------------------------

LAB5F:
                sta L0065
                lda #0
                sta L006E+1
                lda L0065
                asl a
                rol L006E+1
                adc L0065
                bcc LAB70
                inc L006E+1

LAB70:
                clc
                adc L0019
                sta L006E
                lda L006E+1
                adc L001A
                sta L006E+1
                rts

;-------------------------------------------------------------------------

LAB7C:
                ldy #1
                lda (L006E),y
                and #$7F
                ldx L004B
                bpl LAB88
                ora #$80

LAB88:
                sta (L006E),y
                rts

;-------------------------------------------------------------------------

LAB8B:
                ldx #$A
                stx L0060
                lda #0
                bcc LAB94
                txa

LAB94:
                ror L005F
                ldx #1
                stx L006C
                stx L006D

LAB9C:
                pha
                jsr LAC72
                pla
                stx L0061
                pha
                cmp #$A
                bcc LABAA
                sbc #$A

LABAA:
                asl a
                sta L06C7,x
                tay
                lda L006C
                sta L0628,y
                lda L006D
                sta L0629,y

LABB9:
                ldx L0061
                jsr LAC8A
                bcs LABCD
                bit L005F
                bmi LABDA
                cmp num_columns
                bcs LABCD
                cpy num_rows    ; (num displays rows minus 3)
                bcc LABDA
                inx

LABCD:
                lda L06C4,x
                cmp L06C2,x
                beq LAC2F
                dec L06C4,x
                bcs LABB9

LABDA:
                sta L0066+2
                sty L0066+3
                pla
                pha
                cmp #$A
                bcc LABE6
                sbc #$A

LABE6:
                pha

LABE7:
                pla

LABE8:
                sec
                sbc #1
                bcc LAC34
                pha
                bit L005F
                bpl LABF4
                adc #9

LABF4:
                jsr LAC72
                jsr LAC8A
                sta L0063
                sty L0064
                ldy L06C7,x
                ldx L0061
                cmp L006C
                beq LAC09
                bcc LABE7

LAC09:
                lda L0628,y
                cmp L0066+2
                beq LAC12
                bcs LABE7

LAC12:
                cmp L006C
                bcs LAC1D
                lda L0063
                cmp L0066+2
                bcc LAC1D
                inx

LAC1D:
                lda L0629,y
                cmp L0066+3
                beq LAC26
                bcs LABE7

LAC26:
                pla
                ldy L0064
                cpy L006D
                bcs LABCD
                bcc LABE8

LAC2F:
                ldx L0061
                jsr LAEA7

LAC34:
                pla
                clc
                adc #1
                dec L0060
                beq rtsAC89
                pha
                jsr LAC72
                lda L06C6,x
                php
                and #$1F
                bit L005F
                bpl LAC4D
                clc
                adc #$A

LAC4D:
                jsr LAC72
                jsr LAC8A
                sta L006C
                sty L006D
                ldy L06C7,x
                ldx #0
                plp
                bmi LAC61
                inx
                iny

LAC61:
                lda L0628,y
                sta L006C,x
                txa
                eor #1
                tax
                inc L006C,x
                inc L006C,x
                pla
                jmp LAB9C

;-------------------------------------------------------------------------

LAC72:
                cmp #$A
                bcs LAC7D
                asl a
                asl a
                sta L0064
                asl a
                bcc LAC86

LAC7D:
                sbc #$A
                asl a
                sta L0064
                asl a
                asl a
                adc #$78

LAC86:
                adc L0064
                tax

rtsAC89:
                rts

;-------------------------------------------------------------------------

LAC8A:
                ldy L06C4,x
                iny
                tya
                ldy L06C5,x

LAC92:
                sty L0028
                sec
                sbc L06C2,x
                ldy L06C8,x
                iny
                jsr LAF1D
                sta L0064
                bcs rtsACD8
                lda L06CA,x
                and #8
                bne LACAD
                ldy L06C9,x

LACAD:
                tya
                clc
                adc L0064
                bcs rtsACD8
                ldy L06C7,x
                adc L0628,y
                bcs rtsACD8
                sbc #0
                pha
                lda L0028
                sec
                sbc L06C3,x
                clc
                adc L0629,y
                bcs LACD5
                tay
                lda L06CA,x
                and #4
                bne LACD7
                iny
                bne LACD7

LACD5:
                sec
                inx

LACD7:
                pla

rtsACD8:
                rts

;-------------------------------------------------------------------------

LACD9:
                lda #$FF
                sta L0062
                tax

LACDE:
                ldy L005E
                dey
                inc L0062

LACE3:
                inx
                iny
                lda (L0066),y ; fetch input char
                and #$DF        ; convert to upper case
                sta L0064     ; save upper case input char
                lda commands,x  ; fetch next table byte
                beq LAD3A    ; taken if 0 - return with C=1
                bmi LAD10    ; taken if bit 7 set - more input byte processing
                eor #$5B        ; ???
                sta L0063     ; save EOR'd table byte
                and #$DF        ; convert to upper case
                cmp L0064     ; does it match?
                beq LACE3

LACFC:
                inx
                lda commands,x  ; obfuscated somewhat - all EOR'd with $5B
                beq LAD3A
                bpl LACFC
                lda L0063
                and #$20
                beq LACDE
                lda (L0066),y
                cmp #'0'
                bcs LACDE

LAD10:
                lda (L0066),y
                cmp #'A'
                bcs LAD3A
                cmp #'0'
                bcs LAD1F
                cmp #' '
                bcc LAD1F
                iny

LAD1F:
                sty L005E
                ldy L0062
                lda commands,x  ; obfuscated somewhat - all EOR'd with $5B
                clc
                rts

;-------------------------------------------------------------------------

LAD28:
                ldy #0
                beq LAD30

LAD2C:
                jsr OSWRCH
                iny

LAD30:
                lda asc_8009,y  ; "ViewSheet"
                bne LAD2C
                lda #' '
                dex
                bpl LAD2C

LAD3A:
                sec
                rts

;-------------------------------------------------------------------------

LAD3C:
                pha
                lda L0050
                beq LAD4C
                and #$7F
                tax
                jsr L97BB
                sta L0050
                jsr L9C31

LAD4C:
                pla
                rts

;-------------------------------------------------------------------------

; !! A=something...

LAD4E:
                pha
                jsr beep
                pla

LAD53:
                jsr LAD3C
                sta L0050
                jsr L97BB

; fall through to print_following_string

;-------------------------------------------------------------------------

; print 0-terminated string following call
; (if char bit 7 set, jump to command_loop)

print_following_string:

                pla
                clc
                adc #1
                sta L0066+2
                pla
                adc #0
                sta L0066+3
                ldy #0
                beq fetch_char  ; taken first time round loop

print_fetched_char:
                jsr OSASCI
                iny

fetch_char:
                lda (L0066+2),y
                bmi LAD81    ; taken if input byte has bit 7 set
                bne print_fetched_char; taken if input byte non-0
                tya
                sec
                adc L0066+2
                sta L0066+2
                bcc LAD7E
                inc L0066+3

LAD7E:
                jmp (L0066+2)

;-------------------------------------------------------------------------

LAD81:
                jmp command_loop

;-------------------------------------------------------------------------

LAD84:
                jsr flush_input_buffer
                jsr OSRDCH
                cmp #27
                .if handle_8_bit_input
                beq LAD7D
                clv
                cmp #0
                bne LAD7B
                jsr OSRDCH
                bit LAD83       ; set V flag
LAD7B:
                clc
                rts
LAD7D:
                jsr acknowledge_escape
                sec
                clv
                rts

LAD83:
                .byte $40
                .else
                bne LADF9
                .endif

;-------------------------------------------------------------------------

acknowledge_escape:
                pha
                .if cmos_instructions
                phx
                phy
                .else
                txa
                pha
                tya
                pha
                .endif
                ldx #0
                ldy #0
                lda #$7E        ; OSBYTE acknowledge ESCAPE
                jsr OSBYTE
                .if !handle_8_bit_input
                sec
                .endif

ply_plx_pla_rts:
                .if cmos_instructions
                ply
                .else
                pla
                tay
                .endif

plx_pla_rts:
                .if cmos_instructions
                plx
                .else
                pla
                tax
                .endif

pla_rts:
                pla
                rts

;-------------------------------------------------------------------------

flush_input_buffer:
                lda #$15        ; OSBYTE flush specific buffer
                ldx #0          ; 0 = input buffer
                jmp OSBYTE

;-------------------------------------------------------------------------

LADAA:
                pha
                and #$7F
                eor #$7F
                bne pla_rts
                pla
                lda L06CB,x
                and #$7F
                rts

;-------------------------------------------------------------------------

; if no sheet in memory, print "No sheet" and return with C=1??

LADB8:

                jsr LADD5
                beq rtsADCE
                jsr OSNEWL

LADC0:
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aNoSheet:       .text "No sheet"
                .byte $D
                .byte 0

;-------------------------------------------------------------------------

                sec

rtsADCE:
                rts

;-------------------------------------------------------------------------

LADCF:

                jsr LADD5
                bne LADC0
                rts

;-------------------------------------------------------------------------

LADD5:
                lda L0015
                sec
                sbc #1
                sta L006E
                lda L0016
                sbc #0
                sta L006E+1
                ldy #0
                lda (L001F),y
                cmp #$FF
                bne rtsADFA
                lda #$DD
                cmp L0683
                bne rtsADFA
                cmp (L006E),y
                bne rtsADFA
                cmp L000A
                bne rtsADFA

LADF9:
                clc

rtsADFA:
                rts

;-------------------------------------------------------------------------

LADFB:
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aEditing:       .text "Editing "
                .byte 0

;-------------------------------------------------------------------------

                lda L0051
                beq LAE19
                ldy #$FF

LAE0D:
                iny
                lda L06B2,y
                jsr OSASCI
                cmp #$D
                bne LAE0D
                rts

;-------------------------------------------------------------------------

LAE19:
                jsr print_following_string; print 0-terminated string following call
                                          ; (if char bit 7 set, jump to command_loop)

;-------------------------------------------------------------------------

aNoFile:        .text "No File"
                .byte $D
                .byte 0

;-------------------------------------------------------------------------

                rts

;-------------------------------------------------------------------------

LAE26:
                sta screen_mode
                lda #22         ; VDU select screen mode
                jsr OSWRCH
                lda screen_mode
                jsr OSWRCH

;-------------------------------------------------------------------------

LAE34:
                lda #$87        ; OSBYTE read character at text cursor position
                jsr OSBYTE
                sty screen_mode ; save graphics mode number
                lda #$84        ; OSBYTE read HIMEM
                jsr OSBYTE
                stx HIMEM
                sty HIMEM+1
                lda #$A0        ; OSBYTE read VDU variable value
                ldx #9          ; VDU variable 9: bottom row of text window
                                ; VDU variable 10: right column of text window
                jsr OSBYTE
                iny
                sty num_columns
                dex
                dex
                dex
                stx num_rows    ; (num displays rows minus 3)
                lda #$A3        ; OSBYTE Application Support
                ldx #$FF        ; $ff = View family
                stx is_second_processor; 0 if host, non-0 if parasite
                ldy #2                 ; 2=read ViewSheet's ROM workspace byte
                jsr OSBYTE
                ldx #0
                cpy #2
                .if !B101
                beq LAE70
                .endif
                lda #$82        ; OSBYTE read machine higher order address
                jsr OSBYTE
                iny             ; Y=0 if I/O processor
                bne rtsAE72 ; taken if parasite
                inx             ; X=0 if I/O processor
                bne rtsAE72 ; taken if parasite

LAE70:
                stx is_second_processor; store 0

rtsAE72:
                rts

;-------------------------------------------------------------------------

LAE73:
                ldy #9

;-------------------------------------------------------------------------

LAE75:
                tya
                jsr LAC72
                jsr LAEA7
                dey
                bne LAE75
                tya
                sta L06C1
                sta L000B
                sta L000C
                ldx #$B

LAE89:
                sta L06C2,x
                dex
                bpl LAE89
                inx
                lda #$64
                sta L06C4,x
                sta L06C5,x
                lda #7
                sta L06C8,x
                sta L06C9,x
                rts

;-------------------------------------------------------------------------

LAEA1:
                rol L06CA,x
                clc
                bcc LAEAB

;-------------------------------------------------------------------------

LAEA7:
                rol L06CA,x
                sec

LAEAB:
                ror L06CA,x
                rts

;-------------------------------------------------------------------------

LAEAF:
                sta L006E
                lda #0
                sta L006E+1
                stx L0064
                lda #<LAEC1
                ldy #>LAEC1
                jsr LAEDA    ; Entry: A=LSB; X=MSB
                ldx L0064
                rts

;-------------------------------------------------------------------------

LAEC1:
                pha
                txa
                pha
                tsx
                lda $102,x
                ldx L0064
                sta L079E,x
                inc L0064
                jmp plx_pla_rts

;-------------------------------------------------------------------------

LAED2:
                stx L006E
                sty L006E+1
                lda #<OSWRCH
                ldy #>OSWRCH

LAEDA:
                sta L0041     ; Entry: A=LSB; X=MSB
                sty L0041+1
                ldy #6
                sec
                ror L0063

LAEE3:
                ldx #0

LAEE5:
                lda L006E+1
                cmp LB084+1,y
                bcc LAF06
                bne LAEF5
                lda L006E
                cmp LB084,y
                bcc LAF06

LAEF5:
                lda L006E
                sbc LB084,y
                sta L006E
                lda L006E+1
                sbc LB084+1,y
                sta L006E+1
                inx
                bne LAEE5

LAF06:
                txa
                bne LAF0D
                ldx L0063
                bmi LAF12

LAF0D:
                ror L0063
                jsr LAF18

LAF12:
                dey
                dey
                bpl LAEE3
                lda L006E

;-------------------------------------------------------------------------

LAF18:
                ora #'0'
                jmp (L0041)

;-------------------------------------------------------------------------

LAF1D:
                sta L0064
                sty L006E
                lda #0
                sta L006E+1
                ldy #8

LAF27:
                asl a
                rol L006E+1
                asl L0064
                bcc LAF35
                clc
                adc L006E
                bcc LAF35
                inc L006E+1

LAF35:
                dey
                bne LAF27
                ldy L006E+1
                cpy #1
                rts

;-------------------------------------------------------------------------

LAF3D:
                sty L005E
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                beq LAF54
                sty L0025

;-------------------------------------------------------------------------

LAF46:
                jsr LAF56
                beq LAF54
                cpx #1
                tax
                rts

;-------------------------------------------------------------------------

LAF4F:
                jsr skip_chars  ; jump to next CR/space/0
                                ; entry: (L0066) = string address
                                ;        ?L005E = string offset
                                ; exit: BEQ if CR/space/0
                bne LAF46

LAF54:
                sec
                rts

;-------------------------------------------------------------------------

LAF56:
                lda #0
                tax
                sta L006E
                sta L006E+1

LAF5D:
                lda (L0000),y
                sec
                sbc #'0'
                bcc LAF91
                cmp #$A
                bcs LAF91
                iny
                sta L0064
                asl L006E
                rol L006E+1
                ldx L006E+1
                lda L006E
                pha
                asl L006E
                rol L006E+1
                asl L006E
                rol L006E+1
                pla
                clc
                adc L006E
                bcc LAF83
                inx

LAF83:
                clc
                adc L0064
                sta L006E
                txa
                adc L006E+1
                sta L006E+1
                ldx #$FF
                bne LAF5D

LAF91:
                txa
                php
                lda L006E
                ldx L006E+1
                plp
                rts

;-------------------------------------------------------------------------

; function table??
; Each entry is:
; +0 - name, length N
; +N - metadata byte?? with MSB set
; +N+1 - metadata byte??
; +N+2 - 1+(index into table 0)??
; If first byte of name is 0, that's the end of table marker
LAF99:      .byte '+'
                .byte $89
                .byte 8
                .byte $87
                .text "-"
                .byte $89
                .byte 8
                .byte $84
                .text "*"
                .byte $8B
                .byte $A
                .byte 5
                .text "/"
                .byte $8B       ;
                .byte $A
                .byte 6
                .text "("
                .byte $82
                .byte $71
                .byte $B
                .text "^"
                .byte $8D
                .byte $C
                .byte 8
                .text ")"
                .byte $91
                .byte $63
                .byte 3
                .text ","
                .byte $84
                .byte $62
                .byte 2
                .text "ABS"
                .byte $90
                .byte $11
                .byte $C
                .text "ACS"
                .byte $90
                .byte $11
                .byte $D
                .text "ASN"
                .byte $90
                .byte $11
                .byte $E
                .text "ATN"
                .byte $90
                .byte $11
                .byte $F
                .text "AVERAGE"
                .byte $90
                .byte $B1
                .byte $10
                .text "CHOOSE"
                .byte $90
                .byte $B1
                .byte $11
                .text "COL"
                .byte $90
                .byte $31
                .byte $12
                .text "COS"
                .byte $90
                .byte $11
                .byte $13
                .text "DEG"
                .byte $90
                .byte $11
                .byte $14
                .text "EXP"
                .byte $90
                .byte $11
                .byte $15
                .text "IF"
                .byte $90
                .byte $B1
                .byte $16
                .text "INT"
                .byte $90
                .byte $11
                .byte $17
                .text "LN"
                .byte $90
                .byte $11
                .byte $18
                .text "LOG"
                .byte $90
                .byte $11
                .byte $19
                .text "LOOKUP"
                .byte $90
                .byte $B1
                .byte $1A
                .text "MAX"
                .byte $90
                .byte $B1
                .byte $1B
                .text "MIN"
                .byte $90
                .byte $B1
                .byte $1C
                .text "PI"
                .byte $90
                .byte $31
                .byte $1D
                .text "RAD"
                .byte $90
                .byte $11
                .byte $1E
                .text "READ"
                .byte $90
                .byte $B1
                .byte $1F
                .text "ROW"
                .byte $90
                .byte $31
                .byte $20
                .text "SGN"
                .byte $90
                .byte $11
                .byte $21
                .text "SIN"
                .byte $90
                .byte $11
                .byte $22
                .text "SQR"
                .byte $90
                .byte $11
                .byte $23
                .text "TAN"
                .byte $90
                .byte $11
                .byte $24
                .text "WRITE"
                .byte $90
                .byte $B1
                .byte $25
                .byte '='
                .byte $87
                .byte 6
                .byte $26
                .text "<>"
                .byte $87
                .byte 6
                .byte $27
                .text ">="
                .byte $87
                .byte 6
                .byte $28
                .text "<="
                .byte $87
                .byte 6
                .byte $29
                .text ">"
                .byte $87
                .byte 6
                .byte $2A
                .text "<"
                .byte $87
                .byte 6
                .byte $2B
                .byte 0         ; end of table
                .byte 1
                .byte 0
                .byte 1
                .byte $E
                .byte $F
                .byte 9
                .byte $E
                .byte $6F       ; o
                .byte $A
; table of words??
LB084:      .word 10
                .word 100
                .word 1000
                .word 10000
                .byte $4D
                .byte $52
                .byte $4A
                .byte $43
                .byte 0
LB091:      .byte $44
                .byte $41
                .byte $46       ; F
                .byte 0
                .byte $4C       ; L
                .byte $20
                .byte $52       ; R
                .byte 0
                .byte $42       ; B
                .byte $10
                .byte $4D       ; M
                .byte 0
                .byte 0

;-------------------------------------------------------------------------

command: .macro
                .for ch in (\1)
                .byte ch^$5b
                .endfor
                .byte (\2)
                .endmacro
                
commands:
                .command "PROtect",$81
                .command "PRINTEr",$81
                .command "LW",$81
                .command "Load",$81
                .command "NEW",$80
                .command "NAme",$81
                .command "SW",$81
                .command "SCreen",$81
                .command "Create",$80
                .command "Headings",$81
                .command "PC",$81
                .command "Print",$81
                .command "Mode",$80
                .command "Save",$81
                .command "OFf",$80
                .command "ON",$80
                .byte 0

;-------------------------------------------------------------------------

error_strings:  .text "Brackets"
                .byte 0
error_range:    .text "Range"
                .byte 0
error_overflow: .text "Overflow"
                .byte 0
error_too_big:  .text "Too big"
                .byte 0
error_divide_by_0:.text "Divide by 0"
                .byte 0
error_negative_root:.text "-ve root"
                .byte 0
error_log_range:.text "LOG range"
                .byte 0
error_out_of_range:.text "Out of range"
                .byte 0
error_bad_file: .text "Bad file"
                .byte 0
error_too_many_files:.text "Too many files"
                .byte 0
error_no_file:  .text "No file"
                .byte 0
error_propagated:.text "Propagated"
                .byte 0
error_lookup:   .text "Lookup"
                .byte 0
error_fs_error: .text "FS error"
                .byte 0
error_too_few_arguments:.text "Too few arguments"
                .byte 0

;-------------------------------------------------------------------------

table_addrs:    .word table_0
                .word table_2
                .word table_4
                .word table_6
                .word table_8   ; apparently unused
table_8:        .word close_file; 0
                .word raise_fs_error; 1
                .word L8104      ; 2
table_0:        .word LA53A; 0
                .word LA5C8  ; 1 ; !! A8D4 in BASIC 2
                .word LA5BB  ; 2
                .word LA546  ; 3
                .word LA54C  ; 4
                .word LA552  ; 5
                .word LA540  ; 6
                .word LB2B5  ; 7
                .word negate_fwa; 8
                .word rts9B12; 9
                .word LA583   ; 10
                .word fun_abs    ; 11
                .word fun_acs    ; 12
                .word fun_asn    ; 13
                .word fun_atn    ; 14
                .word fun_average_QQ; 15
                .word fun_choose_QQ ; 16
                .word fun_col_QQ    ; 17
                .word fun_cos       ; 18
                .word fun_deg       ; 19
                .word fun_exp       ; 20
                .word fun_if_QQ     ; 21
                .word fun_int_QQ    ; 22
                .word fun_ln_QQ     ; 23
                .word fun_log_QQ    ; 24
                .word fun_lookup_QQ ; 25
                .word fun_max_QQ    ; 26
                .word fun_min_QQ    ; 27
                .word fun_pi        ; 28
                .word fun_rad_QQ    ; 29
                .word fun_read_QQ   ; 30
                .word fun_row_QQ    ; 31
                .word fun_sign_QQ   ; 32
                .word fun_sin       ; 33
                .word fun_sqr_QQ    ; 34
                .word fun_tan_QQ    ; 35
                .word fun_write_QQ  ; 36
                .word oper_eq_QQ    ; 37
                .word oper_ne_QQ    ; 38
                .word oper_ge_QQ    ; 39
                .word oper_le_QQ    ; 40
                .word oper_gt_QQ    ; 41
                .word ope_lt_QQ     ; 42
table_2:        .word L828C; 0
                .word L82E6  ; 1
                .word L830D  ; 2
                .word L838C  ; 3
                .word L8580  ; 4
                .word L83F8  ; 5
                .word L8488  ; 6
                .word L865A  ; 7
                .word L84A8  ; 8
                .word L8288  ; 9
                .word L861B  ; 10
                .word L8657  ; 11
                .word L820B  ; 12
                .word L8413  ; 13
table_4:        .word L80F3; 0
                .word L87A2  ; 1
                .word L8DB4  ; 2
                .word L89E6  ; 3
                .word L89C2  ; 4
                .word rts9B12; 5
                .word rts9B12; 6
                .word rts9B12; 7
                .word L8AD4   ; 8
                .word L8D49   ; 9
                .word rts9B12; 10
                .word rts9B12; 11
                .word rts9B12; 12
                .word L87FC   ; 13
                .word L9173   ; 14
                .word L918A   ; 15
                .word L9157   ; 16
                .word L9140   ; 17
                .word L89DD   ; 18
                .word L8B61   ; 19
                .word L8B2E   ; 20
                .word L88FC   ; 21
                .word L88E6   ; 22
                .word L89AE   ; 23
                .word L89B2   ; 24
                .word L87A2   ; 25
                .if B101
                .word rts9B12   ; 26
                .else
                .word L8AC2   ; 26
                .endif
                .word L87A8   ; 27
                .word rts9B12; 28
                .word L87CC   ; 29
                .word L90B4   ; 30
                .word L90CA   ; 31
                .word L90CE   ; 32
                .word L90B8   ; 33
                .word L88D8   ; 34
                .word L8C5A   ; 35
                .word L8CC5   ; 36
table_6:        .word LA3F5; 0
                .word LA3F8  ; 1
                .word LA3D7  ; 2
                .word LA3EB  ; 3
                .word LA3C6  ; 4
                .word LA3CB  ; 5
                .word LA427  ; 6
                .word LA413  ; 7
                .word LA39E  ; 8
                .word LA397  ; 9
                .word LA389  ; 10
                .word L9173  ; 11
                .word L918A  ; 12
                .word L9157  ; 13
                .word L9140  ; 14
                .word L90B4  ; 15
                .word L90CA  ; 16
                .word L90CE  ; 17
                .word L90B8  ; 18

;-------------------------------------------------------------------------

LB27F:
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)
                lda fwb_sign
                and #$80
                sta fwb_sign
                lda fwa_sign
                and #$80
                cmp fwb_sign
                bne rtsB2B4
                lda fwb_exponent
                cmp fwa_exponent
                bne LB2AE
                lda fwb_mantissa_1
                cmp fwa_mantissa_1
                bne LB2AE
                lda fwb_mantissa_2
                cmp fwa_mantissa_2
                bne LB2AE
                lda fwb_mantissa_3
                cmp fwa_mantissa_3
                bne LB2AE
                lda fwb_mantissa_4
                cmp fwa_mantissa_4
                beq rtsB2B4

LB2AE:
                ror a
                eor fwb_sign
                rol a
                lda #1

rtsB2B4:
                rts

;-------------------------------------------------------------------------

LB2B5:
                jsr store_fwa_fp_slot_2
                jsr LA725
                jsr store_fwa_fp_slot_3
                jsr prepare_fp_slot_2
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)
                lda fwa_exponent
                cmp #$87
                bcs LB2F7
                jsr LB967
                bne LB2D7
                jsr load_fwa_fp_slot_3
                lda L0030
                jmp LBF0B    ; !! AB12 in BASIC 2

;-------------------------------------------------------------------------

LB2D7:
                jsr store_fwa_fp_slot_2
                jsr load_fwa_fp_slot_3
                lda L0030
                jsr LBF0B    ; !! AB12 in BASIC 2

LB2E2:
                jsr store_fwa_fp_slot_1
                jsr load_fwa_fp_slot_3
                jsr fun_ln_QQ
                jsr LBE9F
                jsr fun_exp     ; !! AA91 in BASIC 2
                jsr prepare_fp_slot_1
                jmp LB7A3    ; !! A656 in BASIC 2

;-------------------------------------------------------------------------

LB2F7:
                jsr store_fwa_fp_slot_2
                jsr LBAE8
                bne LB2E2

;-------------------------------------------------------------------------

LB2FF:
                tax
                lda #0
                sta L002B
                sta L002F
                sta L0026
                sta L0027
                sta L0063
                stx L0023
                cpx #$B
                bcc LB314
                ldx #$B

LB314:
                lda L002D
                and #$10
                beq LB31D
                sta L0026
                dex

LB31D:
                stx L0024
                stx L0028
                lda L002D
                and #$F
                sta L002E
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                bne LB32F
                jmp LB3D1

;-------------------------------------------------------------------------

LB32F:
                bpl LB346
                ldx #1
                stx fwa_sign
; ?? print - or (
                lda #'-'
                ldx L0026
                beq LB33F
                inc L0026
                lda #'('

LB33F:
                dec L0024
                dec L0028
                jsr LB511

LB346:
                lda fwa_exponent
                cmp #$81
                bcs LB354    ; !! 9F25 in BASIC 2
                jsr multiply_fwa_by_10; !! A1F4 in BASIC 2
                dec L002F
                jmp LB346

;-------------------------------------------------------------------------

LB354:
                cmp #$84        ; !! 9F25 in BASIC 2
                bcc LB368
                bne LB360
                lda fwa_mantissa_1
                cmp #$A0
                bcc LB368

LB360:
                jsr divide_fwa_by_10; !! A24D in BASIC 2
                inc L002F
                jmp LB346

;-------------------------------------------------------------------------

LB368:
                bit L002D
                bvs LB398
                ldy L002F
                bpl LB383
                iny
                bmi LB3E5
                lda L0024
                cmp #3
                bcc LB3E5
                sbc #2
                ldx #1
                stx L0025
                stx L0027
                bne LB3CE

LB383:
                cpy L0024
                bcs LB3E5
                iny
                sty L0025
                cpy L0024
                bcc LB392
                lda L0024
                bcs LB3CE

LB392:
                ldx L0024
                dex
                txa
                bcc LB3CE

LB398:
                lda L002F
                bmi LB3B2
                tay
                clc
                ldx L002E
                beq LB3A3
                sec

LB3A3:
                adc L002E
                cmp L0024
                bcs LB3E5
                iny
                sty L0025
                sta L0024
                inc L0024
                bcc LB3C7

LB3B2:
                ldy L002E
                iny
                cpy L0024
                bcs LB3E5
                iny
                sty L0024
                lda #1
                sta L0025
                lda #0
                sec
                sbc L002F
                sta L0027

LB3C7:
                lda L002E
                sec
                adc L002F
                bmi LB3D1

LB3CE:
                jmp LB42B

;-------------------------------------------------------------------------

LB3D1:
                lda #1
                sta L0025
                clc
                adc L002E
                cmp L0024
                bcs LB421
                sta L0027
                sta L0024
                inc L0024
                jmp LB46F

;-------------------------------------------------------------------------

LB3E5:
                ldx L002F
                dex
                stx L0063

LB3EA:
                ldy #0
                sty L002F
                inc L0063
                ldx #2
                lda L0063
                bpl LB3FB
                inx
                sec
                tya
                sbc L0063

LB3FB:
                cmp #$A
                bcc LB400
                inx

LB400:
                stx L0064
                lda L0024
                sec
                sbc L0064
                bcc LB421
                beq LB421
                sta L0024
                bne LB41E

LB40F:
                jsr LBAE8
                lda L0028
                sta L0024
                lda L0063
                bne LB3EA
                sta L0027
                inc L002F

LB41E:
                jmp LB368

;-------------------------------------------------------------------------

LB421:
                lda #'%'
                sta L079E
                lda #1
                sta L002B
                rts

;-------------------------------------------------------------------------

LB42B:
                pha
                lda fwa_rounding
                sta L0064
                jsr store_fwa_fp_slot_0
                jsr clear_fwa
                lda #$A0
                sta fwa_mantissa_1
                lda #$83
                sta fwa_exponent
                pla
                tax
                beq LB448

LB442:
                jsr divide_fwa_by_10; !! A24D in BASIC 2
                dex
                bne LB442

LB448:
                jsr prepare_fp_slot_0
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)
                lda L0064
                sta fwb_rounding
                jsr add_fwb_to_fwa; FWA=FWA+FWB normalised and unrounded
                                  ; !! A50B in BASIC 2

LB455:
                lda fwa_exponent
                cmp #$84
                bcs LB469
                ror fwa_mantissa_1
                ror fwa_mantissa_2
                ror fwa_mantissa_3
                ror fwa_mantissa_4
                ror fwa_rounding
                inc fwa_exponent
                bne LB455

LB469:
                lda fwa_mantissa_1
                cmp #$A0
                bcs LB40F

LB46F:
                ldx L0027
                beq LB48A

LB473:
                lda #'0'
                jsr LB511
                dec L0025
                bne LB483
                lda #'.'
                jsr LB511
                dec L0024

LB483:
                dec L0024
                beq LB49E
                dex
                bne LB473

LB48A:
                jsr LB4FD
                dec L0025
                bne LB49A
                lda #'.'
                jsr LB511
                dec L0024
                beq LB49E

LB49A:
                dec L0024
                bne LB48A

LB49E:
                bit L002D
                bvc LB4A6
                lda L002E
                bne LB4B7

LB4A6:
                ldy L002B

LB4A8:
                dey
                lda L079E,y
                cmp #'0'
                beq LB4A8
                cmp #'.'
                beq LB4B5
                iny

LB4B5:
                sty L002B

LB4B7:
                lda L0063
                beq LB4D5
                lda #'E'
                jsr LB511
                lda L0063
                bpl LB4CE
                lda #'-'
                jsr LB511
                sec
                lda #0
                sbc L0063

LB4CE:
                ldx L002B
                jsr LAEAF
                stx L002B

LB4D5:
                lda L0026
                and #$10
                beq LB4E9
                ldx #' '
                lda L0026
                and #1
                beq LB4E5
                ldx #')'

LB4E5:
                txa
                jsr LB511

LB4E9:
                lda L002D
                and #$20
                bne rtsB4FC
                lda L0023
                sec
                sbc L002B
                bcc rtsB4FC
                sta L002C
                lda L0023
                sta L002B

rtsB4FC:
                rts

;-------------------------------------------------------------------------

LB4FD:
                lda fwa_mantissa_1
                lsr a
                lsr a
                lsr a
                lsr a
                jsr LB50F
                lda fwa_mantissa_1
                and #$F
                sta fwa_mantissa_1
                jmp multiply_fwa_mantissa_by_10; !! A197 in BASIC 2

;-------------------------------------------------------------------------

LB50F:
                ora #'0'

;-------------------------------------------------------------------------

LB511:
                stx L0064
                ldx L002B
                sta L079E,x
                ldx L0064
                inc L002B
                rts

;-------------------------------------------------------------------------

LB51D:
                sec
                stx fwa_rounding

;-------------------------------------------------------------------------

; A1DA in BASIC 2

compare_fwa_to_zero:
                lda fwa_mantissa_1
                ora fwa_mantissa_2
                ora fwa_mantissa_3
                ora fwa_mantissa_4
                ora fwa_rounding
                beq LB533
                lda fwa_sign
                bne rtsB539
                lda #1
                rts

;-------------------------------------------------------------------------

LB533:
                sta fwa_sign
                sta fwa_exponent
                sta fwa_overflow

rtsB539:
                rts

;-------------------------------------------------------------------------

LB53A:
                tsx
                stx S_value     ; stack pointer value

;-------------------------------------------------------------------------

LB53D:

                ldx #0
                stx fwa_mantissa_1
                stx fwa_mantissa_2
                stx fwa_mantissa_3
                stx fwa_mantissa_4
                stx fwa_rounding
                stx L002E
                stx L002F
                ldy L002A
                lda (L0000),y
                cmp #'.'
                beq LB566
                cmp #':'
                bcs LB51D
                sbc #'/'
                bmi LB51D
                sta fwa_rounding

LB55F:
                iny
                lda (L0000),y
                cmp #'.'
                bne LB56E

LB566:
                lda L002E
                bne LB5B1
                inc L002E
                bne LB55F

LB56E:
                jsr toupper
                cmp #'E'
                beq LB5AA    ; taken if E
                cmp #':'        ; '9'+1
                bcs LB5B1    ; taken if definitely not digit
                sbc #'/'
                bcc LB5B1    ; taken if not digit and not /
                ldx fwa_mantissa_1
                cpx #$18
                bcc LB58B
                ldx L002E
                bne LB55F
                inc L002F
                bcs LB55F

LB58B:
                ldx L002E
                beq LB591
                dec L002F

LB591:
                jsr multiply_fwa_mantissa_by_10; !! A197 in BASIC 2
                adc fwa_rounding
                sta fwa_rounding
                bcc LB55F
                inc fwa_mantissa_4
                bne LB55F
                inc fwa_mantissa_3
                bne LB55F
                inc fwa_mantissa_2
                bne LB55F
                inc fwa_mantissa_1
                bne LB55F

LB5AA:
                jsr LB5E7
                adc L002F
                sta L002F

LB5B1:
                sty L002A
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq LB5DE
                lda #$A8
                sta fwa_exponent
                lda #0
                sta fwa_overflow
                sta fwa_sign
                jsr normalize_fwa; !! A303 in BASIC 2
                lda L002F
                bmi LB5D4
                beq LB5DB

LB5CB:
                jsr multiply_fwa_by_10; !! A1F4 in BASIC 2
                dec L002F
                bne LB5CB
                beq LB5DB

LB5D4:
                jsr divide_fwa_by_10; !! A24D in BASIC 2
                inc L002F
                bne LB5D4

LB5DB:
                jsr LB7A9    ; !! A65C in BASIC 2

LB5DE:
                clc
                rts

;-------------------------------------------------------------------------

LB5E0:
                jsr LB5F2
                eor #$FF
                sec

rtsB5E6:
                rts

;-------------------------------------------------------------------------

LB5E7:

                iny
                lda (L0000),y
                cmp #'-'
                beq LB5E0
                cmp #'+'
                bne LB5F3

;-------------------------------------------------------------------------

LB5F2:
                iny

LB5F3:
                jsr LAF46
                sty L002A
                bcs LB5FC
                bpl rtsB5E6

LB5FC:
                jmp too_big_error_QQ

;-------------------------------------------------------------------------

; !! A178 in BASIC 2

add_fw_mantissas:
                lda fwa_rounding
                adc fwb_rounding
                sta fwa_rounding
                lda fwa_mantissa_4
                adc fwb_mantissa_4
                sta fwa_mantissa_4
                lda fwa_mantissa_3
                adc fwb_mantissa_3
                sta fwa_mantissa_3
                lda fwa_mantissa_2
                adc fwb_mantissa_2
                sta fwa_mantissa_2
                lda fwa_mantissa_1
                adc fwb_mantissa_1
                sta fwa_mantissa_1
                rts

;-------------------------------------------------------------------------

; !! A197 in BASIC 2

multiply_fwa_mantissa_by_10:
                pha
                ldx fwa_mantissa_4
                lda fwa_mantissa_1
                pha
                lda fwa_mantissa_2
                pha
                lda fwa_mantissa_3
                pha
                lda fwa_rounding
                asl a
                rol fwa_mantissa_4
                rol fwa_mantissa_3
                rol fwa_mantissa_2
                rol fwa_mantissa_1
                asl a
                rol fwa_mantissa_4
                rol fwa_mantissa_3
                rol fwa_mantissa_2
                rol fwa_mantissa_1
                adc fwa_rounding
                sta fwa_rounding
                txa
                adc fwa_mantissa_4
                sta fwa_mantissa_4
                pla
                adc fwa_mantissa_3
                sta fwa_mantissa_3
                pla
                adc fwa_mantissa_2
                sta fwa_mantissa_2
                pla
                adc fwa_mantissa_1
                asl fwa_rounding
                rol fwa_mantissa_4
                rol fwa_mantissa_3
                rol fwa_mantissa_2
                rol a
                sta fwa_mantissa_1
                pla
                rts

;-------------------------------------------------------------------------

; !! A1F4 in BASIC 2

multiply_fwa_by_10:
                clc
                lda fwa_exponent
                adc #3
                sta fwa_exponent
                bcc LB66C
                inc fwa_overflow

LB66C:
                jsr copy_fwa_to_fwb; !! A21E in BASIC 2
                jsr halve_fwb      ; !! A242 in BASIC 2
                jsr halve_fwb      ; !! A242 in BASIC 2

;-------------------------------------------------------------------------

; !! A208 in BASIC 2

LB675:
                jsr add_fw_mantissas; !! A178 in BASIC 2

LB678:
                bcc rtsB68A ; !! A20B in BASIC 2
                ror fwa_mantissa_1
                ror fwa_mantissa_2
                ror fwa_mantissa_3
                ror fwa_mantissa_4
                ror fwa_rounding
                inc fwa_exponent
                bne rtsB68A
                inc fwa_overflow

rtsB68A:
                rts

;-------------------------------------------------------------------------

; !! A21E in BASIC 2

copy_fwa_to_fwb:
                lda fwa_sign
                sta fwb_sign
                lda fwa_overflow
                sta fwb_overflow
                lda fwa_exponent
                sta fwb_exponent
                lda fwa_mantissa_1
                sta fwb_mantissa_1
                lda fwa_mantissa_2
                sta fwb_mantissa_2
                lda fwa_mantissa_3
                sta fwb_mantissa_3
                lda fwa_mantissa_4
                sta fwb_mantissa_4
                lda fwa_rounding
                sta fwb_rounding
                rts

;-------------------------------------------------------------------------

; !! A23F in BASIC 2

set_fwb_to_half_fwa:
                jsr copy_fwa_to_fwb; !! A21E in BASIC 2

;-------------------------------------------------------------------------

; !! A242 in BASIC 2

halve_fwb:
                lsr fwb_mantissa_1
                ror fwb_mantissa_2
                ror fwb_mantissa_3
                ror fwb_mantissa_4
                ror fwb_rounding
                rts

;-------------------------------------------------------------------------

; !! A24D in BASIC 2

divide_fwa_by_10:
                sec
                lda fwa_exponent
                sbc #4
                sta fwa_exponent
                bcs LB6C5
                dec fwa_overflow

LB6C5:
                jsr set_fwb_to_half_fwa; !! A23F in BASIC 2
                jsr LB675           ; !! A208 in BASIC 2
                jsr set_fwb_to_half_fwa; !! A23F in BASIC 2
                jsr halve_fwb          ; !! A242 in BASIC 2
                jsr halve_fwb          ; !! A242 in BASIC 2
                jsr halve_fwb          ; !! A242 in BASIC 2
                jsr LB675           ; !! A208 in BASIC 2
                lda #0
                sta fwb_mantissa_1
                lda fwa_mantissa_1
                sta fwb_mantissa_2
                lda fwa_mantissa_2
                sta fwb_mantissa_3
                lda fwa_mantissa_3
                sta fwb_mantissa_4
                lda fwa_mantissa_4
                sta fwb_rounding
                lda fwa_rounding
                rol a
                jsr LB675    ; !! A208 in BASIC 2
                lda #0
                sta fwb_mantissa_1
                sta fwb_mantissa_2
                lda fwa_mantissa_1
                sta fwb_mantissa_3
                lda fwa_mantissa_2
                sta fwb_mantissa_4
                lda fwa_mantissa_3
                sta fwb_rounding
                lda fwa_mantissa_4
                rol a
                jsr LB675    ; !! A208 in BASIC 2
                lda fwa_mantissa_2
                rol a
                lda fwa_mantissa_1

;-------------------------------------------------------------------------

; !! A2A4 in BASIC 2

add_A_to_fwa_mantissa:
                adc fwa_rounding
                sta fwa_rounding
                bcc rtsB730
                inc fwa_mantissa_4
                bne rtsB730
                inc fwa_mantissa_3
                bne rtsB730
                inc fwa_mantissa_2
                bne rtsB730
                inc fwa_mantissa_1
                bne rtsB730
                jmp LB678    ; !! A20B in BASIC 2

;-------------------------------------------------------------------------

LB72A:
                sta fwa_sign    ; !! A2E6 in BASIC 2
                sta fwa_exponent
                sta fwa_overflow

rtsB730:
                rts

;-------------------------------------------------------------------------

; !! A2ED in BASIC 2

LB731:
                pha
                jsr clear_fwa
                pla
                beq rtsB730
                bne LB74A

LB73A:
                pha
                jsr clear_fwa
                pla
                beq rtsB730
                bpl LB74A
                sta fwa_sign
                lda #0
                sec
                sbc fwa_sign

LB74A:
                sta fwa_mantissa_1
                lda #$88
                sta fwa_exponent

;-------------------------------------------------------------------------

; !! A303 in BASIC 2

normalize_fwa:

                lda fwa_mantissa_1
                bmi rtsB730
; if the rest of the mantissa is zero, zero the sign, under/overflow and rounding bytes, and exit
                ora fwa_mantissa_2
                ora fwa_mantissa_3
                ora fwa_mantissa_4
                ora fwa_rounding
                beq LB72A    ; !! A2E6 in BASIC 2
; rescue the exponent
                lda fwa_exponent
; exit if the number is normalized

LB760:
                ldy fwa_mantissa_1
                bmi rtsB730
; If the least significant byte of the mantissa is not zero, no byte shifts are required to
; normalise the number, so go to &A33A to carry out the bit shifts
                bne LB787
; Carry out a byte shift on MAN ft 1
                ldx fwa_mantissa_2
                stx fwa_mantissa_1
                ldx fwa_mantissa_3
                stx fwa_mantissa_2
                ldx fwa_mantissa_4
                stx fwa_mantissa_3
                ldx fwa_rounding
                stx fwa_mantissa_4
; Zero the rounding byte
                sty fwa_rounding
; Subtract eight from the exponent
                sec
                sbc #8
                sta fwa_exponent
; Return to the start of the loop, updating the underflow flag if necessary
                bcs LB760
                dec fwa_overflow
                bcc LB760
; Exit if the number is normalised

LB783:
                ldy fwa_mantissa_1
                bmi rtsB730
; Shift the mantissa left by one bit

LB787:
                asl fwa_rounding
                rol fwa_mantissa_4
                rol fwa_mantissa_3
                rol fwa_mantissa_2
                rol fwa_mantissa_1
; Decrement the accumulator (the ROL instruction at &A342 will always result in a
; clear carry flag)

                sbc #0
; Update the exponent
                sta fwa_exponent
; Return to the bit shift section, updating the underflow byte if necessary
; (one of these 2 branches will always be taken, so always go back to B783)
                bcs LB783
                dec fwa_overflow
                bcc LB783

LB79B:
                lda fwa_mantissa_4
                ora #1
                sta fwa_mantissa_4
                bne LB7B6    ; always taken

LB7A3:
                jsr LB7E8    ; !! A656 in BASIC 2

LB7A6:
                jsr normalize_fwa; !! A303 in BASIC 2

LB7A9:
                lda fwa_rounding; !! A65C in BASIC 2
                cmp #$80
                bcc LB7B6    ; !! A67C in BASIC 2
                beq LB79B
                lda #$FF
                jsr add_A_to_fwa_mantissa; !! A2A4 in BASIC 2

LB7B6:
                lda #0          ; !! A67C in BASIC 2
                sta fwa_rounding
                lda fwa_overflow
                beq rtsB7D2
                bpl too_big_error_QQ

;-------------------------------------------------------------------------

; !! A686 in BASIC 2

clear_fwa:
                lda #0
                sta fwa_sign
                sta fwa_overflow
                sta fwa_exponent
                sta fwa_mantissa_1
                sta fwa_mantissa_2
                sta fwa_mantissa_3
                sta fwa_mantissa_4
                sta fwa_rounding

rtsB7D2:
                rts

;-------------------------------------------------------------------------

inc_fwa_mantissa:
                inc fwa_mantissa_4
                bne rtsB7D2
                inc fwa_mantissa_3
                bne rtsB7D2
                inc fwa_mantissa_2
                bne rtsB7D2
                inc fwa_mantissa_1
                bne rtsB7D2

too_big_error_QQ:
                lda #error_too_big - error_strings; "Brackets"
                jmp LA585                      ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

; !! A606 in BASIC 2

LB7E8:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq rtsB7D2
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)
                bne LB7F5    ; !! A613 in BASIC 2
                jmp clear_fwa

;-------------------------------------------------------------------------

LB7F5:
                clc             ; !! A613 in BASIC 2
                lda fwa_exponent
                adc fwb_exponent
                bcc LB7FF
                inc fwa_overflow
                clc

LB7FF:
                sbc #$7F
                sta fwa_exponent
                bcs LB807
                dec fwa_overflow

LB807:
                ldx #5
                ldy #0

LB80B:
                lda fwa_exponent,x
; repurposes some ZP locations to get a 3rd mantissa
                sta fwb_rounding,x
                sty fwa_exponent,x
                dex
                bne LB80B
                lda fwa_sign
                eor fwb_sign
                sta fwa_sign
                ldy #$20

LB81C:
                lsr fwb_mantissa_1
                ror fwb_mantissa_2
                ror fwb_mantissa_3
                ror fwb_mantissa_4
                ror fwb_rounding
                asl L0044
                rol L0043
                rol L0041+1
                rol L0041
                bcc LB834
                clc
                jsr add_fw_mantissas; !! A178 in BASIC 2

LB834:
                dey
                bne LB81C
                rts

;-------------------------------------------------------------------------

; load FWB from (L0006) (equivalent to A34E in BASIC 2??)

load_fwb:
                ldy #4
                lda (L0006),y
                sta fwb_mantissa_4
                dey
                lda (L0006),y
                sta fwb_mantissa_3
                dey
                lda (L0006),y
                sta fwb_mantissa_2
                dey
                lda (L0006),y
                sta fwb_sign
                dey
                sty fwb_rounding
                sty fwb_overflow
                lda (L0006),y
                sta fwb_exponent
                ora fwb_sign
                ora fwb_mantissa_2
                ora fwb_mantissa_3
                ora fwb_mantissa_4
                beq LB864
                lda fwb_sign
                ora #$80

LB864:
                sta fwb_mantissa_1
                rts

;-------------------------------------------------------------------------

store_fwa_fp_slot_3:
                lda #$93
                bne store_fwa_fp_slot

store_fwa_fp_slot_1:
                lda #$89
                bne store_fwa_fp_slot

store_fwa_fp_slot_2:
                lda #$8E
                bne store_fwa_fp_slot

;-------------------------------------------------------------------------

store_fwa_fp_slot_0:
                lda #<fp_slot_0

store_fwa_fp_slot:
                sta L0006
                lda #>fp_slot_0
                sta L0006+1
; !! BD59 in BASIC 2

store_fwa:
                ldy #0          ; store FWA to (L0006)
                lda fwa_exponent
                sta (L0006),y
                iny
                lda fwa_sign
                and #$80
                sta fwa_sign
                lda fwa_mantissa_1
                and #$7F
                ora fwa_sign
                sta (L0006),y
                lda fwa_mantissa_2
                iny
                sta (L0006),y
                lda fwa_mantissa_3
                iny
                sta (L0006),y
                lda fwa_mantissa_4
                iny
                sta (L0006),y
                rts

;-------------------------------------------------------------------------

prepare_fp_slot_3:
                lda #<fp_slot_3
                bne prepare_fp_slot_addr

prepare_fp_slot_1:
                lda #<fp_slot_1
                bne prepare_fp_slot_addr

prepare_fp_slot_2:
                lda #<fp_slot_2
                bne prepare_fp_slot_addr

;-------------------------------------------------------------------------

prepare_fp_slot_0:
                lda #<fp_slot_0

prepare_fp_slot_addr:
                sta L0006
                lda #6
                sta L0006+1
                rts

;-------------------------------------------------------------------------

load_fwa_fp_slot_3:
                jsr prepare_fp_slot_3
                bne load_fwa    ; always taken

load_fwa_fp_slot_0:
                jsr prepare_fp_slot_0

;-------------------------------------------------------------------------

; load FWA from (L0006)

load_fwa:
                ldy #4
                lda (L0006),y
                sta fwa_mantissa_4
                dey
                lda (L0006),y
                sta fwa_mantissa_3
                dey
                lda (L0006),y
                sta fwa_mantissa_2
                dey
                lda (L0006),y
                sta fwa_sign
                dey
                lda (L0006),y
                sta fwa_exponent
                sty fwa_rounding
                sty fwa_overflow
                ora fwa_sign
                ora fwa_mantissa_2
                ora fwa_mantissa_3
                ora fwa_mantissa_4
                beq LB8E9
                lda fwa_sign
                ora #$80

LB8E9:
                sta fwa_mantissa_1
                rts

;-------------------------------------------------------------------------

LB8EC:
                jsr copy_fwa_to_fwb; !! A21E in BASIC 2
                jmp clear_fwa

;-------------------------------------------------------------------------

; convert FWA to int. Result is in FWA mantissa.
; !! A3FE in BASIC 2

convert_fwa_to_integer:

                lda fwa_exponent
                bpl LB8EC
                jsr fwb_clear   ; Clear FWB
                                ; !! A453 in BASIC 2
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                bne LB930
                beq LB949

LB900:
                lda fwa_exponent
                cmp #$A0
                bcs LB947
                cmp #$99
                bcs LB930
                adc #8
                sta fwa_exponent
; shift both FW mantissas right 8 bits
                lda fwb_mantissa_3
                sta fwb_mantissa_4
                lda fwb_mantissa_2
                sta fwb_mantissa_3
                lda fwb_mantissa_1
                sta fwb_mantissa_2
                lda fwa_mantissa_4
                sta fwb_mantissa_1
                lda fwa_mantissa_3
                sta fwa_mantissa_4
                lda fwa_mantissa_2
                sta fwa_mantissa_3
                lda fwa_mantissa_1
                sta fwa_mantissa_2
                lda #0
                sta fwa_mantissa_1
                beq LB900
; shift both FW mantissas right 1 bit

LB930:
                lsr fwa_mantissa_1
                ror fwa_mantissa_2
                ror fwa_mantissa_3
                ror fwa_mantissa_4
                ror fwb_mantissa_1
                ror fwb_mantissa_2
                ror fwb_mantissa_3
                ror fwb_mantissa_4
                inc fwa_exponent
                bne LB900

LB944:
                jmp too_big_error_QQ

;-------------------------------------------------------------------------

LB947:
                bne LB944

LB949:
                lda fwa_sign
                bpl rtsB966

LB94D:
                sec
                lda #0
                sbc fwa_mantissa_4
                sta fwa_mantissa_4
                lda #0
                sbc fwa_mantissa_3
                sta fwa_mantissa_3
                lda #0
                sbc fwa_mantissa_2
                sta fwa_mantissa_2
                lda #0
                sbc fwa_mantissa_1
                sta fwa_mantissa_1

rtsB966:
                rts

;-------------------------------------------------------------------------

LB967:
                lda fwa_exponent
                bmi LB972
                lda #0
                sta L0030
                jmp compare_fwa_to_zero; A1DA in BASIC 2

;-------------------------------------------------------------------------

LB972:
                jsr convert_fwa_to_integer; convert FWA to int. Result is in FWA mantissa.
                                          ; !! A3FE in BASIC 2
                lda fwa_mantissa_4
                sta L0030
                jsr copy_fwb_mantissa_to_fwa_mantissa; !! A4E8 in BASIC 2
                lda #$80
                sta fwa_exponent
                ldx fwa_mantissa_1
                bpl LB994
                eor fwa_sign
                sta fwa_sign
                bpl LB98F
                inc L0030
                jmp LB991

;-------------------------------------------------------------------------

LB98F:
                dec L0030

LB991:
                jsr LB94D

LB994:
                jmp normalize_fwa; !! A303 in BASIC 2

;-------------------------------------------------------------------------

; unused code??
                
                .if !B101
                jsr LB94D
                jsr inc_fwa_mantissa
                jmp LB94D
                .endif

;-------------------------------------------------------------------------

; Clear FWB
; !! A453 in BASIC 2

fwb_clear:
                lda #0
                sta fwb_sign
                sta fwb_overflow
                sta fwb_exponent
                sta fwb_mantissa_1
                sta fwb_mantissa_2
                sta fwb_mantissa_3
                sta fwb_mantissa_4
                sta fwb_rounding
                rts

;-------------------------------------------------------------------------

LB9B3:
                jsr LB9E0
                jmp negate_fwa  ; !! AD7E in BASIC 2

;-------------------------------------------------------------------------

LB9B9:
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)
                jsr store_fwa   ; store FWA to (L0006)

;-------------------------------------------------------------------------

; !! A4DC in BASIC 2

copy_fwb_to_fwa:
                lda fwb_sign
                sta fwa_sign
                lda fwb_overflow
                sta fwa_overflow
                lda fwb_exponent
                sta fwa_exponent

copy_fwb_mantissa_to_fwa_mantissa:
                lda fwb_mantissa_1; !! A4E8 in BASIC 2
                sta fwa_mantissa_1
                lda fwb_mantissa_2
                sta fwa_mantissa_2
                lda fwb_mantissa_3
                sta fwa_mantissa_3
                lda fwb_mantissa_4
                sta fwa_mantissa_4
                lda fwb_rounding
                sta fwa_rounding

rtsB9DF:
                rts

;-------------------------------------------------------------------------

LB9E0:
                jsr negate_fwa  ; !! AD7E in BASIC 2

;-------------------------------------------------------------------------

; !! A500 in BASIC 2

add_loaded_fwb_to_fwa:
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)
                beq rtsB9DF

LB9E8:
                jsr add_fwb_to_fwa; ?? A385 in BASIC 2
                jmp LB7A9      ; !! A65C in BASIC 2

;-------------------------------------------------------------------------

; FWA=FWA+FWB normalised and unrounded
; !! A50B in BASIC 2

add_fwb_to_fwa:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq copy_fwb_to_fwa    ; !! A4DC in BASIC 2
                ldy #0
                sec
                lda fwa_exponent
                sbc fwb_exponent
                beq LBA73
                bcc LBA35
                cmp #$25
                bcs rtsB9DF
                pha
                and #$38
                beq LBA20
                lsr a
                lsr a
                lsr a
                tax

LBA0B:
                lda fwb_mantissa_4
                sta fwb_rounding
                lda fwb_mantissa_3
                sta fwb_mantissa_4
                lda fwb_mantissa_2
                sta fwb_mantissa_3
                lda fwb_mantissa_1
                sta fwb_mantissa_2
                sty fwb_mantissa_1
                dex
                bne LBA0B

LBA20:
                pla
                and #7
                beq LBA73
                tax

LBA26:
                lsr fwb_mantissa_1
                ror fwb_mantissa_2
                ror fwb_mantissa_3
                ror fwb_mantissa_4
                ror fwb_rounding
                dex
                bne LBA26
                beq LBA73

LBA35:
                sec
                lda fwb_exponent
                sbc fwa_exponent
                cmp #$25
                bcs copy_fwb_to_fwa; !! A4DC in BASIC 2
                pha
                and #$38
                beq LBA5C
                lsr a
                lsr a
                lsr a
                tax

LBA47:
                lda fwa_mantissa_4
                sta fwa_rounding
                lda fwa_mantissa_3
                sta fwa_mantissa_4
                lda fwa_mantissa_2
                sta fwa_mantissa_3
                lda fwa_mantissa_1
                sta fwa_mantissa_2
                sty fwa_mantissa_1
                dex
                bne LBA47

LBA5C:
                pla
                and #7
                beq LBA6F
                tax

LBA62:
                lsr fwa_mantissa_1
                ror fwa_mantissa_2
                ror fwa_mantissa_3
                ror fwa_mantissa_4
                ror fwa_rounding
                dex
                bne LBA62

LBA6F:
                lda fwb_exponent
                sta fwa_exponent

LBA73:
                lda fwa_sign
                eor fwb_sign
                bpl LBAC2
                lda fwa_mantissa_1
                cmp fwb_mantissa_1
                bne LBA9A
                lda fwa_mantissa_2
                cmp fwb_mantissa_2
                bne LBA9A
                lda fwa_mantissa_3
                cmp fwb_mantissa_3
                bne LBA9A
                lda fwa_mantissa_4
                cmp fwb_mantissa_4
                bne LBA9A
                lda fwa_rounding
                cmp fwb_rounding
                bne LBA9A
                jmp clear_fwa

;-------------------------------------------------------------------------

LBA9A:
                bcs LBAC6
                sec
                lda fwb_rounding
                sbc fwa_rounding
                sta fwa_rounding
                lda fwb_mantissa_4
                sbc fwa_mantissa_4
                sta fwa_mantissa_4
                lda fwb_mantissa_3
                sbc fwa_mantissa_3
                sta fwa_mantissa_3
                lda fwb_mantissa_2
                sbc fwa_mantissa_2
                sta fwa_mantissa_2
                lda fwb_mantissa_1
                sbc fwa_mantissa_1
                sta fwa_mantissa_1
                lda fwb_sign
                sta fwa_sign
                jmp normalize_fwa; !! A303 in BASIC 2

;-------------------------------------------------------------------------

LBAC2:
                clc
                jmp LB675    ; !! A208 in BASIC 2

;-------------------------------------------------------------------------

LBAC6:
                sec
                lda fwa_rounding
                sbc fwb_rounding
                sta fwa_rounding
                lda fwa_mantissa_4
                sbc fwb_mantissa_4
                sta fwa_mantissa_4
                lda fwa_mantissa_3
                sbc fwb_mantissa_3
                sta fwa_mantissa_3
                lda fwa_mantissa_2
                sbc fwb_mantissa_2
                sta fwa_mantissa_2
                lda fwa_mantissa_1
                sbc fwb_mantissa_1
                sta fwa_mantissa_1

LBAE5:
                jmp normalize_fwa; !! A303 in BASIC 2

;-------------------------------------------------------------------------

LBAE8:
                jsr clear_fwa
                ldy #$80
                sty fwa_mantissa_1
                iny
                sty fwa_exponent
                tya
                rts

;-------------------------------------------------------------------------

fun_int_QQ:
                jsr convert_fwa_to_integer; convert FWA to int. Result is in FWA mantissa.
                                          ; !! A3FE in BASIC 2
                ldx #0
                stx fwa_rounding
                stx fwa_overflow
                lda fwa_mantissa_1
                bpl LBB06
                jsr LB94D
                ldx #$FF

LBB06:
                stx fwa_sign
                lda #$A0
                sta fwa_exponent
                bne LBAE5

;-------------------------------------------------------------------------

LBB0E:
                jsr store_fwa_fp_slot_0
                jsr LBAE8
                bne LBB29    ; ?? AA55 in BASIC 2

;-------------------------------------------------------------------------

LBB16:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq LBB24
                jsr copy_fwa_to_fwb; !! A21E in BASIC 2
                jsr load_fwa       ; copy 5 bytes from (L0006) to zp
                                   ; (presumably be a BASIC-style FP value)
                bne LBB33

rtsBB23:
                rts

;-------------------------------------------------------------------------

LBB24:
                lda #error_divide_by_0 - error_strings; "Brackets"
                jmp LA585                          ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

; ?? AA55 in BASIC 2

LBB29:

                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq rtsBB23
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)
                beq LBB24

LBB33:
                lda fwa_sign
                eor fwb_sign
                sta fwa_sign
                sec
                lda fwa_exponent
                sbc fwb_exponent
                bcs LBB43
                dec fwa_overflow
                sec

LBB43:
                adc #$80
                sta fwa_exponent
                bcc LBB4C
                inc fwa_overflow
                clc

LBB4C:
                ldx #$20

LBB4E:
                bcs LBB68
                lda fwa_mantissa_1
                cmp fwb_mantissa_1
                bne LBB66
                lda fwa_mantissa_2
                cmp fwb_mantissa_2
                bne LBB66
                lda fwa_mantissa_3
                cmp fwb_mantissa_3
                bne LBB66
                lda fwa_mantissa_4
                cmp fwb_mantissa_4

LBB66:
                bcc LBB81

LBB68:
                lda fwa_mantissa_4
                sbc fwb_mantissa_4
                sta fwa_mantissa_4
                lda fwa_mantissa_3
                sbc fwb_mantissa_3
                sta fwa_mantissa_3
                lda fwa_mantissa_2
                sbc fwb_mantissa_2
                sta fwa_mantissa_2
                lda fwa_mantissa_1
                sbc fwb_mantissa_1
                sta fwa_mantissa_1
                sec

LBB81:
                rol L0044
                rol L0043
                rol L0041+1
                rol L0041
                asl fwa_mantissa_4
                rol fwa_mantissa_3
                rol fwa_mantissa_2
                rol fwa_mantissa_1
                dex
                bne LBB4E
                ldx #7

LBB96:
                bcs LBBB0
                lda fwa_mantissa_1
                cmp fwb_mantissa_1
                bne LBBAE
                lda fwa_mantissa_2
                cmp fwb_mantissa_2
                bne LBBAE
                lda fwa_mantissa_3
                cmp fwb_mantissa_3
                bne LBBAE
                lda fwa_mantissa_4
                cmp fwb_mantissa_4

LBBAE:
                bcc LBBC9

LBBB0:
                lda fwa_mantissa_4
                sbc fwb_mantissa_4
                sta fwa_mantissa_4
                lda fwa_mantissa_3
                sbc fwb_mantissa_3
                sta fwa_mantissa_3
                lda fwa_mantissa_2
                sbc fwb_mantissa_2
                sta fwa_mantissa_2
                lda fwa_mantissa_1
                sbc fwb_mantissa_1
                sta fwa_mantissa_1
                sec

LBBC9:
                rol fwa_rounding
                asl fwa_mantissa_4
                rol fwa_mantissa_3
                rol fwa_mantissa_2
                rol fwa_mantissa_1
                dex
                bne LBB96
                asl fwa_rounding
                lda L0044
                sta fwa_mantissa_4
                lda L0043
                sta fwa_mantissa_3
                lda L0041+1
                sta fwa_mantissa_2
                lda L0041
                sta fwa_mantissa_1
                jmp LB7A6

;-------------------------------------------------------------------------

fun_tan_QQ:
                jsr FRANGE      ; !! A9D3 in BASIC 2
                lda L0030
                pha
                jsr store_fwa_fp_slot_3
                inc L0030
                jsr LBDBF    ; !! A99E in BASIC 2
                jsr prepare_fp_slot_3
                jsr LB9B9
                pla
                sta L0030
                jsr LBDBF    ; !! A99E in BASIC 2
                jsr prepare_fp_slot_3
                jmp LBB29    ; ?? AA55 in BASIC 2

;-------------------------------------------------------------------------

fun_sqr_QQ:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq rtsBC3A
                bmi LBC3B
                jsr store_fwa_fp_slot_0
                lda fwa_exponent
                lsr a
                adc #$40
                sta fwa_exponent
                lda #5
                sta L0030
                jsr prepare_fp_slot_1

LBC23:
                jsr store_fwa   ; store FWA to (L0006)
                lda #<fp_slot_0
                sta L0006
                jsr LBB16
                lda #<fp_slot_1
                sta L0006
                jsr add_loaded_fwb_to_fwa; !! A500 in BASIC 2
                dec fwa_exponent
                dec L0030
                bne LBC23

rtsBC3A:
                rts

;-------------------------------------------------------------------------

LBC3B:
                lda #error_negative_root - error_strings; "Brackets"

LBC3D:
                jmp LA585    ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

fun_ln_QQ:

                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq LBC47
                bpl LBC4B

LBC47:
                lda #error_log_range - error_strings; ?? Log range
                bne LBC3D

LBC4B:
                jsr fwb_clear   ; Clear FWB
                                ; !! A453 in BASIC 2
                ldy #$80
                sty fwb_sign
                sty fwb_mantissa_1
                iny
                sty fwb_exponent
                ldx fwa_exponent
                beq LBC61
                lda fwa_mantissa_1
                cmp #$B5
                bcc LBC63

LBC61:
                inx
                dey

LBC63:
                txa
                pha
                sty fwa_exponent
                jsr LB9E8    ; ?? A385 in BASIC 2
                lda #<fp_slot_3
                jsr store_fwa_fp_slot
                lda #<LBCA7
                ldy #>LBCA7
                jsr LBCCA    ; evaluate series table
                                ; !! A897 in BASIC 2
                jsr prepare_fp_slot_3
                jsr LB7A3    ; !! A656 in BASIC 2
                jsr LB7A3    ; !! A656 in BASIC 2
                jsr add_loaded_fwb_to_fwa; !! A500 in BASIC 2
                jsr store_fwa_fp_slot_0
                pla
                sec
                sbc #$81
                jsr LB73A
                lda #<LOGTWO
                sta L0006
                lda #>LOGTWO
                sta L0006+1
                jsr LB7A3    ; !! A656 in BASIC 2
                jsr prepare_fp_slot_0
                jmp add_loaded_fwb_to_fwa; !! A500 in BASIC 2

;-------------------------------------------------------------------------

RPLN10:         .byte $7F, $5E, $5B,$D8,$AA; 0 ; 4.342944820E-1
LOGTWO:         .byte $80, $31, $72, $17,$F8; 0 ; 6.931471806E-1
LBCA7:          .byte 6; LN table (BMC p423)
                .byte $7A, $12, $38,$A5, $B; 0 ; 8.92463796E-3
                .byte $88, $79, $E, $9F,$F3; 0 ; 249.057128
                .byte $7C, $2A,$AC, $3F,$B5; 0 ; 4.16681756E-2
                .byte $86, $34, 1,$A2, $7A ; 0 ; 45.0015964
                .byte $7F, $63, $8E, $37,$EC; 0 ; 0.444444416
                .byte $82, $3F,$FF,$FF,$C1  ; 0 ; 2.99999994
                .byte $7F,$FF,$FF,$FF       ; 0 ; 0.4999999999 - or near enough...?!

;-------------------------------------------------------------------------

; evaluate series table
; !! A897 in BASIC 2

LBCCA:
                sta L006E
                sty L006E+1
                jsr store_fwa_fp_slot_0
                ldy #0
                lda (L006E),y
                sta L002E
                inc L006E
                bne LBCDD
                inc L006E+1

LBCDD:
                lda L006E
                sta L0006
                lda L006E+1
                sta L0006+1
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)

LBCE8:
                jsr prepare_fp_slot_0
                jsr LBB16
                clc
                lda L006E
                adc #5
                sta L006E
                sta L0006
                lda L006E+1
                adc #0
                sta L006E+1
                sta L0006+1
                jsr add_loaded_fwb_to_fwa; !! A500 in BASIC 2
                dec L002E
                bne LBCE8
                rts

;-------------------------------------------------------------------------

fun_acs:
                jsr fun_asn     ; !! A8D4 in BASIC 2
                jmp LBD51

;-------------------------------------------------------------------------

fun_asn:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                bpl LBD1A
                lsr fwa_sign
                jsr LBD1A
                jmp LBD40

;-------------------------------------------------------------------------

LBD1A:
                jsr store_fwa_fp_slot_2
                jsr LBDD2
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq LBD2E
                jsr prepare_fp_slot_2
                jsr LBB16
                jmp fun_atn

;-------------------------------------------------------------------------

LBD2E:
                jsr ARGHPI
                jmp load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)

;-------------------------------------------------------------------------

fun_atn:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq rtsBD44
                bpl LBD45    ; !! A91B in BASIC 2
                lsr fwa_sign
                jsr LBD45    ; !! A91B in BASIC 2

LBD40:
                lda #$80
                sta fwa_sign

rtsBD44:
                rts

;-------------------------------------------------------------------------

; !! A91B in BASIC 2

LBD45:
                lda fwa_exponent
                cmp #$81
                bcc LBD60
                jsr LBB0E
                jsr LBD60

LBD51:
                jsr LBE5C    ; !! AA48 in BASIC 2
                jsr add_loaded_fwb_to_fwa; !! A500 in BASIC 2
                jsr LBE60             ; !! AA4C in BASIC 2
                jsr add_loaded_fwb_to_fwa; !! A500 in BASIC 2
                jmp negate_fwa           ; !! AD7E in BASIC 2

;-------------------------------------------------------------------------

LBD60:
                lda fwa_exponent
                cmp #$73
                bcc rtsBD44
                jsr store_fwa_fp_slot_2
                jsr fwb_clear   ; Clear FWB
                                ; !! A453 in BASIC 2
                lda #$80
                sta fwb_exponent
                sta fwb_mantissa_1
                sta fwb_sign
                jsr LB9E8    ; ?? A385 in BASIC 2
                lda #<LBD81
                ldy #>LBD81
                jsr LBCCA    ; evaluate series table
                                ; !! A897 in BASIC 2
                jmp LBE9F

;-------------------------------------------------------------------------

LBD81:          .byte 9; ATN table (BMC p429)
                .byte $85,$A3, $59,$E8, $67; 0 ; -20.4189003
                .byte $80, $1C, $9D, 7, $36; 0 ; 0.6117710597
                .byte $80, $57,$BB, $78,$DF; 0 ; 0.842704348
                .byte $80,$CA, $9A, $E, $83; 0 ; -0.7914132185
                .byte $84, $8C,$BB,$CA, $6E; 0 ; -8.795847349
                .byte $81, $95, $96, 6,$DE ; 0 ; -1.168640955
                .byte $81, $A,$C7, $6C, $52; 0 ; 1.084210911
                .byte $7F, $7D,$AD, $90,$A1; 0 ; 0.4954648205
                .byte $82,$FB, $62, $57, $2F; 0 ; -3.927877231
                .byte $80, $6D, $63, $38, $2C; 0 ; 0.9272952182

;-------------------------------------------------------------------------

fun_cos:
                jsr FRANGE      ; !! A9D3 in BASIC 2
                inc L0030
                jmp LBDBF    ; !! A99E in BASIC 2

;-------------------------------------------------------------------------

fun_sin:
                jsr FRANGE      ; !! A9D3 in BASIC 2

;-------------------------------------------------------------------------

; !! A99E in BASIC 2

LBDBF:
                lda L0030
                and #2
                beq LBDCB
                jsr LBDCB
                jmp negate_fwa  ; !! AD7E in BASIC 2

;-------------------------------------------------------------------------

LBDCB:

                lsr L0030
                bcc LBDE4
                jsr LBDE4

LBDD2:
                jsr store_fwa_fp_slot_0
                jsr LB7A3    ; !! A656 in BASIC 2
                jsr store_fwa   ; store FWA to (L0006)
                jsr LBAE8
                jsr LB9B3
                jmp fun_sqr_QQ

;-------------------------------------------------------------------------

LBDE4:
                jsr store_fwa_fp_slot_2
                jsr LB7A3    ; !! A656 in BASIC 2
                lda #<LBEBE
                ldy #>LBEBE
                jsr LBCCA    ; evaluate series table
                                ; !! A897 in BASIC 2
                jmp LBE9F

;-------------------------------------------------------------------------

; !! A9D3 in BASIC 2

FRANGE:
                lda fwa_exponent
                cmp #$98
                bcs LBE59
                jsr store_fwa_fp_slot_0
                jsr ARGHPI
                jsr load_fwb    ; load FWB from (L0006) (equivalent to A34E in BASIC 2??)
                lda fwa_sign
                sta fwb_sign
                dec fwb_exponent
                jsr LB9E8    ; ?? A385 in BASIC 2
                jsr LBB29    ; ?? AA55 in BASIC 2
                jsr convert_fwa_to_integer; convert FWA to int. Result is in FWA mantissa.
                                          ; !! A3FE in BASIC 2
                lda fwa_mantissa_4
                sta L0030
                ora fwa_mantissa_3
                ora fwa_mantissa_2
                ora fwa_mantissa_1
                beq LBE56
                lda #$A0
                sta fwa_exponent
                ldy #0
                sty fwa_rounding
                lda fwa_mantissa_1
                sta fwa_sign
                bpl LBE2F
                jsr LB94D

LBE2F:
                jsr normalize_fwa; !! A303 in BASIC 2
                jsr store_fwa_fp_slot_1
                jsr LBE5C    ; !! AA48 in BASIC 2
                jsr LB7A3    ; !! A656 in BASIC 2
                jsr prepare_fp_slot_0
                jsr add_loaded_fwb_to_fwa; !! A500 in BASIC 2
                jsr store_fwa            ; store FWA to (L0006)
                jsr prepare_fp_slot_1
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)
                jsr LBE60    ; !! AA4C in BASIC 2
                jsr LB7A3    ; !! A656 in BASIC 2
                jsr prepare_fp_slot_0
                jmp add_loaded_fwb_to_fwa; !! A500 in BASIC 2

;-------------------------------------------------------------------------

LBE56:
                jmp load_fwa_fp_slot_0

;-------------------------------------------------------------------------

LBE59:
                jmp too_big_error_QQ

;-------------------------------------------------------------------------

; !! AA48 in BASIC 2

LBE5C:
                lda #<HPIHI
                bne LBE62

;-------------------------------------------------------------------------

; !! AA4C in BASIC 2

LBE60:
                lda #<HPILO

LBE62:
                sta L0006
                lda #>fp_constants
                sta L0006+1
                rts

;-------------------------------------------------------------------------

ARGHPI:
                lda #<HALFPI
                bne LBE62

;-------------------------------------------------------------------------

; !! AA91 in BASIC 2

fun_exp:

                lda fwa_exponent
                cmp #$87
                bcc LBE82
                bne LBE7B
                ldy fwa_mantissa_1
                cpy #$B3
                bcc LBE82

LBE7B:
                lda fwa_sign
                bpl LBE59
                jmp clear_fwa

;-------------------------------------------------------------------------

LBE82:
                jsr LB967
                lda #<LBEE2
                ldy #>LBEE2
                jsr LBCCA    ; evaluate series table
                                ; !! A897 in BASIC 2
                jsr store_fwa_fp_slot_2
                lda #<FNUME
                sta L0006
                lda #>FNUME
                sta L0006+1
                jsr load_fwa    ; copy 5 bytes from (L0006) to zp
                                ; (presumably be a BASIC-style FP value)
                lda L0030
                jsr LBF0B    ; !! AB12 in BASIC 2

;-------------------------------------------------------------------------

LBE9F:
                jsr prepare_fp_slot_2
                jmp LB7A3    ; !! A656 in BASIC 2

;-------------------------------------------------------------------------

; FP constants. All must share address MSB
                .page
fp_constants:
HPIHI:          .byte $81,$C9, $10, 0, 0; 0 ; -1.570800781E0
HPILO:          .byte $6F, $15, $77, $7A, $61; 0 ; 4.454455111E-6
HALFPI:         .byte $81, $49, $F,$DA,$A2; 0 ; 1.570796327E0
FPID18:         .byte $7B, $E,$FA, $35, $12; 0 ; 1.745329252E-2
F180DP:         .byte $86, $65, $2E,$E0,$D3; 0 ; 5.729577951E1
LBEBE:          .byte 5; SIN/COS table (BMC p436)
                .byte $84, $8A,$EA, $C, $1B; 0 ; -8.68214045
                .byte $84, $1A,$BE,$BB, $2B; 0 ; 9.67156522
                .byte $84, $37, $45, $55,$AB; 0 ; 11.4544274
                .byte $82,$D5, $55, $57, $7C; 0 ; -3.33333385
                .byte $83,$C0, 0, 0, 5      ; 0 ; -6.00000001
                .byte $81, 0, 0, 0, 0       ; 0 ; 1
FNUME:          .byte $82, $2D,$F8, $54, $58; 0 ; 2.718281828E0
                .endpage
                
LBEE2:          .byte 7; EXP series table (BMC p438)
                .byte $83,$E0, $20, $86, $5B; 0 ; -7.003970316
                .byte $82, $80, $53, $93,$B8; 0 ; -2.005101137
                .byte $83, $20, 0, 6,$A1    ; 0 ; 5.000003161
                .byte $82, 0, 0, $21, $63   ; 0 ; 2.00000796
                .byte $82,$C0, 0, 0, 2      ; 0 ; -3.000000002
                .byte $82, $80, 0, 0, $C    ; 0 ; -2.000000011
                .byte $81, 0, 0, 0, 0       ; 0 ; 1
                .byte $81, 0, 0, 0, 0       ; 0 ; 1
                
;-------------------------------------------------------------------------

; !! AB12 in BASIC 2

LBF0B:
                tax
                bpl LBF17
                dex
                txa
                eor #$FF
                pha
                jsr LBB0E
                pla

LBF17:
                pha
                jsr store_fwa_fp_slot_0
                jsr LBAE8

LBF1E:
                pla
                beq rtsBF4A
                sec
                sbc #1
                pha
                jsr LB7A3    ; !! A656 in BASIC 2
                jmp LBF1E

;-------------------------------------------------------------------------

fun_log_QQ:
                jsr fun_ln_QQ
                ldy #<RPLN10
                lda #>RPLN10
                bne LBF38

fun_rad_QQ:
                ldy #<FPID18
                lda #>FPID18

LBF38:
                sty L0006
                sta L0006+1
                jmp LB7A3    ; !! A656 in BASIC 2

;-------------------------------------------------------------------------

fun_deg:
                ldy #<F180DP
                lda #>F180DP
                bne LBF38

fun_pi:
                jsr LBD2E    ; !! ABC2 in BASIC 2
                inc fwa_exponent

rtsBF4A:
                rts

;-------------------------------------------------------------------------

fun_abs:
                jsr compare_fwa_to_zero; !! AD77 in BASIC 2
                bpl rtsBF5D
                bmi toggle_fwa_sign

;-------------------------------------------------------------------------

; !! AD7E in BASIC 2

negate_fwa:
                jsr compare_fwa_to_zero; A1DA in BASIC 2
                beq rtsBF5D

toggle_fwa_sign:
                lda fwa_sign
                eor #$80
                sta fwa_sign

rtsBF5D:
                rts

;-------------------------------------------------------------------------

LBF5E:
                lda #5
                jsr LBFDD
                lda #1
                sta (L0002),y
                iny
                lda L0066
                sta (L0002),y
                iny
                lda L0066+1
                sta (L0002),y
                iny
                lda L0066+2
                sta (L0002),y
                iny
                lda L0066+3
                sta (L0002),y
                rts

;-------------------------------------------------------------------------

LBF7C:
                lda #6
                jsr LBFDD
                tya
                sta (L0002),y
                iny
                lda fwa_exponent
                sta (L0002),y
                iny
                lda fwa_sign
                and #$80
                sta fwa_sign
                lda fwa_mantissa_1
                and #$7F
                ora fwa_sign
                sta (L0002),y
                iny
                lda fwa_mantissa_2
                sta (L0002),y
                iny
                lda fwa_mantissa_3
                sta (L0002),y
                iny
                lda fwa_mantissa_4
                sta (L0002),y
                rts

;-------------------------------------------------------------------------

LBFA8:
                lda #5
                sta L0064
                ldy #0
                lda (L0002),y
                sta L0060
                beq LBFB6
                dec L0064

LBFB6:
                inc L0002
                bne LBFBC
                inc L0003

LBFBC:
                lda L0002
                clc
                sta L0006
                adc L0064
                sta L0002
                tax
                lda L0003
                sta L0006+1
                adc #0
                sta L0003
                cmp HIMEM+1
                bcc rtsBFFA
                bne LBFDA
                cpx HIMEM
                bcc rtsBFFA
                beq rtsBFFA

LBFDA:
                jmp LA57F

;-------------------------------------------------------------------------

LBFDD:
                sta L0064
                lda L0002
                sec
                sbc L0064
                sta L0002
                bcs LBFEA
                dec L0003

LBFEA:
                ldy L0003
                cpy L0005
                bcc LBFFB
                bne LBFF8
                cmp L0004
                beq LBFFB
                bcc LBFFB

LBFF8:
                ldy #0

rtsBFFA:
                rts

;-------------------------------------------------------------------------

LBFFB:
                lda #error_overflow - error_strings; "Brackets"
                jmp LA585                       ; ??longjmp kind of thing back to main loop with A=error code

;-------------------------------------------------------------------------

                .if B101
                .fill $c000-*,$ff
                .endif

;-------------------------------------------------------------------------

OSFIND=$ffce
OSBPUT=$ffd4
OSBGET=$ffd7
OSARGS=$ffda
OSFILE=$ffdd
OSRDCH=$ffe0
OSASCI=$ffe3
OSNEWL=$ffe7
OSWRCH=$ffee
OSWORD=$fff1
OSBYTE=$fff4
OSCLI=$fff7
